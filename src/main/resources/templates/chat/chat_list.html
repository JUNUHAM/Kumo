<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>KUMO - 채팅</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/chat_list.css}">
</head>

<body>

    <div class="mobile-container">
        <div class="chat-header"
            style="position: relative; display: flex; justify-content: space-between; align-items: center;">

            <i class="fa-solid fa-map-location-dot header-icon" id="mapIcon" style="cursor: pointer;"></i>

            <img th:src="@{/images/chatLogo.png}" class="header-logo" alt="KUMO"
                style="position: absolute; left: 50%; transform: translateX(-50%);">

            <i class="fa-solid fa-magnifying-glass header-icon" id="searchIcon" style="cursor: pointer;"></i>

        </div>

        <div id="searchBar" class="search-container">
            <input type="text" id="searchInput" placeholder="상대방 이름으로 검색..." autocomplete="off">
        </div>

        <div class="tab-menu">
            <div style="display: flex; gap: 15px; align-items: center;">
                <button class="tab-btn active">전체</button>
                <button class="tab-btn">읽지않음</button>
                <button class="tab-btn">읽음</button>
            </div>
        </div>

        <div class="chat-list">
            <div th:each="room : ${chatRooms}" class="chat-item" th:onclick="|enterRoom(${room.roomId})|">
                <div class="avatar-wrapper">
                    <img th:src="@{/images/dog_profile.jpg}" class="avatar-img" alt="프로필">
                </div>

                <div class="chat-content">
                    <div class="chat-name-row">
                        <span class="chat-name" th:text="${room.opponentNickname}">상대방 이름</span>
                        <i class="fa-solid fa-thumbtack pin-icon"></i>
                    </div>
                    <p class="chat-preview" th:text="${room.lastMessage}">최신 메시지 내용</p>
                </div>

                <div class="chat-info">
                    <span class="chat-time" th:text="${room.lastTime}"></span>

                    <div class="chat-options">
                        <i class="fa-solid fa-ellipsis-vertical menu-dots options-icon"
                            onclick="toggleOptionsMenu(event, this)"></i>

                        <div class="options-dropdown">
                            <div class="option-item" onclick="togglePinRoom(event, this)">
                                <i class="fa-solid fa-thumbtack option-icon"></i> <span class="pin-text">고정</span>
                            </div>

                            <div class="option-item delete" onclick="deleteRoom(event, this)">
                                <i class="fa-solid fa-trash-can option-icon"></i> 삭제
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div th:if="${#lists.isEmpty(chatRooms)}" style="text-align: center; padding: 100px 0; color: #bbb;">
            <i class="fa-regular fa-comment-dots" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <p>참여 중인 채팅방이 없습니다.</p>
        </div>

    </div>
    </div>
    <script>
        // (수정) 중복되었던 enterRoom 함수 하나로 통일
        function enterRoom(roomId) {
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');

            if (userId) {
                location.href = '/chat/room/' + roomId + '?userId=' + userId;
            } else {
                alert("로그인 정보(userId)가 없습니다! URL을 확인해주세요.");
            }
        }

        // DOMContentLoaded 이벤트 (검색바 + 탭 메뉴 한 번에 합침)
        document.addEventListener("DOMContentLoaded", function () {
            // 1. 검색창 관련 로직
            const searchIcon = document.getElementById('searchIcon');
            const searchBar = document.getElementById('searchBar');
            const searchInput = document.getElementById('searchInput');

            if (searchIcon) {
                searchIcon.onclick = function () {
                    searchBar.classList.toggle('active');
                    if (searchBar.classList.contains('active')) {
                        setTimeout(() => searchInput.focus(), 200);
                    } else {
                        searchInput.value = '';
                        filterRooms('');
                    }
                };
            }

            if (searchInput) {
                searchInput.onkeyup = function () {
                    filterRooms(this.value);
                };
            }

            // 2. 탭 메뉴(껍데기) 토글 로직
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });

        // 필터링 핵심 함수
        function filterRooms(value) {
            let filter = value.toLowerCase().trim();
            let rooms = document.querySelectorAll('.chat-item');

            rooms.forEach(room => {
                let nameElement = room.querySelector('.chat-name');
                if (!nameElement) return;

                let name = nameElement.innerText.toLowerCase().trim();

                if (name.startsWith(filter)) {
                    room.style.display = 'flex';
                } else {
                    room.style.display = 'none';
                }
            });
        }

        // 점 세 개 클릭 시 메뉴 열기/닫기
        function toggleOptionsMenu(event, iconElement) {
            event.stopPropagation();
            document.querySelectorAll('.options-dropdown.show').forEach(menu => {
                if (menu !== iconElement.nextElementSibling) {
                    menu.classList.remove('show');
                }
            });
            const dropdown = iconElement.nextElementSibling;
            dropdown.classList.toggle('show');
        }

        // 화면 밖 클릭 시 드롭다운 닫기
        document.addEventListener('click', function (event) {
            if (!event.target.matches('.options-icon')) {
                document.querySelectorAll('.options-dropdown.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        /* [chat_list.html 하단 script 내부 - 기존 pinRoom 지우고 이걸로 교체] */

        // 고정/고정해제 버튼 (시계열 정렬 기능 포함)
        function togglePinRoom(event, element) {
            event.stopPropagation();

            const chatItem = element.closest('.chat-item');
            const chatList = document.querySelector('.chat-list');
            const pinText = element.querySelector('.pin-text');

            if (!chatItem) return;

            const isPinned = chatItem.classList.contains('is-pinned');

            // 애니메이션 효과
            chatItem.style.transition = 'opacity 0.3s ease';
            chatItem.style.opacity = '0.5';
            setTimeout(() => chatItem.style.opacity = '1', 300);

            if (isPinned) {
                // [고정 해제 동작]
                chatItem.classList.remove('is-pinned');
                pinText.innerText = '고정';

                // ★ 핵심: 제자리(시간순) 찾기 로직 ★
                // 현재 내 채팅방의 시간 데이터를 가져옴
                const myTime = chatItem.querySelector('.chat-time').innerText;

                // 리스트 내 다른 방들과 시간을 비교해서 들어갈 위치 선정
                const otherRooms = Array.from(chatList.querySelectorAll('.chat-item:not(.is-pinned)'));
                let targetRoom = otherRooms.find(room => {
                    const roomTime = room.querySelector('.chat-time').innerText;
                    return roomTime < myTime; // 나보다 과거인 방을 찾음
                });

                if (targetRoom) {
                    chatList.insertBefore(chatItem, targetRoom); // 나보다 과거인 방 바로 앞에 삽입
                } else {
                    chatList.appendChild(chatItem); // 내가 제일 과거면 맨 뒤로
                }

            } else {
                // [고정 동작]
                chatItem.classList.add('is-pinned');
                pinText.innerText = '해제';
                chatList.prepend(chatItem); // 무조건 맨 위로
            }

            document.querySelectorAll('.options-dropdown.show').forEach(m => m.classList.remove('show'));
        }

        // 삭제 버튼 클릭
        function deleteRoom(event, element) {
            event.stopPropagation();
            if (confirm("정말 이 채팅방을 나가시겠습니까?")) {
                const chatItem = element.closest('.chat-item');
                if (chatItem) {
                    chatItem.style.transition = 'all 0.3s ease';
                    chatItem.style.opacity = '0';
                    chatItem.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        chatItem.remove();
                    }, 300);
                }
            } else {
                document.querySelectorAll('.options-dropdown.show').forEach(m => m.classList.remove('show'));
            }
        }
    </script>
</body>

</html>