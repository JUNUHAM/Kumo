<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Ï±ÑÌåÖÎ∞©</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/chat_room.css(v='3.2')}">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body>

    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="myId" th:value="${userId}">

    <div class="mobile-container">
        <div class="chat-header">
            <a th:href="@{/chat/list(userId=${userId})}" class="header-back-btn">
                <i class="fa-solid fa-chevron-left"></i>
            </a>

            <div class="header-translate-btn">
                <img th:src="@{/images/icons/chat_room_translate.svg}" class="translate-icon-img" alt="Î≤àÏó≠">
            </div>

            <div class="header-center">
                <div class="store-profile-row">
                    <img th:src="@{/images/dog_profile.jpg}" class="header-store-img">
                    <span class="header-store-name" th:text="${roomName}">ÏÉÅÎåÄÎ∞© Ïù¥Î¶Ñ</span>
                </div>

                <div class="header-info-row">
                    <span th:text="${address}">Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå</span>
                </div>

                <div class="header-salary-row">
                    Áµ¶Êñô: <span th:text="${#numbers.formatInteger(salary, 3, 'COMMA')}">0</span>¬•
                </div>
            </div>
        </div>

        <div class="msg-area" id="msgArea">
            <th:block th:each="msg, stat : ${history}">

                <th:block th:if="${stat.first or msg.createdDate != history[stat.index - 1].createdDate}">
                    <div class="date-divider" th:if="${msg.createdDate != null}">
                        <span class="date-divider-text" th:text="${msg.createdDate}">2026-02-26</span>
                    </div>
                </th:block>

                <div th:if="${msg.senderId != userId}" class="msg-row other">
                    <img th:src="@{/images/dog_profile.jpg}" class="profile-img">

                    <th:block th:if="${msg.messageType == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">ÎÇ¥Ïö©</div>
                    </th:block>

                    <th:block th:if="${msg.messageType == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>

                    <th:block th:if="${msg.messageType == 'FILE'}">
                        <div class="file-bubble" th:data-url="${msg.content}"
                            onclick="window.open(this.getAttribute('data-url'))" style="cursor: pointer;">
                            <div class="file-icon-box"><i class="fa-solid fa-file-pdf"></i></div>
                            <div class="file-info-box">
                                <div class="raw-file-name" style="display: none;" th:text="${msg.content}"></div>
                                <div class="file-display-name"></div>
                                <div class="file-display-sub">ÌååÏùº Ïó¥Í∏∞</div>
                            </div>
                        </div>
                    </th:block>

                    <span class="msg-time" th:text="${msg.createdAt}"></span>
                </div>

                <div th:if="${msg.senderId == userId}" class="msg-row me">
                    <div class="msg-info">
                        <span class="unread-count" th:if="${msg.isRead == false}">1</span>
                        <span class="msg-time" th:text="${msg.createdAt}"></span>
                    </div>

                    <th:block th:if="${msg.messageType == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">ÎÇ¥Ïö©</div>
                    </th:block>

                    <th:block th:if="${msg.messageType == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>

                    <th:block th:if="${msg.messageType == 'FILE'}">
                        <div class="file-bubble" th:data-url="${msg.content}"
                            onclick="window.open(this.getAttribute('data-url'))" style="cursor: pointer;">
                            <div class="file-icon-box"><i class="fa-solid fa-file-pdf"></i></div>
                            <div class="file-info-box">
                                <div class="raw-file-name" style="display: none;" th:text="${msg.content}"></div>
                                <div class="file-display-name"></div>
                                <div class="file-display-sub">ÌååÏùº Ïó¥Í∏∞</div>
                            </div>
                        </div>
                    </th:block>
                </div>

            </th:block>
        </div>

        <div class="input-area">
            <i class="fa-solid fa-plus btn-plus" onclick="openMainMenu()" style="cursor: pointer;"></i>
            <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="uploadImage()">
            <img th:src="@{/images/icons/chat_room_images.svg}" class="btn-img-upload" alt="ÏÇ¨ÏßÑÏ≤®Î∂Ä"
                onclick="document.getElementById('fileInput').click()">
            <textarea class="input-field" id="msgInput" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." rows="1" onkeydown="handleEnter(event)"
                oninput="autoResize(this)"></textarea>
            <button class="btn-send" onclick="sendMessage()">Ï†ÑÏÜ°</button>
        </div>

        <dialog id="imageModal" class="std-dialog-clear">
            <div class="image-modal" style="display: flex; position: static;">
                <span class="close-modal-btn" onclick="closeImageModal()">&times;</span>
                <img class="modal-content-img" id="modalImage">
            </div>
        </dialog>

        <dialog id="mainPlusMenu" class="std-dialog-clear" style="margin-bottom: 0;">
            <div class="main-menu-box" onclick="event.stopPropagation()">
                <div class="menu-grid">

                    <div class="menu-item" onclick="openSubMenu('template')">
                        <div class="menu-icon-circle" style="background-color: #fff4cc;">
                            <i class="fa-regular fa-message" style="color: #ffb800;"></i>
                        </div>
                        <span class="menu-name">ÏûêÏ£º Ïì∞Îäî Î©îÏãúÏßÄ</span>
                    </div>

                    <div class="menu-item" onclick="document.getElementById('fileInput').click(); closeMainMenu();">
                        <div class="menu-icon-circle" style="background-color: #ffe8e8;">
                            <i class="fa-regular fa-image" style="color: #ff5252;"></i>
                        </div>
                        <span class="menu-name">Ïï®Î≤î</span>
                    </div>

                    <div class="menu-item" onclick="document.getElementById('docFileInput').click(); closeMainMenu();">
                        <div class="menu-icon-circle" style="background-color: #e8f5e9;">
                            <i class="fa-regular fa-file-lines" style="color: #4caf50;"></i>
                        </div>
                        <span class="menu-name">Î¨∏ÏÑú</span>
                    </div>

                    <div class="menu-item" onclick="alert('Ï∂îÌõÑÏóê Íµ¨ÌòÑ ÏòàÏ†ïÏù¥ÏóêÏöî!')">
                        <div class="menu-icon-circle" style="background-color: #e3f2fd;">
                            <i class="fa-regular fa-calendar" style="color: #2196f3;"></i>
                        </div>
                        <span class="menu-name">Î©¥Ï†ë ÏùºÏ†ï</span>
                    </div>

                </div>
            </div>
        </dialog>

        <input type="file" id="docFileInput" style="display: none;" accept=".pdf, .xlsx, .xls, .docx, .doc, .txt"
            onchange="uploadFile()">

    </div>

    <dialog id="templateMenu" class="std-dialog-clear" style="margin-bottom: 0;">
        <div class="template-box" onclick="event.stopPropagation()">
            <div class="template-header">
                <span>ÏûêÏ£º Ïì∞Îäî Î©îÏãúÏßÄ</span>
                <span class="close-btn" onclick="closeTemplateMenu()">&times;</span>
            </div>
            <div class="template-list">
                <button onclick="insertText('ÏïàÎÖïÌïòÏÑ∏Ïöî, Î©¥Ï†ë Ï†úÏïà ÎìúÎ¶¨Í≥† Ïã∂ÏäµÎãàÎã§. :)')">üìÖ Î©¥Ï†ë Ï†úÏïà</button>
                <button onclick="insertText('Ïù¥Î†•ÏÑúÎ•º Ï∂îÍ∞ÄÎ°ú ÏöîÏ≤≠ÎìúÎ†§ÎèÑ Îê†ÍπåÏöî? :)')">üìÇ Ïù¥Î†•ÏÑú ÏöîÏ≤≠</button>
                <button onclick="insertText('Ìï©Í≤© ÌÜµÎ≥¥ ÎìúÎ¶ΩÎãàÎã§. Ï∂ïÌïòÌï©ÎãàÎã§! :)')">üéâ Ìï©Í≤© ÌÜµÎ≥¥</button>
                <button onclick="insertText('ÎÑ§, Î©¥Ï†ë ÏùºÏ†ï ÌôïÏù∏ÌñàÏäµÎãàÎã§. :)')">‚úÖ ÏùºÏ†ï ÌôïÏù∏</button>
                <button onclick="insertText('ÎèÑÏ∞©ÌñàÏäµÎãàÎã§. Í∏∞Îã§Î¶¨Í≥† ÏûàÏñ¥Ïöî. :)')">üìç ÎèÑÏ∞© ÏïåÎ¶º</button>
            </div>
        </div>
    </dialog>

    <script th:src="@{/js/chat_room.js(v='1.0')}"></script>

</body>

</html>