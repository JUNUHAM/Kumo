<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°©</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/chat_room.css(v='3.1')}">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        /* [ì •ì„] dialog ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” (ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ë³´ì¡´) */
        .std-dialog-clear {
            border: none;
            background: transparent;
            padding: 0;
            width: 100%;
            max-width: 480px;
            margin: auto;
            outline: none;
            overflow: visible;
        }

        .std-dialog-clear::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        /* --- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ (ì „ì²´ í™”ë©´) --- */
        .image-modal {
            display: none;
            /* í‰ì†Œì—” ìˆ¨ê¹€ */
            position: fixed;
            /* â˜…í•µì‹¬: ë·°í¬íŠ¸(ë¸Œë¼ìš°ì € ì°½ ì „ì²´) ê¸°ì¤€ìœ¼ë¡œ ê³ ì • */
            z-index: 9999;
            /* ë‹¤ë¥¸ ëª¨ë“  ìš”ì†Œ ìœ„ì— í‘œì‹œ */
            left: 0;
            top: 0;
            width: 100%;
            /* í™”ë©´ ë„ˆë¹„ 100% */
            height: 100%;
            /* í™”ë©´ ë†’ì´ 100% */
            background-color: rgba(0, 0, 0, 0.9);
            /* ì•„ì£¼ ì§™ì€ ê²€ì€ìƒ‰ ë°°ê²½ */

            /* ë‚´ìš©ë¬¼ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ Flexbox ì„¤ì • */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        /* í™•ëŒ€ëœ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .modal-content-img {
            /* í™”ë©´ì„ ê½‰ ì±„ìš°ë˜, ë¹„ìœ¨ì€ ìœ ì§€ */
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            /* ì´ë¯¸ì§€ ë¹„ìœ¨ì´ ê¹¨ì§€ì§€ ì•Šê²Œ ì»¨í…Œì´ë„ˆì— ë§ì¶¤ */

            /* ì§€ì €ë¶„í•´ ë³´ì¼ ìˆ˜ ìˆëŠ” ê·¸ë¦¼ì ì œê±° */
            box-shadow: none;
        }

        /* ë‹«ê¸° ë²„íŠ¼ (X) ìŠ¤íƒ€ì¼ */
        .close-modal-btn {
            position: absolute;
            /* ëª¨ë‹¬ ë°°ê²½ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ì¡ê¸° */
            top: 30px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            z-index: 10000;
            /* ì´ë¯¸ì§€ë³´ë‹¤ë„ ìœ„ì— */
        }

        .close-modal-btn:hover {
            color: #bbb;
        }

        /* ì¤Œì¸ ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
        @keyframes zoomIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-image {
            cursor: pointer;
            transition: transform 0.1s;
        }

        .chat-image:active {
            transform: scale(0.98);
        }
    </style>
</head>

<body>

    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="myId" th:value="${userId}">

    <div class="mobile-container">
        <div class="chat-header">
            <a th:href="@{/chat/list(userId=${userId})}" class="header-back-btn">
                <i class="fa-solid fa-chevron-left"></i>
            </a>

            <div class="header-translate-btn">
                <img th:src="@{/images/icons/chat_room_translate.svg}" class="translate-icon-img" alt="ë²ˆì—­">
            </div>

            <div class="header-center">
                <div class="store-profile-row">
                    <img th:src="@{/images/dog_profile.jpg}" class="header-store-img">
                    <span class="header-store-name" th:text="${roomName}">ìƒëŒ€ë°© ì´ë¦„</span>
                </div>

                <div class="header-info-row">
                    <span th:text="${address}">ì£¼ì†Œ ì •ë³´ ì—†ìŒ</span>
                </div>

                <div class="header-salary-row">
                    çµ¦æ–™: <span th:text="${#numbers.formatInteger(salary, 3, 'COMMA')}">0</span>Â¥
                </div>
            </div>
        </div>

        <div class="msg-area" id="msgArea">
            <th:block th:each="msg, stat : ${history}">

                <div th:if="${msg.senderId != userId}" class="msg-row other">
                    <img th:src="@{/images/dog_profile.jpg}" class="profile-img">

                    <th:block th:if="${msg.messageType == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">ë‚´ìš©</div>
                    </th:block>
                    <th:block th:if="${msg.messageType == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>

                    <span class="msg-time" th:text="${msg.createdAt}"></span>
                </div>

                <div th:if="${msg.senderId == userId}" class="msg-row me">
                    <span class="msg-time" th:text="${msg.createdAt}"></span>

                    <th:block th:if="${msg.messageType == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">ë‚´ìš©</div>
                    </th:block>
                    <th:block th:if="${msg.messageType == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>
                </div>

            </th:block>
        </div>

        <div class="input-area">
            <i class="fa-solid fa-plus btn-plus" onclick="openMainMenu()" style="cursor: pointer;"></i>
            <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="uploadImage()">
            <img th:src="@{/images/icons/chat_room_images.svg}" class="btn-img-upload" alt="ì‚¬ì§„ì²¨ë¶€"
                onclick="document.getElementById('fileInput').click()">
            <textarea class="input-field" id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1" onkeydown="handleEnter(event)"
                oninput="autoResize(this)"></textarea>
            <button class="btn-send" onclick="sendMessage()">ì „ì†¡</button>
        </div>

        <dialog id="imageModal" class="std-dialog-clear">
            <div class="image-modal" style="display: flex; position: static;">
                <span class="close-modal-btn" onclick="closeImageModal()">&times;</span>
                <img class="modal-content-img" id="modalImage">
            </div>
        </dialog>

        <dialog id="mainPlusMenu" class="std-dialog-clear" style="margin-bottom: 0;">
            <div class="main-menu-box" onclick="event.stopPropagation()">
                <div class="menu-grid">
                    <div class="menu-item" onclick="openSubMenu('template')">
                        <div class="menu-icon-circle" style="background-color: #fef01b;"><i
                                class="fa-solid fa-comment-dots" style="color: #3b1e1e;"></i></div>
                        <span class="menu-name">ìì£¼ ì“°ëŠ” ë©”ì‹œì§€</span>
                    </div>
                    <div class="menu-item" onclick="document.getElementById('fileInput').click(); closeMainMenu();">
                        <div class="menu-icon-circle" style="background-color: #ffebee;"><i class="fa-solid fa-image"
                                style="color: #f44336;"></i></div>
                        <span class="menu-name">ì•¨ë²”</span>
                    </div>
                    <div class="menu-item" onclick="alert('ì´ë ¥ì„œ ì „ì†¡ ê¸°ëŠ¥')">
                        <div class="menu-icon-circle" style="background-color: #e8f5e9;"><i
                                class="fa-solid fa-address-card" style="color: #4caf50;"></i></div>
                        <span class="menu-name">ë¬¸ì„œ</span>

                    </div>
                    <div class="menu-item" onclick="alert('ì¶”í›„ì— êµ¬í˜„ ì˜ˆì •ì´ì—ìš”!')">
                        <div class="menu-icon-circle" style="background-color: #e3f2fd;"><i
                                class="fa-solid fa-calendar-check" style="color: #2196f3;"></i></div>
                        <span class="menu-name">ë©´ì ‘ ì¼ì •</span>
                    </div>
                </div>
        </dialog>

        <dialog id="templateMenu" class="std-dialog-clear" style="margin-bottom: 0;">
            <div class="template-box" onclick="event.stopPropagation()">
                <div class="template-header">
                    <span>ìì£¼ ì“°ëŠ” ë©”ì‹œì§€</span>
                    <span class="close-btn" onclick="closeTemplateMenu()">&times;</span>
                </div>
                <div class="template-list">
                    <button onclick="insertText('ì•ˆë…•í•˜ì„¸ìš”, ë©´ì ‘ ì œì•ˆ ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤. :)')">ğŸ“… ë©´ì ‘ ì œì•ˆ</button>
                    <button onclick="insertText('ì´ë ¥ì„œë¥¼ ì¶”ê°€ë¡œ ìš”ì²­ë“œë ¤ë„ ë ê¹Œìš”? :)')">ğŸ“‚ ì´ë ¥ì„œ ìš”ì²­</button>
                    <button onclick="insertText('í•©ê²© í†µë³´ ë“œë¦½ë‹ˆë‹¤. ì¶•í•˜í•©ë‹ˆë‹¤! :)')">ğŸ‰ í•©ê²© í†µë³´</button>
                    <button onclick="insertText('ë„¤, ë©´ì ‘ ì¼ì • í™•ì¸í–ˆìŠµë‹ˆë‹¤. :)')">âœ… ì¼ì • í™•ì¸</button>
                    <button onclick="insertText('ë„ì°©í–ˆìŠµë‹ˆë‹¤. ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”. :)')">ğŸ“ ë„ì°© ì•Œë¦¼</button>
                </div>
            </div>
        </dialog>

        <script>
            var stompClient = null;
            var roomId = document.getElementById("roomId").value;
            var myId = document.getElementById("myId").value;
            var msgArea = document.getElementById("msgArea");
            var lastChatDate = null;

            connect();

            function connect() {
                var socket = new SockJS('/ws-stomp');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/sub/chat/room/' + roomId, function (messageOutput) {
                        showMessage(JSON.parse(messageOutput.body));
                    });
                    scrollToBottom();
                });
            }

            function sendMessage() {
                var msgInput = document.getElementById("msgInput");
                var messageContent = msgInput.value.trim();

                if (messageContent && stompClient) {
                    // [ìˆ˜ì •] DTO ê·œê²©ì— ë§ê²Œ ë³€ìˆ˜ëª… ë‹¨ìˆœí™”
                    var chatMessage = {
                        roomId: roomId,
                        senderId: myId,
                        content: messageContent,
                        messageType: 'TEXT'
                    };
                    stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));

                    msgInput.value = '';
                    msgInput.style.height = 'auto';
                    msgInput.style.overflowY = 'hidden';
                    msgInput.focus();
                }
            }

            function showMessage(message) {
                // [ìˆ˜ì •] message.senderId ì‚¬ìš©
                var isMe = (message.senderId == myId);
                var div = document.createElement('div');

                // [ìˆ˜ì •] ì„œë²„ì—ì„œ ë³´ë‚´ì¤€ createdAt (HH:mm) ê·¸ëŒ€ë¡œ ì‚¬ìš©
                var timeString = message.createdAt;

                var finalContentHtml = "";
                if (message.messageType === 'IMAGE') {
                    finalContentHtml = `<img src="${message.content}" class="chat-image" 
                                        style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                                        onclick="openImageModal(this.src)">`;
                } else {
                    finalContentHtml = `<div class="msg-bubble">${message.content}</div>`;
                }

                if (isMe) {
                    div.className = "msg-row me";
                    div.innerHTML = `
                        <span class="msg-time">${timeString}</span>
                        ${finalContentHtml}
                    `;
                } else {
                    div.className = "msg-row other";
                    div.innerHTML = `
                        <img src="/images/dog_profile.jpg" class="profile-img">
                        ${finalContentHtml}
                        <span class="msg-time">${timeString}</span>
                    `;
                }

                msgArea.appendChild(div);
                scrollToBottom();
            }

            function autoResize(textarea) {
                textarea.style.height = 'auto';
                var maxHeight = 120;
                if (textarea.scrollHeight > maxHeight) {
                    textarea.style.height = maxHeight + 'px';
                    textarea.style.overflowY = 'auto';
                } else {
                    textarea.style.height = textarea.scrollHeight + 'px';
                    textarea.style.overflowY = 'hidden';
                }
            }

            function handleEnter(e) {
                if (e.isComposing || e.keyCode === 229) return;
                if (e.key === 'Enter') {
                    if (!e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                }
            }

            function uploadImage() {
                var fileInput = document.getElementById('fileInput');
                var file = fileInput.files[0];
                if (file) {
                    var formData = new FormData();
                    formData.append("file", file);
                    fetch('/chat/upload', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.text())
                        .then(imageUrl => {
                            if (imageUrl.includes("ì‹¤íŒ¨")) {
                                alert("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨");
                                return;
                            }
                            // [ìˆ˜ì •] DTO ê·œê²©í™”
                            var chatMessage = {
                                roomId: roomId,
                                senderId: myId,
                                content: imageUrl,
                                messageType: 'IMAGE'
                            };
                            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
                        });
                    fileInput.value = '';
                }
            }

            function scrollToBottom() {
                setTimeout(function () {
                    msgArea.scrollTop = msgArea.scrollHeight;
                }, 50);
            }

            // [ì •ì„] ëª¨ë‹¬ ì œì–´ ì „ìš© (ê¸°ì¡´ ì¤‘ë³µ í•¨ìˆ˜ ì •ë¦¬)
            const modalImg = document.getElementById("imageModal");
            const modalMain = document.getElementById("mainPlusMenu");
            const modalTemp = document.getElementById("templateMenu");

            function openImageModal(src) {
                document.getElementById("modalImage").src = src;
                modalImg.showModal();
            }
            function closeImageModal() { modalImg.close(); }

            function openMainMenu() { modalMain.showModal(); }
            function closeMainMenu() { modalMain.close(); }

            function openTemplateMenu() { modalTemp.showModal(); }
            function closeTemplateMenu() { modalTemp.close(); }

            function openSubMenu(type) {
                closeMainMenu();
                if (type === 'template') openTemplateMenu();
            }

            function insertText(text) {
                const inputField = document.getElementById('msgInput');
                if (inputField) {
                    inputField.value = text;
                    inputField.focus();
                    if (typeof autoResize === 'function') autoResize(inputField);
                }
                closeTemplateMenu();
            }

            // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
            [modalImg, modalMain, modalTemp].forEach(m => {
                m.addEventListener('click', (e) => {
                    if (e.target.nodeName === 'DIALOG') m.close();
                });
            });

            // [ë°°ì¹˜ ë²ˆì—­] 769ìë¥¼ 2ì´ˆ ë§Œì— ì²˜ë¦¬í•˜ëŠ” ê³ ì† ë²„ì „
            async function translateAllMessages() {
                console.log("ğŸš€ [DEBUG] ë²ˆì—­ í”„ë¡œì„¸ìŠ¤ ì‹œì‘"); // ì´ê²Œ ì•ˆ ì°íˆë©´ í´ë¦­ì´ ì•ˆ ëœ ê²ƒì„

                const translateBtn = document.querySelector('.header-translate-btn');
                const bubbles = document.querySelectorAll('.msg-bubble');

                const textsToTranslate = [];
                const targetBubbles = [];

                // 1. ë²ˆì—­í•  í…ìŠ¤íŠ¸ ìˆ˜ì§‘
                bubbles.forEach(bubble => {
                    if (!bubble.querySelector('.translated-text')) {
                        const txt = bubble.innerText.trim();
                        if (txt) {
                            textsToTranslate.push(txt);
                            targetBubbles.push(bubble);
                        }
                    }
                });

                if (textsToTranslate.length === 0) {
                    console.log("âš ï¸ ë²ˆì—­í•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                try {
                    // ì²« ë²ˆì§¸ ë¬¸ì¥ìœ¼ë¡œ ì–¸ì–´ ê°ì§€
                    const isKorean = /[ã„±-ã…|ã…-ã…£|ê°€-í£]/.test(textsToTranslate[0]);
                    const targetLang = isKorean ? 'JA' : 'KO';

                    console.log(`ğŸ“¡ ì„œë²„ì— ${textsToTranslate.length}ê°œ ë¬¸ì¥ ë²ˆì—­ ìš”ì²­ ì¤‘...`);

                    const response = await fetch('/api/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: textsToTranslate, // ë°°ì—´ë¡œ ì „ì†¡
                            target_lang: targetLang
                        })
                    });

                    if (!response.ok) throw new Error(`ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨: ${response.status}`);

                    const data = await response.json();
                    console.log("âœ… ì„œë²„ ì‘ë‹µ ìˆ˜ì‹ :", data);

                    // 2. ê²°ê³¼ ë Œë”ë§
                    if (data && data.translations) {
                        data.translations.forEach((item, index) => {
                            const bubble = targetBubbles[index];
                            if (!bubble) return;

                            const hr = document.createElement('hr');
                            hr.style.margin = '5px 0';
                            hr.style.border = '0.5px solid rgba(0,0,0,0.1)';

                            const div = document.createElement('div');
                            div.className = 'translated-text';
                            div.style.fontSize = '0.85em';
                            div.style.color = '#555';
                            div.innerText = 'ğŸŒ ' + item.text;

                            bubble.appendChild(hr);
                            bubble.appendChild(div);
                        });
                        console.log("ğŸ‰ ëª¨ë“  ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    }
                } catch (err) {
                    console.error("âŒ ë²ˆì—­ ì¤‘ ì—ëŸ¬ ë°œìƒ:", err);
                    alert("ë²ˆì—­ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
                }
            }

            // â˜… ì´ë²¤íŠ¸ ì—°ê²° í™•ì¸ìš© (ë§¤ìš° ì¤‘ìš”)
            document.addEventListener("DOMContentLoaded", function () {
                const translateBtn = document.querySelector('.header-translate-btn');
                if (translateBtn) {
                    translateBtn.onclick = translateAllMessages;
                    console.log("âœ… [DEBUG] ë²ˆì—­ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° ì™„ë£Œ!");
                } else {
                    console.error("âŒ [DEBUG] ë²ˆì—­ ë²„íŠ¼(.header-translate-btn)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            });
        </script>
</body>

</html>