<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/chat_room.css(v='3.1')}">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-content-img {
            max-width: 90%;
            max-height: 80%;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            object-fit: contain;
            animation: zoomIn 0.2s ease-out;
        }

        .close-modal-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            z-index: 10000;
        }

        .close-modal-btn:hover {
            color: #bbb;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-image {
            cursor: pointer;
            transition: transform 0.1s;
        }

        .chat-image:active {
            transform: scale(0.98);
        }
    </style>
</head>

<body>

    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="myId" th:value="${userId}">

    <div class="mobile-container">
        <div class="chat-header">
            <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBackToList()"></i>

            <div class="header-translate-btn">
                <img th:src="@{/images/icons/chat_room_translate.svg}" class="translate-icon-img" alt="번역">
            </div>

            <div class="header-center">
                <div class="store-profile-row">
                    <img th:src="@{/images/dog_profile.jpg}" class="header-store-img">
                    <span class="header-store-name" th:text="${roomName}">상대방 이름</span>
                    <div class="online-dot"></div>
                </div>

                <div class="header-info-row">
                    <span th:text="${address}">주소 정보 없음</span>
                </div>

                <div class="header-salary-row">
                    給料: <span th:text="${#numbers.formatInteger(salary, 3, 'COMMA')}">0</span>¥
                </div>
            </div>
        </div>

        <div class="msg-area" id="msgArea">
            <th:block th:each="msg, stat : ${history}">

                <th:block
                    th:if="${stat.first} or ${!#strings.equals(#temporals.format(msg.createdAt, 'yyyy-MM-dd'), #temporals.format(history[stat.index-1].createdAt, 'yyyy-MM-dd'))}">
                    <div class="date-divider">
                        <span class="date-divider-text"
                            th:text="${#temporals.format(msg.createdAt, 'yyyy년 M월 d일 EEEE')}"></span>
                    </div>
                </th:block>

                <div th:if="${msg.sender.userId != userId}" class="msg-row other"
                    th:data-date="${#temporals.format(msg.createdAt, 'yyyy-MM-dd')}">

                    <img th:src="@{/images/dog_profile.jpg}" class="profile-img">

                    <th:block th:if="${msg.messageType.name() == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">내용</div>
                    </th:block>
                    <th:block th:if="${msg.messageType.name() == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>

                    <span class="msg-time" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}"></span>
                </div>

                <div th:if="${msg.sender.userId == userId}" class="msg-row me"
                    th:data-date="${#temporals.format(msg.createdAt, 'yyyy-MM-dd')}">

                    <span class="msg-time" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}"></span>

                    <th:block th:if="${msg.messageType.name() == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">내용</div>
                    </th:block>
                    <th:block th:if="${msg.messageType.name() == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>
                </div>

            </th:block>
        </div>

        <div class="input-area">
            <i class="fa-solid fa-plus btn-plus"></i>
            <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="uploadImage()">
            <img th:src="@{/images/icons/chat_room_images.svg}" class="btn-img-upload" alt="사진첨부"
                onclick="document.getElementById('fileInput').click()">
            <textarea class="input-field" id="msgInput" placeholder="메시지 입력..." rows="1" onkeydown="handleEnter(event)"
                oninput="autoResize(this)"></textarea>
            <button class="btn-send" onclick="sendMessage()">전송</button>
        </div>

        <div id="imageModal" class="image-modal" onclick="closeImageModal()">
            <span class="close-modal-btn">&times;</span>
            <img class="modal-content-img" id="modalImage">
        </div>

        <script>
            var stompClient = null;
            var roomId = document.getElementById("roomId").value;
            var myId = document.getElementById("myId").value;
            var msgArea = document.getElementById("msgArea");
            var lastChatDate = null;

            connect();

            function connect() {
                var socket = new SockJS('/ws-stomp');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    initLastChatDate();
                    stompClient.subscribe('/sub/chat/room/' + roomId, function (messageOutput) {
                        showMessage(JSON.parse(messageOutput.body));
                    });
                    scrollToBottom();
                });
            }

            function sendMessage() {
                var msgInput = document.getElementById("msgInput");
                var messageContent = msgInput.value.trim();

                if (messageContent && stompClient) {
                    var chatMessage = {
                        room: { id: roomId },
                        sender: { userId: myId },
                        content: messageContent,
                        messageType: 'TEXT'
                    };
                    stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));

                    msgInput.value = '';
                    msgInput.style.height = 'auto';
                    msgInput.style.overflowY = 'hidden';
                    msgInput.focus();
                }
            }

            function autoResize(textarea) {
                textarea.style.height = 'auto';
                var maxHeight = 120;
                if (textarea.scrollHeight > maxHeight) {
                    textarea.style.height = maxHeight + 'px';
                    textarea.style.overflowY = 'auto';
                } else {
                    textarea.style.height = textarea.scrollHeight + 'px';
                    textarea.style.overflowY = 'hidden';
                }
            }

            function handleEnter(e) {
                if (e.isComposing || e.keyCode === 229) return;
                if (e.key === 'Enter') {
                    if (!e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                }
            }

            function showMessage(message) {
                var dateObj = message.createdAt ? new Date(message.createdAt) : new Date();
                checkAndAddDateDivider(dateObj);

                var isMe = (message.sender.userId == myId);
                var div = document.createElement('div');
                var timeString = dateObj.getHours().toString().padStart(2, '0') + ':' +
                    dateObj.getMinutes().toString().padStart(2, '0');

                var year = dateObj.getFullYear();
                var month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                var day = dateObj.getDate().toString().padStart(2, '0');
                var dateStr = year + "-" + month + "-" + day;

                var finalContentHtml = "";
                if (message.messageType === 'IMAGE') {
                    finalContentHtml = `<img src="${message.content}" class="chat-image" 
                                        style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                                        onclick="openImageModal(this.src)">`;
                } else {
                    finalContentHtml = `<div class="msg-bubble">${message.content}</div>`;
                }

                if (isMe) {
                    div.className = "msg-row me";
                    div.setAttribute("data-date", dateStr);
                    div.innerHTML = `
                        <span class="msg-time">${timeString}</span>
                        ${finalContentHtml}
                    `;
                } else {
                    div.className = "msg-row other";
                    div.setAttribute("data-date", dateStr);
                    div.innerHTML = `
                        <img src="/images/dog_profile.jpg" class="profile-img">
                        ${finalContentHtml}
                        <span class="msg-time">${timeString}</span>
                    `;
                }

                msgArea.appendChild(div);
                scrollToBottom();
            }

            function uploadImage() {
                var fileInput = document.getElementById('fileInput');
                var file = fileInput.files[0];
                if (file) {
                    var formData = new FormData();
                    formData.append("file", file);
                    fetch('/chat/upload', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.text())
                        .then(imageUrl => {
                            if (imageUrl.includes("실패")) {
                                alert("사진 업로드 실패");
                                return;
                            }
                            var chatMessage = {
                                room: { id: roomId },
                                sender: { userId: myId },
                                content: imageUrl,
                                messageType: 'IMAGE'
                            };
                            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
                        });
                    fileInput.value = '';
                }
            }

            function checkAndAddDateDivider(dateObj) {
                var year = dateObj.getFullYear();
                var month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                var day = dateObj.getDate().toString().padStart(2, '0');
                var dateStr = year + "-" + month + "-" + day;
                if (lastChatDate !== dateStr) {
                    var days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
                    var dayName = days[dateObj.getDay()];
                    var fullDateText = year + "년 " + parseInt(month) + "월 " + parseInt(day) + "일 " + dayName;
                    var dividerDiv = document.createElement('div');
                    dividerDiv.className = "date-divider";
                    dividerDiv.innerHTML = `<span class="date-divider-text">${fullDateText}</span>`;
                    msgArea.appendChild(dividerDiv);
                    lastChatDate = dateStr;
                }
            }
            function initLastChatDate() {
                var rows = document.querySelectorAll('.msg-row');
                if (rows.length > 0) {
                    var lastRow = rows[rows.length - 1];
                    var dateAttr = lastRow.getAttribute('data-date');
                    if (dateAttr) lastChatDate = dateAttr;
                }
            }
            function scrollToBottom() {
                setTimeout(function () {
                    msgArea.scrollTop = msgArea.scrollHeight;
                }, 50);
            }
            function goBackToList() {
                var userId = document.getElementById("myId").value;
                location.href = userId ? '/chat/list?userId=' + userId : '/chat/list';
            }

            function openImageModal(src) {
                var modal = document.getElementById("imageModal");
                var modalImg = document.getElementById("modalImage");
                modal.style.display = "flex";
                modalImg.src = src;
            }

            function closeImageModal() {
                document.getElementById("imageModal").style.display = "none";
            }
        </script>
</body>

</html>