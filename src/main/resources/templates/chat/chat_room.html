<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°©</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/chat_room.css(v='3.1')}">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .modal-content-img {
            max-width: 90%;
            max-height: 80%;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            object-fit: contain;
            animation: zoomIn 0.2s ease-out;
        }

        .close-modal-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            z-index: 10000;
        }

        .close-modal-btn:hover {
            color: #bbb;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-image {
            cursor: pointer;
            transition: transform 0.1s;
        }

        .chat-image:active {
            transform: scale(0.98);
        }
    </style>
</head>

<body>

    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="myId" th:value="${userId}">

    <div class="mobile-container">
        <div class="chat-header">

            <div class="header-translate-btn">
                <img th:src="@{/images/icons/chat_room_translate.svg}" class="translate-icon-img" alt="ë²ˆì—­">
            </div>

            <div class="header-center">
                <div class="store-profile-row">
                    <img th:src="@{/images/dog_profile.jpg}" class="header-store-img">
                    <span class="header-store-name" th:text="${roomName}">ìƒëŒ€ë°© ì´ë¦„</span>
                    <div class="online-dot"></div>
                </div>

                <div class="header-info-row">
                    <span th:text="${address}">ì£¼ì†Œ ì •ë³´ ì—†ìŒ</span>
                </div>

                <div class="header-salary-row">
                    çµ¦æ–™: <span th:text="${#numbers.formatInteger(salary, 3, 'COMMA')}">0</span>Â¥
                </div>
            </div>
        </div>

        <div class="msg-area" id="msgArea">
            <th:block th:each="msg, stat : ${history}">

                <th:block
                    th:if="${stat.first} or ${!#strings.equals(#temporals.format(msg.createdAt, 'yyyy-MM-dd'), #temporals.format(history[stat.index-1].createdAt, 'yyyy-MM-dd'))}">
                    <div class="date-divider">
                        <span class="date-divider-text"
                            th:text="${#temporals.format(msg.createdAt, 'yyyyë…„ Mì›” dì¼ EEEE')}"></span>
                    </div>
                </th:block>

                <div th:if="${msg.sender.userId != userId}" class="msg-row other"
                    th:data-date="${#temporals.format(msg.createdAt, 'yyyy-MM-dd')}">

                    <img th:src="@{/images/dog_profile.jpg}" class="profile-img">

                    <th:block th:if="${msg.messageType.name() == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">ë‚´ìš©</div>
                    </th:block>
                    <th:block th:if="${msg.messageType.name() == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>

                    <span class="msg-time" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}"></span>
                </div>

                <div th:if="${msg.sender.userId == userId}" class="msg-row me"
                    th:data-date="${#temporals.format(msg.createdAt, 'yyyy-MM-dd')}">

                    <span class="msg-time" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}"></span>

                    <th:block th:if="${msg.messageType.name() == 'TEXT'}">
                        <div class="msg-bubble" th:text="${msg.content}">ë‚´ìš©</div>
                    </th:block>
                    <th:block th:if="${msg.messageType.name() == 'IMAGE'}">
                        <img th:src="${msg.content}" class="chat-image"
                            style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                            onclick="openImageModal(this.src)">
                    </th:block>
                </div>

            </th:block>
        </div>

        <div class="input-area">
            <i class="fa-solid fa-plus btn-plus" onclick="openMainMenu()" style="cursor: pointer;"></i>
            <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="uploadImage()">
            <img th:src="@{/images/icons/chat_room_images.svg}" class="btn-img-upload" alt="ì‚¬ì§„ì²¨ë¶€"
                onclick="document.getElementById('fileInput').click()">
            <textarea class="input-field" id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1" onkeydown="handleEnter(event)"
                oninput="autoResize(this)"></textarea>
            <button class="btn-send" onclick="sendMessage()">ì „ì†¡</button>
        </div>

        <div id="imageModal" class="image-modal" onclick="closeImageModal()">
            <span class="close-modal-btn">&times;</span>
            <img class="modal-content-img" id="modalImage">
        </div>

        <div id="mainPlusMenu" class="main-menu-overlay" onclick="closeMainMenu()">
            <div class="main-menu-box" onclick="event.stopPropagation()">
                <div class="menu-grid">

                    <div class="menu-item" onclick="openSubMenu('template')">
                        <div class="menu-icon-circle" style="background-color: #fef01b;">
                            <i class="fa-solid fa-comment-dots" style="color: #3b1e1e;"></i>
                        </div>
                        <span class="menu-name">ìì£¼ ì“°ëŠ” ë©”ì‹œì§€</span>
                    </div>

                    <div class="menu-item" onclick="alert('ì§€ë„ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!')">
                        <div class="menu-icon-circle" style="background-color: #e3f2fd;">
                            <i class="fa-solid fa-location-dot" style="color: #2196f3;"></i>
                        </div>
                        <span class="menu-name">ìœ„ì¹˜ ê³µìœ </span>
                    </div>

                    <div class="menu-item" onclick="document.getElementById('fileInput').click(); closeMainMenu();">
                        <div class="menu-icon-circle" style="background-color: #ffebee;">
                            <i class="fa-solid fa-image" style="color: #f44336;"></i>
                        </div>
                        <span class="menu-name">ì•¨ë²”</span>
                    </div>

                    <div class="menu-item" onclick="alert('ì´ë ¥ì„œ ì „ì†¡ ê¸°ëŠ¥')">
                        <div class="menu-icon-circle" style="background-color: #e8f5e9;">
                            <i class="fa-solid fa-address-card" style="color: #4caf50;"></i>
                        </div>
                        <span class="menu-name">ë¬¸ì„œ</span>
                    </div>

                </div>
            </div>
        </div>

        <div id="templateMenu" class="template-menu-overlay" onclick="closeTemplateMenu()">
            <div class="template-box" onclick="event.stopPropagation()">
                <div class="template-header">
                    <span>ìì£¼ ì“°ëŠ” ë©”ì‹œì§€</span>
                    <span class="close-btn" onclick="closeTemplateMenu()">&times;</span>
                </div>
                <div class="template-list">
                    <button onclick="insertText('ì•ˆë…•í•˜ì„¸ìš”, ë©´ì ‘ ì œì•ˆ ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤. :)')">ğŸ“… ë©´ì ‘ ì œì•ˆ</button>
                    <button onclick="insertText('ì´ë ¥ì„œë¥¼ ì¶”ê°€ë¡œ ìš”ì²­ë“œë ¤ë„ ë ê¹Œìš”? :)')">ğŸ“‚ ì´ë ¥ì„œ ìš”ì²­</button>
                    <button onclick="insertText('í•©ê²© í†µë³´ ë“œë¦½ë‹ˆë‹¤. ì¶•í•˜í•©ë‹ˆë‹¤! :)')">ğŸ‰ í•©ê²© í†µë³´</button>
                    <button onclick="insertText('ë„¤, ë©´ì ‘ ì¼ì • í™•ì¸í–ˆìŠµë‹ˆë‹¤. :)')">âœ… ì¼ì • í™•ì¸</button>
                    <button onclick="insertText('ë„ì°©í–ˆìŠµë‹ˆë‹¤. ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”. :)')">ğŸ“ ë„ì°© ì•Œë¦¼</button>
                </div>
            </div>
        </div>

        <script>
            var stompClient = null;
            var roomId = document.getElementById("roomId").value;
            var myId = document.getElementById("myId").value;
            var msgArea = document.getElementById("msgArea");
            var lastChatDate = null;

            connect();

            function connect() {
                var socket = new SockJS('/ws-stomp');
                stompClient = Stomp.over(socket);

                stompClient.connect({}, function (frame) {
                    console.log('Connected: ' + frame);
                    initLastChatDate();
                    stompClient.subscribe('/sub/chat/room/' + roomId, function (messageOutput) {
                        showMessage(JSON.parse(messageOutput.body));
                    });
                    scrollToBottom();
                });
            }

            function sendMessage() {
                var msgInput = document.getElementById("msgInput");
                var messageContent = msgInput.value.trim();

                if (messageContent && stompClient) {
                    var chatMessage = {
                        room: { id: roomId },
                        sender: { userId: myId },
                        content: messageContent,
                        messageType: 'TEXT'
                    };
                    stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));

                    msgInput.value = '';
                    msgInput.style.height = 'auto';
                    msgInput.style.overflowY = 'hidden';
                    msgInput.focus();
                }
            }

            function autoResize(textarea) {
                textarea.style.height = 'auto';
                var maxHeight = 120;
                if (textarea.scrollHeight > maxHeight) {
                    textarea.style.height = maxHeight + 'px';
                    textarea.style.overflowY = 'auto';
                } else {
                    textarea.style.height = textarea.scrollHeight + 'px';
                    textarea.style.overflowY = 'hidden';
                }
            }

            function handleEnter(e) {
                if (e.isComposing || e.keyCode === 229) return;
                if (e.key === 'Enter') {
                    if (!e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                }
            }

            function showMessage(message) {
                var dateObj = message.createdAt ? new Date(message.createdAt) : new Date();
                checkAndAddDateDivider(dateObj);

                var isMe = (message.sender.userId == myId);
                var div = document.createElement('div');
                var timeString = dateObj.getHours().toString().padStart(2, '0') + ':' +
                    dateObj.getMinutes().toString().padStart(2, '0');

                var year = dateObj.getFullYear();
                var month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                var day = dateObj.getDate().toString().padStart(2, '0');
                var dateStr = year + "-" + month + "-" + day;

                var finalContentHtml = "";
                if (message.messageType === 'IMAGE') {
                    finalContentHtml = `<img src="${message.content}" class="chat-image" 
                                        style="max-width: 200px; border-radius: 10px; margin-top: 5px;"
                                        onclick="openImageModal(this.src)">`;
                } else {
                    finalContentHtml = `<div class="msg-bubble">${message.content}</div>`;
                }

                if (isMe) {
                    div.className = "msg-row me";
                    div.setAttribute("data-date", dateStr);
                    div.innerHTML = `
                        <span class="msg-time">${timeString}</span>
                        ${finalContentHtml}
                    `;
                } else {
                    div.className = "msg-row other";
                    div.setAttribute("data-date", dateStr);
                    div.innerHTML = `
                        <img src="/images/dog_profile.jpg" class="profile-img">
                        ${finalContentHtml}
                        <span class="msg-time">${timeString}</span>
                    `;
                }

                msgArea.appendChild(div);
                scrollToBottom();
            }

            function uploadImage() {
                var fileInput = document.getElementById('fileInput');
                var file = fileInput.files[0];
                if (file) {
                    var formData = new FormData();
                    formData.append("file", file);
                    fetch('/chat/upload', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.text())
                        .then(imageUrl => {
                            if (imageUrl.includes("ì‹¤íŒ¨")) {
                                alert("ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨");
                                return;
                            }
                            var chatMessage = {
                                room: { id: roomId },
                                sender: { userId: myId },
                                content: imageUrl,
                                messageType: 'IMAGE'
                            };
                            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
                        });
                    fileInput.value = '';
                }
            }

            function checkAndAddDateDivider(dateObj) {
                var year = dateObj.getFullYear();
                var month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                var day = dateObj.getDate().toString().padStart(2, '0');
                var dateStr = year + "-" + month + "-" + day;
                if (lastChatDate !== dateStr) {
                    var days = ['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'];
                    var dayName = days[dateObj.getDay()];
                    var fullDateText = year + "ë…„ " + parseInt(month) + "ì›” " + parseInt(day) + "ì¼ " + dayName;
                    var dividerDiv = document.createElement('div');
                    dividerDiv.className = "date-divider";
                    dividerDiv.innerHTML = `<span class="date-divider-text">${fullDateText}</span>`;
                    msgArea.appendChild(dividerDiv);
                    lastChatDate = dateStr;
                }
            }
            function initLastChatDate() {
                var rows = document.querySelectorAll('.msg-row');
                if (rows.length > 0) {
                    var lastRow = rows[rows.length - 1];
                    var dateAttr = lastRow.getAttribute('data-date');
                    if (dateAttr) lastChatDate = dateAttr;
                }
            }
            function scrollToBottom() {
                setTimeout(function () {
                    msgArea.scrollTop = msgArea.scrollHeight;
                }, 50);
            }
            function goBackToList() {
                var userId = document.getElementById("myId").value;
                location.href = userId ? '/chat/list?userId=' + userId : '/chat/list';
            }

            function openImageModal(src) {
                var modal = document.getElementById("imageModal");
                var modalImg = document.getElementById("modalImage");
                modal.style.display = "flex";
                modalImg.src = src;
            }

            function closeImageModal() {
                document.getElementById("imageModal").style.display = "none";
            }

            // [ë©”ì¸ ë©”ë‰´] ì—´ê¸°
            function openMainMenu() {
                document.getElementById('mainPlusMenu').style.display = 'flex';
            }

            // [ë©”ì¸ ë©”ë‰´] ë‹«ê¸°
            function closeMainMenu() {
                document.getElementById('mainPlusMenu').style.display = 'none';
            }

            // [ì„œë¸Œ ë©”ë‰´ ì—°ê²°] ë©”ì¸ ë©”ë‰´ ë‹«ìœ¼ë©´ì„œ -> ì›í•˜ëŠ” ê¸°ëŠ¥ ì—´ê¸°
            function openSubMenu(type) {
                closeMainMenu(); // 1ì°¨ ë©”ë‰´ ë‹«ê³ 

                if (type === 'template') {
                    openTemplateMenu(); // ì•„ê¹Œ ë§Œë“  'ìƒìš©êµ¬' ë©”ë‰´ ì—´ê¸°
                }
                // ë‚˜ì¤‘ì— ì—¬ê¸°ì— 'map' ë“± ì¶”ê°€ ê°€ëŠ¥
            }

            // 1. ë©”ë‰´ ì—´ê¸°
            function openTemplateMenu() {
                document.getElementById('templateMenu').style.display = 'flex';
            }

            // 2. ë©”ë‰´ ë‹«ê¸°
            function closeTemplateMenu() {
                document.getElementById('templateMenu').style.display = 'none';
            }

            // 3. [ìˆ˜ì •ë¨] í…ìŠ¤íŠ¸ ì…ë ¥ì°½ì— ê¸€ì ë„£ê¸°
            function insertText(text) {
                // ì§€ì¡´ìš©ì‚¬ë‹˜ì˜ HTML IDì¸ 'msgInput'ì„ ì°¾ë„ë¡ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤!
                const inputField = document.getElementById('msgInput');

                if (inputField) {
                    inputField.value = text; // ê¸€ì ì…ë ¥
                    inputField.focus();      // ì»¤ì„œ ê¹œë¹¡ì„
                    // (ì˜µì…˜) ë†’ì´ ìë™ ì¡°ì ˆ í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ì‹¤í–‰ (ì§€ì¡´ìš©ì‚¬ë‹˜ ì½”ë“œì— autoResizeê°€ ìˆì–´ì„œ ì¶”ê°€í•¨)
                    if (typeof autoResize === 'function') {
                        autoResize(inputField);
                    }
                } else {
                    alert("ì…ë ¥ì°½(msgInput)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                }

                closeTemplateMenu(); // ë©”ë‰´ ë‹«ê¸°
            }
        </script>
</body>

</html>