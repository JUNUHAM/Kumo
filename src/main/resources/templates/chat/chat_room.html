<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/chat_room.css}">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        /* 화면 전체를 꽉 채우고 위아래로 배치 */
        .mobile-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* 화면 전체 높이 사용 */
            overflow: hidden;
            /* 전체 스크롤 방지 */
            background-color: #f5f5f5;
        }

        /* 헤더 고정 */
        .chat-header {
            flex: 0 0 auto;
            /* 크기 고정 */
            z-index: 10;
        }

        /* 메시지 영역: 남은 공간 다 차지 + 스크롤 생성 */
        .msg-area {
            flex: 1;
            /* 남은 공간 모두 차지 */
            overflow-y: auto;
            /* 내용 넘치면 스크롤 */
            padding-bottom: 20px;
        }

        /* 입력창 고정 */
        .input-area {
            flex: 0 0 auto;
            /* 크기 고정 */
            z-index: 10;
            background-color: white;
        }
    </style>
</head>

<body>

    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="myId" th:value="${userId}">

    <div class="mobile-container">

        <div class="chat-header">
            <i class="fa-solid fa-arrow-left header-icon" onclick="goBackToList()"></i>
            <span class="header-title">채팅방 [[${roomId}]]</span>
            <i class="fa-solid fa-bars header-icon"></i>
        </div>

        <div class="msg-area" id="msgArea">
            <th:block th:each="msg : ${history}">
                <div th:classappend="${msg.senderId == userId} ? 'me' : 'other'" class="msg-row">
                    <img th:if="${msg.senderId != userId}" th:src="@{/images/dog_profile.jpg}" class="profile-img">

                    <div style="display: flex; align-items: flex-end;">
                        <span th:if="${msg.senderId == userId}" class="msg-time"
                            th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>

                        <div class="msg-bubble" th:text="${msg.message}">내용</div>

                        <span th:if="${msg.senderId != userId}" class="msg-time"
                            th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>
                    </div>
                </div>
            </th:block>
        </div>

        <div class="input-area">
            <i class="fa-solid fa-plus btn-plus"></i>
            <input type="text" class="input-field" id="msgInput" placeholder="메시지 입력..."
                onkeypress="if(event.keyCode==13) sendMessage()">
            <button class="btn-send" onclick="sendMessage()">전송</button>
        </div>

    </div>

    <script>
        var stompClient = null;
        var roomId = document.getElementById("roomId").value;
        var myId = document.getElementById("myId").value;
        var msgArea = document.getElementById("msgArea");

        // [1] 페이지 열리면 바로 연결 시작
        connect();

        function connect() {
            var socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/sub/chat/room/' + roomId, function (messageOutput) {
                    showMessage(JSON.parse(messageOutput.body));
                });

                // 연결 직후 스크롤 내리기
                scrollToBottom();
            });
        }

        // [2] 메시지 전송 함수
        function sendMessage() {
            var messageContent = document.getElementById("msgInput").value;

            if (messageContent && stompClient) {
                var chatMessage = {
                    roomId: roomId,
                    senderId: myId,
                    message: messageContent,
                    type: 'TALK'
                };

                stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
                document.getElementById("msgInput").value = ''; // 입력창 비우기

                // 전송 후에도 스크롤 내리기
                scrollToBottom();
            }
        }

        // [3] 받은 메시지를 화면에 그리는 함수
        function showMessage(message) {
            var isMe = (message.senderId === myId);

            var div = document.createElement('div');
            div.className = isMe ? "msg-row me" : "msg-row other";

            var html = '';

            if (!isMe) {
                html += '<img src="/images/dog_profile.jpg" class="profile-img">';
                html += '<div><div class="name">' + message.senderId + '</div>';
            }

            html += '<div style="display: flex; align-items: flex-end;">';

            if (isMe) html += '<span class="msg-time">방금</span>';
            html += '<div class="msg-bubble">' + message.message + '</div>';

            if (!isMe) {
                html += '<span class="msg-time">방금</span>';
                html += '</div></div>';
            } else {
                html += '</div>';
            }

            div.innerHTML = html;
            msgArea.appendChild(div);

            // 메시지 추가 후 스크롤 내리기
            scrollToBottom();
        }

        // [4] 스크롤 내리기 함수 (딜레이 0.1초로 안정성 확보)
        function scrollToBottom() {
            setTimeout(function () {
                msgArea.scrollTop = msgArea.scrollHeight;
            }, 100);
        }

        // [5] 리스트로 돌아가기
        function goBackToList() {
            var userId = document.getElementById("myId").value;
            if (userId) {
                location.href = '/chat/list?userId=' + userId;
            } else {
                location.href = '/chat/list';
            }
        }
    </script>

</body>

</html>