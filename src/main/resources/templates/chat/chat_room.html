<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" th:href="@{/css/chat_room.css(v='3.0')}">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body>

    <input type="hidden" id="roomId" th:value="${roomId}">
    <input type="hidden" id="myId" th:value="${userId}">

    <div class="mobile-container">
        <div class="chat-header">

            <i class="fa-solid fa-chevron-left header-back-btn" onclick="goBackToList()"></i>

            <div class="header-translate-btn">
                <img th:src="@{/images/icons/chat_room_translate.svg}" class="translate-icon-img" alt="번역"></img>
            </div>

            <div class="header-center">

                <div class="store-profile-row">
                    <img th:src="@{/images/dog_profile.jpg}" class="header-store-img">
                    <span class="header-store-name">ABCカンパニー</span>
                    <div class="online-dot"></div>
                </div>

                <div class="header-info-row">
                    <span>大阪府大阪市北区中之島</span>
                    <span style="margin-left: 10px;">〒530-0005</span>
                </div>

                <div class="header-salary-row">
                    給料: 200¥
                </div>

            </div>
        </div>

        <div class="msg-area" id="msgArea">
            <th:block th:each="msg, stat : ${history}">

                <th:block
                    th:if="${stat.first} or ${!#strings.equals(#temporals.format(msg.sentAt, 'yyyy-MM-dd'), #temporals.format(history[stat.index-1].sentAt, 'yyyy-MM-dd'))}">
                    <div class="date-divider">
                        <span class="date-divider-text"
                            th:text="${#temporals.format(msg.sentAt, 'yyyy년 M월 d일 EEEE')}"></span>
                    </div>
                </th:block>

                <div th:if="${msg.senderId != userId}" class="msg-row other">
                    <img th:src="@{/images/dog_profile.jpg}" class="profile-img">
                    <div class="msg-bubble" th:text="${msg.message}">내용</div>
                    <span class="msg-time" th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>
                </div>

                <div th:if="${msg.senderId == userId}" class="msg-row me">
                    <span class="msg-time" th:text="${#temporals.format(msg.sentAt, 'HH:mm')}"></span>
                    <div class="msg-bubble" th:text="${msg.message}">내용</div>
                </div>

            </th:block>
        </div>

        <div class="input-area">
            <i class="fa-solid fa-plus btn-plus"></i>

            <img th:src="@{/images/icons/chat_room_images.svg}" class="btn-img-upload" alt="사진첨부">

            <input type="text" class="input-field" id="msgInput" placeholder="메시지 입력..."
                onkeypress="if(event.keyCode==13) sendMessage()">

            <button class="btn-send" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        var stompClient = null;
        var roomId = document.getElementById("roomId").value;
        var myId = document.getElementById("myId").value;
        var msgArea = document.getElementById("msgArea");

        // ★ [핵심] 마지막으로 표시된 날짜를 저장하는 변수
        var lastChatDate = null;

        connect();

        function connect() {
            var socket = new SockJS('/ws-stomp');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // 1. 페이지 로딩 시, 화면에 이미 뿌려진 마지막 날짜가 있다면 가져오기
                // (Thymeleaf로 렌더링된 마지막 날짜 구분선을 찾아서 기준점으로 삼음)
                initLastChatDate();

                stompClient.subscribe('/sub/chat/room/' + roomId, function (messageOutput) {
                    showMessage(JSON.parse(messageOutput.body));
                });
                scrollToBottom();
            });
        }

        function sendMessage() {
            var messageContent = document.getElementById("msgInput").value;
            if (messageContent && stompClient) {
                var chatMessage = {
                    roomId: roomId,
                    senderId: myId,
                    message: messageContent,
                    type: 'TALK'
                    // 주의: 서버에서 sentAt(시간)을 찍어서 보내주는 것이 가장 정확합니다.
                    // 여기서는 일단 보낼 때는 내용만 보냅니다.
                };
                stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
                document.getElementById("msgInput").value = '';
                // 내가 보낸 건 서버 응답(구독)으로 받아서 그릴 것이므로 여기서 그리지 않음 (혹은 최적화 가능)
                // 만약 즉시 그리기(Optimistic UI)를 한다면 여기서 showMessage 호출
            }
        }

        function showMessage(message) {
            // 서버에서 날짜 정보(sentAt)가 오는지 확인 필요. 
            // 만약 없으면 현재 시간(new Date()) 사용
            var dateObj = message.sentAt ? new Date(message.sentAt) : new Date();

            // ★ [핵심] 날짜가 바뀌었는지 확인 ★
            checkAndAddDateDivider(dateObj);

            var isMe = (message.senderId === myId);
            var div = document.createElement('div');

            // 시간 포맷 (오전/오후 빼고 24시간제 HH:mm)
            var timeString = dateObj.getHours().toString().padStart(2, '0') + ':' +
                dateObj.getMinutes().toString().padStart(2, '0');

            if (isMe) {
                div.className = "msg-row me";
                div.innerHTML = `
                    <span class="msg-time">${timeString}</span>
                    <div class="msg-bubble">${message.message}</div>
                `;
            } else {
                div.className = "msg-row other";
                div.innerHTML = `
                    <img src="/images/dog_profile.jpg" class="profile-img">
                    <div class="msg-bubble">${message.message}</div>
                    <span class="msg-time">${timeString}</span>
                `;
            }

            msgArea.appendChild(div);
            scrollToBottom();
        }

        // ★ [함수] 날짜 구분선 추가 로직 ★
        function checkAndAddDateDivider(dateObj) {
            // "YYYY-MM-DD" 문자열 생성
            var year = dateObj.getFullYear();
            var month = dateObj.getMonth() + 1;
            var day = dateObj.getDate();
            var dateStr = year + "-" + month + "-" + day;

            // 마지막 날짜와 다르면 구분선 추가
            if (lastChatDate !== dateStr) {
                var days = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'];
                var dayName = days[dateObj.getDay()];
                var fullDateText = year + "년 " + month + "월 " + day + "일 " + dayName;

                var dividerDiv = document.createElement('div');
                dividerDiv.className = "date-divider";
                dividerDiv.innerHTML = `<span class="date-divider-text">${fullDateText}</span>`;

                msgArea.appendChild(dividerDiv);

                // 마지막 날짜 업데이트
                lastChatDate = dateStr;
            }
        }

        // ★ [함수] 초기 로딩 시 마지막 날짜 인식 ★
        function initLastChatDate() {
            // 화면에 렌더링된 마지막 'date-divider'가 있는지 찾는다.
            // (Thymeleaf가 이미 그렸을 수 있음)
            // 하지만 JS 로직상 가장 확실한 건, 오늘 날짜로 초기화하거나
            // 히스토리의 마지막 메시지 날짜를 읽어오는 것입니다.
            // 여기서는 간단하게 "오늘 처음 채팅하면 오늘 날짜가 뜨도록" null로 시작합니다.
            // 단, 페이지에 이미 날짜선이 있다면 그 날짜를 lastChatDate로 잡는 로직이 필요할 수 있습니다.

            // 간단 구현: 현재 히스토리의 마지막 날짜 구분선을 찾아서 그 날짜를 기억함 (중복 방지)
            // (복잡해질 수 있으니, 실시간 채팅에서는 '오늘' 날짜가 처음 뜨게 놔둬도 무방합니다.)
        }

        function scrollToBottom() {
            setTimeout(function () {
                msgArea.scrollTop = msgArea.scrollHeight;
            }, 50);
        }

        function goBackToList() {
            var userId = document.getElementById("myId").value;
            location.href = userId ? '/chat/list?userId=' + userId : '/chat/list';
        }
    </script>
</body>

</html>