<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<div th:fragment="headerFragment">

    <header class="authenticated-header">
        <link rel="stylesheet" th:href="@{/css/AuthenticatedFragments/AuthenticatedHeader.css}"
              sec:authorize="isAuthenticated()">

        <div class="sidebar-logo">
            <a th:href="@{/}" class="logo">
                <img th:src="@{/images/NonLogin/seekerLogo.png}" alt="KUMO" style="height: 40px;">
            </a>
        </div>

        <nav>
            <ul class="nav-menu">
                <li><a th:href="@{/info}" th:text="#{header.company}">회사 정보</a></li>

                <li class="icon-btn notification-container" id="notifyBtn">
                    <i class="fa-regular fa-bell"></i>
                    <span class="notify-badge" style="display: none;">0</span>

                    <div class="notify-dropdown" id="notifyMenu">
                        <div class="notify-header">
                            <span th:text="#{header.notifications}">알림</span>
                            <div class="header-buttons">
                                <button class="header-btn read-all" id="markAllReadBtn" th:text="#{header.mark_read}">모두 읽음</button>
                                <span class="divider">|</span>
                                <button class="header-btn delete-all" id="deleteAllBtn" th:text="#{header.delete_all}">전체 삭제</button>
                            </div>
                        </div>

                        <div class="notify-body" id="notifyList">
                            <div class="notify-empty" id="notifyEmpty" style="display: none;">
                                <i class="fa-regular fa-bell-slash"></i>
                                <p th:text="#{notification.empty}">새로운 알림이 없습니다.</p>
                            </div>
                        </div>

                        <div class="notify-footer" id="expandBtn"
                             th:data-more="#{notification.more}"
                             th:data-fold="#{notification.fold}">
                            <span th:text="#{notification.more}">더 보기</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                    </div>
                </li>

                <li class="icon-btn lang-container" id="langBtn">
                    <i class="fa-solid fa-globe"></i>
                    <div class="lang-dropdown" id="langMenu">
                        <a href="javascript:changeLang('ko')" class="lang-item">한국어</a>
                        <a href="javascript:changeLang('ja')" class="lang-item">日本語</a>
                    </div>
                </li>

                <li class="icon-btn" id="darkModeBtn">
                    <i class="fa-regular fa-sun" id="darkModeIcon"></i>
                </li>

                <li class="profile-container" id="profileBtn">
                    <img th:src="${profileImageUrl ?: '/images/common/default_profile.png'}"
                         class="user-avatar" alt="Profile">

                    <div class="profile-dropdown" id="profileMenu">
                        <div class="profile-info">
                            <span class="user-name" th:text="${#authentication.principal.nickname}">User</span>
                            <span class="user-email" th:text="${#authentication.name}">email@test.com</span>
                        </div>
                        <hr>
                        <a th:href="@{/Seeker/MyPage}" class="profile-item">
                            <i class="fa-regular fa-user"></i>
                            <span th:text="#{profile.mypage}">마이페이지</span>
                        </a>
                        <a th:href="@{/resume}" class="profile-item">
                            <i class="fa-regular fa-file-lines"></i>
                            <span th:text="#{profile.resume}">내 이력서</span>
                        </a>
                        <a th:href="@{/history}" class="profile-item">
                            <i class="fa-regular fa-bell"></i>
                            <span th:text="#{profile.history}">지원 내역 확인</span>
                        </a>
                        <a th:href="@{/settings}" class="profile-item">
                            <i class="fa-solid fa-gear"></i>
                            <span th:text="#{profile.settings}">설정</span>
                        </a>
                        <hr>
                        <a th:href="@{/logout}" class="profile-item logout">
                            <i class="fa-solid fa-right-from-bracket"></i>
                            <span th:text="#{profile.logout}">로그아웃</span>
                        </a>
                    </div>
                </li>
            </ul>
        </nav>
    </header>

    <script th:inline="javascript">
        /* <![CDATA[ */
        (function() {
            if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

            // [1] 깜빡임 방지 (즉시 실행)
            document.write('<style id="prevent-load-transition">body { transition: none !important; }</style>');
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                const root = document.documentElement;
                root.classList.add('dark-mode');
                root.style.cssText = 'background-color: #121212 !important; color: #FFFFFF !important;';
                document.write(`
                  <style id="page-transition-style">
                    html, body { background-color: #121212 !important; opacity: 0 !important; visibility: hidden !important; }
                  </style>
                `);
            }
        })();

        document.addEventListener("DOMContentLoaded", function() {
            /* ==============================
               1. 다크모드 초기화 및 애니메이션 복구
               ============================== */
            const body = document.body;
            const html = document.documentElement;
            const theme = localStorage.getItem('theme');
            const toggleBtn = document.getElementById('darkModeBtn');
            const icon = document.getElementById('darkModeIcon');

            if (theme === 'dark') {
                body.classList.add('dark-mode');
                if(icon) {
                    icon.classList.replace('fa-sun', 'fa-moon');
                    icon.classList.replace('fa-regular', 'fa-solid');
                }
            }

            requestAnimationFrame(() => {
                window.scrollTo(0, 0);
                body.style.opacity = '1';
                body.style.visibility = 'visible';

                setTimeout(() => {
                    const styleTag = document.getElementById('page-transition-style');
                    if (styleTag) styleTag.remove();
                }, 50);

                setTimeout(() => {
                    const preventTransition = document.getElementById('prevent-load-transition');
                    if (preventTransition) preventTransition.remove();
                }, 400);
            });

            // 다크모드 토글 이벤트
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const isDark = body.classList.toggle('dark-mode');
                    html.classList.toggle('dark-mode');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');

                    if(icon) {
                        if (isDark) {
                            icon.classList.replace('fa-sun', 'fa-moon');
                            icon.classList.replace('fa-regular', 'fa-solid');
                        } else {
                            icon.classList.replace('fa-moon', 'fa-sun');
                            icon.classList.replace('fa-solid', 'fa-regular');
                        }
                    }

                    if (!isDark) html.style.cssText = '';
                });
            }

            /* ==============================
               2. 드롭다운 통합 관리
               ============================== */
            const dropdownConfigs = [
                { btnId: 'langBtn', menuId: 'langMenu' },
                { btnId: 'profileBtn', menuId: 'profileMenu' },
                { btnId: 'notifyBtn', menuId: 'notifyMenu' }
            ];

            dropdownConfigs.forEach(config => {
                const btn = document.getElementById(config.btnId);
                const menu = document.getElementById(config.menuId);

                if (btn && menu) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const isAlreadyOpen = menu.classList.contains('show');

                        document.querySelectorAll('.notify-dropdown, .lang-dropdown, .profile-dropdown')
                                .forEach(m => m.classList.remove('show'));

                        if (!isAlreadyOpen) {
                            menu.classList.add('show');
                            if (config.btnId === 'notifyBtn') loadNotifications();
                        }
                    });
                }
            });

            document.addEventListener('click', () => {
                document.querySelectorAll('.notify-dropdown, .lang-dropdown, .profile-dropdown')
                        .forEach(m => m.classList.remove('show'));
            });

            document.querySelectorAll('.notify-dropdown, .lang-dropdown, .profile-dropdown')
                    .forEach(menu => menu.addEventListener('click', (e) => e.stopPropagation()));

            /* ==============================
               3. 알림 시스템 로직
               ============================== */
            const notifyList = document.getElementById('notifyList');
            const notifyBadge = document.querySelector('.notify-badge');
            const expandBtn = document.getElementById('expandBtn');
            const markAllReadBtn = document.getElementById('markAllReadBtn');
            const deleteAllBtn = document.getElementById('deleteAllBtn');

            // "알림 없음" 요소 백업
            let emptyTemplate = null;
            const originalEmpty = document.getElementById('notifyEmpty');
            if (originalEmpty) emptyTemplate = originalEmpty.cloneNode(true);

            updateBadgeCount();

            // [3-1] 더 보기 버튼
            if (expandBtn) {
                expandBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notifyList.classList.toggle('expanded');
                    const span = this.querySelector('span');
                    const icon = this.querySelector('i');
                    const moreTxt = this.getAttribute('data-more') || "더 보기";
                    const foldTxt = this.getAttribute('data-fold') || "접기";

                    if (notifyList.classList.contains('expanded')) {
                        if(span) span.innerText = foldTxt;
                        if(icon) icon.className = 'fa-solid fa-chevron-up';
                    } else {
                        if(span) span.innerText = moreTxt;
                        if(icon) icon.className = 'fa-solid fa-chevron-down';
                    }
                });
            }

            // [3-2] 모두 읽음
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', () => {
                    fetch('/api/notifications/read-all', { method: 'PATCH' })
                        .then(res => {
                            if (res.ok) {
                                document.querySelectorAll('.notify-item.unread').forEach(item => item.classList.remove('unread'));
                                updateBadgeCount();
                            }
                        });
                });
            }

            // [3-3] 전체 삭제
            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', () => {
                    if(!confirm("모든 알림을 삭제하시겠습니까?")) return;
                    fetch('/api/notifications', { method: 'DELETE' })
                        .then(res => {
                            if (res.ok) {
                                renderEmptyState();
                                updateBadgeCount();
                            }
                        });
                });
            }

            // [3-4] 알림 로드
            function loadNotifications() {
                fetch('/api/notifications')
                    .then(res => res.json())
                    .then(data => {
                        notifyList.innerHTML = '';
                        if (!data || data.length === 0) {
                            renderEmptyState();
                        } else {
                            data.forEach(n => notifyList.insertAdjacentHTML('beforeend', createNotificationHTML(n)));
                        }
                        updateBadgeCount();
                    })
                    .catch(err => console.error("알림 로드 실패:", err));
            }

            function renderEmptyState() {
                notifyList.innerHTML = '';
                if (emptyTemplate) {
                    const emptyClone = emptyTemplate.cloneNode(true);
                    emptyClone.style.display = 'flex';
                    notifyList.appendChild(emptyClone);
                }
            }

            function createNotificationHTML(notif) {
                const isRead = notif.read || notif.isRead;
                const readClass = isRead ? '' : 'unread';
                const timeStr = timeAgo(notif.createdAt);
                return `
                    <div class="notify-item ${readClass}" onclick="readAndGo('${notif.targetUrl}', ${notif.notificationId}, this)">
                        <div class="notify-icon"><i class="fa-solid fa-bell"></i></div>
                        <div class="notify-content">
                            <p class="notify-text"><strong>${notif.title}</strong><br>${notif.content}</p>
                            <span class="notify-time">${timeStr}</span>
                        </div>
                        <i class="fa-solid fa-xmark delete-btn" onclick="deleteNotification(event, ${notif.notificationId}, this)"></i>
                    </div>`;
            }

            function updateBadgeCount() {
                fetch('/api/notifications/unread-count')
                    .then(res => res.json())
                    .then(count => {
                        if (count > 0) {
                            notifyBadge.style.display = 'flex';
                            notifyBadge.innerText = count > 99 ? '99+' : count;
                        } else {
                            notifyBadge.style.display = 'none';
                        }
                    })
                    .catch(() => { notifyBadge.style.display = 'none'; });
            }

            window.refreshBadge = updateBadgeCount;
        });

        /* ==============================
           4. 전역 유틸리티 함수
           ============================== */
        window.changeLang = function(lang) {
            const url = new URL(window.location.href);
            url.searchParams.set('lang', lang);
            window.location.href = url.toString();
        };

        window.deleteNotification = function(event, id, btn) {
            event.stopPropagation();
            fetch(`/api/notifications/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        const item = btn.closest('.notify-item');
                        item.remove();
                        if (document.getElementById('notifyList').querySelectorAll('.notify-item').length === 0) {
                             if (window.refreshBadge) window.refreshBadge();
                        }
                        window.refreshBadge();
                    }
                });
        };

        window.readAndGo = function(url, id, el) {
            if (!el.classList.contains('unread')) { location.href = url; return; }
            fetch(`/api/notifications/${id}/read`, { method: 'PATCH' })
                .then(() => location.href = url)
                .catch(() => location.href = url);
        };

        window.timeAgo = function(dateString) {
            if (!dateString) return "";
            const diff = Math.floor((new Date() - new Date(dateString)) / 1000);

            // 언어 감지 로직 강화
            const headerTitle = document.querySelector('.notify-header span');
            const isTextJA = headerTitle && headerTitle.innerText.trim() === '通知';
            const isJA = document.documentElement.lang === 'ja' || location.href.includes('lang=ja') || isTextJA;

            const i18n = isJA
                ? { now: "今", min: "分前", hr: "時間前", day: "日前" }
                : { now: "방금 전", min: "분 전", hr: "시간 전", day: "일 전" };

            if (diff < 60) return i18n.now;
            if (diff < 3600) return Math.floor(diff / 60) + i18n.min;
            if (diff < 86400) return Math.floor(diff / 3600) + i18n.hr;
            return Math.floor(diff / 86400) + i18n.day;
        };
        /* ]]> */
    </script>
</div>
</html>