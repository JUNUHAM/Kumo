<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${job.title}">상세 정보</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/NonLoginFooter.css}">
    <link rel="stylesheet" th:href="@{/css/job_detail.css}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
</head>
<body>

<header th:replace="~{header.html}"></header>

<div class="container">
    <div class="header-section">
        <h1 class="job-title" th:text="${job.title}">구인 제목</h1>
        <div class="job-meta">
            <span th:text="${job.address} + ' • ' + (${lang == 'jp' ? '住所' : '주소'})">주소</span>
            <span>•</span>
            <span>ID: <span th:text="${job.id}">0</span></span>
        </div>
    </div>

    <div class="info-grid">
        <div class="info-item">
            <span class="info-label" th:text="${lang == 'jp' ? '会社名' : '회사 이름'}">회사 이름</span>
            <span class="info-value" th:text="${job.companyName}">-</span>
        </div>

        <div class="info-item text-right">
            <span class="info-label" th:text="${lang == 'jp' ? '職種' : '업무'}">업무</span>
            <span class="info-value" th:text="${job.position ?: '-'}">-</span>
        </div>

        <div class="info-item">
            <span class="info-label" th:text="${lang == 'jp' ? '給与' : '급여'}">급여</span>
            <span class="info-value" th:text="${job.wage}">-</span>
        </div>

        <div class="info-item text-right">
            <span class="info-label" th:text="${lang == 'jp' ? '仕事内容' : '업무 상세'}">업무 상세</span>
            <span class="info-value" th:text="${job.jobDescription ?: '-'}">-</span>
        </div>

        <div class="info-item">
            <span class="info-label" th:text="${lang == 'jp' ? '連絡先' : '연락처'}">연락처</span>
            <span class="info-value" th:text="${job.contactPhone}">-</span>
        </div>
        <div class="info-item text-right">
            <span class="info-label" th:text="${lang == 'jp' ? '会社住所' : '회사 주소'}">회사 주소</span>
            <span class="info-value" th:text="${job.address}">-</span>
        </div>
    </div>

    <div class="map-section" th:if="${job.lat != null}">
        <iframe
                width="100%"
                height="100%"
                frameborder="0" style="border:0"
                th:src="'https://maps.google.com/maps?q=' + ${job.lat} + ',' + ${job.lng} + '&z=15&output=embed'"
                allowfullscreen="true">
        </iframe>
    </div>

    <div class="map-section" th:unless="${job.lat != null}"
         style="display:flex; align-items:center; justify-content:center; color:#999;"
         th:text="${lang == 'jp' ? '地図情報がありません。' : '지도 정보가 없는 공고입니다.'}">
        지도 정보가 없는 공고입니다.
    </div>

    <div class="description-section">
        <h3 class="section-title" th:text="${lang == 'jp' ? '詳細情報' : '상세정보'}">상세정보</h3>
        <div class="description-text" th:text="${job.body}">
            내용이 없습니다.
        </div>
    </div>

    <div class="image-gallery" th:if="${job.imgUrls != null}">
        <th:block th:each="img : ${#strings.arraySplit(job.imgUrls, ',')}">
            <img th:src="${img}" class="gallery-img" alt="상세 이미지" />
        </th:block>
    </div>
</div>

<div class="fixed-bottom-bar" th:if="${isOwner}">
    <div class="btn-group-owner">
        <button class="btn-action btn-edit"
                th:data-msg="${lang == 'jp' ? '修正ページへ移動' : '수정 페이지로 이동'}"
                onclick="alert(this.getAttribute('data-msg'))"
                th:text="${lang == 'jp' ? '修正' : '공고 수정'}">
            공고 수정
        </button>

        <button class="btn-action btn-delete"
                th:data-msg="${lang == 'jp' ? '削除API呼び出し' : '삭제 API 호출'}"
                onclick="alert(this.getAttribute('data-msg'))"
                th:text="${lang == 'jp' ? '削除' : '삭제'}">
            삭제
        </button>
    </div>
</div>

<div class="fixed-bottom-bar" th:unless="${isOwner}">
    <div class="btn-group-seeker">

        <button class="btn-action btn-apply"
                th:data-id="${job.id}"
                th:data-source="${job.source}"
                th:text="${lang == 'jp' ? '応募する' : '구인 신청'}"
                onclick="applyForJob(this)">
            구인 신청
        </button>

        <div class="icon-actions">
            <button class="btn-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
            </button>

            <button class="btn-icon" onclick="openReportModal()">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="17" width="20" height="4" rx="1" />
                    <path d="M6 17v-4a6 6 0 1 1 12 0v4" />
                    <line x1="12" y1="2" x2="12" y2="4" />
                </svg>
            </button>

            <button class="btn-icon" onclick="history.back()">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>
</div>

<div id="reportModal" class="modal-overlay" style="display: none;">
    <div class="modal-window">
        <div class="modal-header">
            <h3>신고하기</h3>
            <button class="btn-close-modal" onclick="closeReportModal()">×</button>
        </div>

        <div class="modal-body">
            <div class="form-group">
                <label>글 제목</label>
                <input type="text" class="modal-input" th:value="${job.title}" readonly>
            </div>

            <div class="form-group">
                <label>종류</label>
                <select class="modal-select" id="reportType">
                    <option value="">선택해주세요</option>
                    <option value="spam">스팸 / 부적절한 홍보</option>
                    <option value="false_info">허위 공고</option>
                    <option value="abuse">욕설 / 비하 발언</option>
                    <option value="other">기타</option>
                </select>
            </div>

            <div class="form-group">
                <label>상세내용</label>
                <textarea class="modal-textarea" id="reportDetail" placeholder="신고 사유를 상세히 입력해주세요."></textarea>
            </div>

            <div class="modal-footer">
                <button class="btn-submit-report" onclick="submitReport()">신고하기</button>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{NonLoginFooter.html}"></footer>
</body>

<script>
    // --- 신고 모달 관련 스크립트 ---

    // 1. 모달 열기
    function openReportModal() {
        document.getElementById('reportModal').style.display = 'flex';
        // 모달 열 때 스크롤 막기 (선택사항)
        document.body.style.overflow = 'hidden';
    }

    // 2. 모달 닫기
    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
        // 스크롤 다시 허용
        document.body.style.overflow = 'auto';

        // 입력값 초기화 (선택사항)
        document.getElementById('reportType').value = "";
        document.getElementById('reportDetail').value = "";
    }

    // 3. 신고 제출 (경고 -> 접수)
    function submitReport() {
        // 유효성 검사 (종류 선택 안했으면 경고)
        const type = document.getElementById('reportType').value;
        if (!type) {
            alert("신고 종류를 선택해주세요.");
            return;
        }

        // 경고창(Confirm) 띄우기
        if (confirm("정말로 이 게시글을 신고하시겠습니까?\n허위 신고 시 불이익을 받을 수 있습니다.")) {

            // db 완성시 여기에 서버로 전송하는 코드 작성

            // 접수 완료 알림
            alert("신고가 정상적으로 접수되었습니다.");

            // 모달 닫기
            closeReportModal();
        }
    }

    // --- 구인 신청 관련 로직 ---

    // 테스트용 변수: 로그인 여부 (true = 구직자 로그인 상태, false = 비로그인 상태)
    // 로그인 기능 구현될 시 session으로 대체
    const isUserLoggedIn = true;

    // 현재 언어 설정 가져오기 (jp, kr)
    const urlParams = new URLSearchParams(window.location.search);
    const currentLang = urlParams.get('lang') === 'jp' ? 'jp' : 'kr';

    // 메시지 상수 정의
    const MESSAGES = {
        loginRequired: currentLang === 'jp' ? 'ログインが必要です。\nログインページに移動しますか？' : '로그인이 필요한 서비스입니다.\n로그인 페이지로 이동하시겠습니까?',
        confirmApply: currentLang === 'jp' ? 'この求人に応募しますか？' : '이 공고에 지원하시겠습니까?',
        applySuccess: currentLang === 'jp' ? '応募が完了しました！' : '구인 신청이 완료되었습니다!',
        applyError: currentLang === 'jp' ? 'エラーが発生しました。' : '신청 중 오류가 발생했습니다.'
    };

    function applyForJob(btnElement) {
        // 1. 공고 정보 가져오기 (HTML 태그의 data 속성에서 읽음)
        const jobId = btnElement.getAttribute('data-id');
        const jobSource = btnElement.getAttribute('data-source');

        // 2. 로그인 체크
        // 지금은 단순 boolean 변수로 구분. 나중에 session으로 판단
        if (!isUserLoggedIn) {
            if (confirm(MESSAGES.loginRequired)) {
                // 로그인 페이지로 이동
                location.href = '/login';
            }
            return;
        }

        // 3. 지원 확인
        if (!confirm(MESSAGES.confirmApply)) {
            return;
        }

        // 4. 서버로 데이터 전송
        // 임시 fetch 코드 작성 (DB 완성될 경우 실제 기능 구현)
        const requestData = {
            jobId: jobId,
            source: jobSource,
            // applicantId: 'user123' // (필요시) 현재 로그인한 유저 ID
        };

        // --- [백엔드 연결 준비 코드] ---
        /*
        fetch('/api/applications/apply', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (response.ok) {
                alert(MESSAGES.applySuccess);
                // 버튼 비활성화 등의 후처리
                btnElement.disabled = true;
                btnElement.innerText = currentLang === 'jp' ? '応募済み' : '지원 완료';
            } else {
                alert(MESSAGES.applyError);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(MESSAGES.applyError);
        });
        */

        // ★ [임시] 백엔드 없이 성공하는 척 시뮬레이션
        console.log("서버로 전송할 데이터:", requestData);
        setTimeout(() => {
            alert(MESSAGES.applySuccess);
            btnElement.disabled = true;
            btnElement.innerText = currentLang === 'jp' ? '応募済み' : '지원 완료';
            btnElement.style.backgroundColor = '#ccc'; // 회색으로 변경
        }, 500);
    }
</script>

</html>