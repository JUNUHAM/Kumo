<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>KUMO Admin - Users</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_user.css}">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_sidebar.css}">

    <style>
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px;
            width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: #343a40; font-size: 18px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #495057; }
        .form-group select { width: 100%; height: 42px; border-radius: 6px; border: 1px solid #ced4da; padding: 0 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
    </style>
</head>
<body>

<aside th:replace="~{adminView/admin_sidebar :: admin_sidebar('users', ${lang})}"></aside>

<main class="main-content">

    <div class="stats-container">
        <div class="stat-card">
            <span class="stat-value" id="totalUsers">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'å…¨ä¼šå“¡' : 'ì „ì²´ íšŒì›'}">ì „ì²´ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="newUsers">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'æ–°è¦ä¼šå“¡' : 'ì‹ ê·œ íšŒì›'}">ì‹ ê·œ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="activeUsers" style="color: #0ca678;">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'æ´»å‹•ä¸­' : 'í™œë™ íšŒì›'}">í™œë™ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="inactiveUsers" style="color: #868e96;">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'éæ´»æ€§' : 'ë¹„í™œì„± íšŒì›'}">ë¹„í™œì„± íšŒì›</span>
        </div>
    </div>

    <form action="/admin/user" method="get" class="top-controls">
        <input type="hidden" name="lang" th:value="${lang}">

        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" name="keyword" class="search-input" th:value="${keyword}"
                   th:placeholder="${lang == 'ja' ? 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€åå‰ã§æ¤œç´¢' : 'ë‹‰ë„¤ì„, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰'}">
        </div>

        <select name="role" class="filter-select">
            <option value="" th:text="${lang == 'ja' ? 'å…¨æ¨©é™' : 'ëª¨ë“  ê¶Œí•œ'}">Role</option>
            <option value="SEEKER" th:selected="${role == 'SEEKER'}">Seeker</option>
            <option value="RECRUITER" th:selected="${role == 'RECRUITER'}">Recruiter</option>
            <option value="ADMIN" th:selected="${role == 'ADMIN'}">Admin</option>
        </select>

        <select name="status" class="filter-select">
            <option value="" th:text="${lang == 'ja' ? 'å…¨çŠ¶æ…‹' : 'ëª¨ë“  ìƒíƒœ'}">Status</option>
            <option value="ACTIVE" th:selected="${status == 'ACTIVE'}">Active</option>
            <option value="INACTIVE" th:selected="${status == 'INACTIVE'}">Inactive</option>
        </select>

        <button type="submit" class="btn-dark" th:text="${lang == 'ja' ? 'æ¤œç´¢' : 'ê²€ìƒ‰'}">Search</button>
    </form>

    <div class="table-container">
        <table class="custom-table">
            <thead>
            <tr>
                <th style="width: 40px; text-align: center;"><input type="checkbox" id="checkAll"></th>
                <th style="text-align: left;" th:text="${lang == 'ja' ? 'ä¼šå“¡æƒ…å ±' : 'íšŒì› ì •ë³´'}">User Info</th>
                <th style="text-align: center;" th:text="${lang == 'ja' ? 'æ¨©é™' : 'ê¶Œí•œ'}">Role</th>
                <th style="text-align: center;" th:text="${lang == 'ja' ? 'çŠ¶æ…‹' : 'ìƒíƒœ'}">Status</th>
                <th style="text-align: center;" th:text="${lang == 'ja' ? 'åŠ å…¥æ—¥' : 'ê°€ì…ì¼'}">Joined</th>
                <th style="text-align: center;" th:text="${lang == 'ja' ? 'æœ€çµ‚æ´»å‹•' : 'ìµœê·¼ ë¡œê·¸ì¸'}">Last Active</th>
                <th style="text-align: center;" th:text="${lang == 'ja' ? 'ç®¡ç†' : 'ê´€ë¦¬'}">Action</th>
            </tr>
            </thead>
            <tbody>

            <tr th:if="${users.totalElements == 0}">
                <td colspan="7" style="text-align: center; padding: 50px; color: #999;">
                    <span th:text="${lang == 'ja' ? 'ä¼šå“¡ãŒã„ã¾ã›ã‚“ã€‚' : 'íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.'}">No Data</span>
                </td>
            </tr>

            <tr th:each="u : ${users.content}">
                <td style="text-align: center;"><input type="checkbox" name="userIds" th:value="${u.id}"></td>
                <td>
                    <div class="user-profile">
	                    <img th:src="@{${u.profileImage?.fileUrl ?: '/uploads/default_profile.png'}}"
	                         class="avatar-img" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
	                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-circle" style="display:none;"
                             th:text="${#strings.substring(u.nickname, 0, 1)}">K</div>

                        <div class="user-info">
                            <span class="user-name" th:text="${u.nickname}">Nickname</span>
                            <span class="user-email" th:text="${u.email}">Email</span>
                        </div>
                    </div>
                </td>
                <td style="text-align: center;"><span style="font-weight: 600; color: #555;" th:text="${u.role}">ROLE</span></td>
                <td style="text-align: center;">
                    <span class="badge"
                          th:classappend="${u.status == 'ACTIVE' ? 'badge-active' : 'badge-inactive'}"
                          th:text="${u.status}">STATUS</span>
                </td>
                <td style="text-align: center;" th:text="${u.joinedAt}">Date</td>
                <td style="text-align: center;" th:text="${u.lastActive}">Date</td>

                <td style="text-align: center;">
                    <button class="btn-icon" title="Edit"
                            th:onclick="openEditModal([[${u.id}]], [[${u.role}]], [[${u.status}]])">âœï¸</button>
                    <button class="btn-icon" title="Delete" th:onclick="deleteUser([[${u.id}]])">ğŸ—‘ï¸</button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="pagination-container" th:if="${users.totalElements > 0}">
            <ul class="pagination">
                <li th:classappend="${users.first} ? 'disabled'">
                    <a th:href="@{/admin/user(page=0, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&laquo;&laquo;</a>
                </li>
                <li th:classappend="${users.first} ? 'disabled'">
                    <a th:href="@{/admin/user(page=${users.number - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&lsaquo;</a>
                </li>
                <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                    th:classappend="${pageNum == users.number + 1} ? 'active'">
                    <a th:href="@{/admin/user(page=${pageNum - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                       th:text="${pageNum}">1</a>
                </li>
                <li th:classappend="${users.last} ? 'disabled'">
                    <a th:href="@{/admin/user(page=${users.number + 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&rsaquo;</a>
                </li>
                <li th:classappend="${users.last} ? 'disabled'">
                    <a th:href="@{/admin/user(page=${totalPages - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&raquo;&raquo;</a>
                </li>
            </ul>
        </div>
    </div>

</main>

<div id="editModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 th:text="${lang == 'ja' ? 'ä¼šå“¡æƒ…å ±ä¿®æ­£' : 'íšŒì› ì •ë³´ ìˆ˜ì •'}">íšŒì› ì •ë³´ ìˆ˜ì •</h3>

        <input type="hidden" id="editUserId">

        <div class="form-group">
            <label th:text="${lang == 'ja' ? 'æ¨©é™å¤‰æ›´' : 'ê¶Œí•œ ë³€ê²½'}">ê¶Œí•œ ë³€ê²½</label>
            <select id="editRole">
                <option value="SEEKER">Seeker</option>
                <option value="RECRUITER">Recruiter</option>
                <option value="ADMIN">Admin</option>
            </select>
        </div>

        <div class="form-group">
            <label th:text="${lang == 'ja' ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ (ãƒ­ãƒƒã‚¯è¨­å®š)' : 'ê³„ì • ìƒíƒœ (ì ê¸ˆ ì„¤ì •)'}">ê³„ì • ìƒíƒœ</label>
            <select id="editStatus">
                <option value="ACTIVE" th:text="${lang == 'ja' ? 'æ´»æ€§åŒ–' : 'í™œì„±í™”'}">í™œì„±í™”</option>
                <option value="INACTIVE" th:text="${lang == 'ja' ? 'ãƒ­ãƒƒã‚¯ (éæ´»æ€§)' : 'ê³„ì • ì ê¸ˆ'}">ê³„ì • ì ê¸ˆ</option>
            </select>
        </div>

        <div class="modal-actions">
            <button class="btn-outline" onclick="closeEditModal()" th:text="${lang == 'ja' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : 'ì·¨ì†Œ'}">ì·¨ì†Œ</button>
            <button class="btn-dark" onclick="submitEdit()" th:text="${lang == 'ja' ? 'ç¢ºèª' : 'í™•ì¸'}">í™•ì¸</button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const currentLang = [[${lang}]] || 'ko';

    // [ì¶”ê°€] ì‚¬ì´ë“œë°” ì–¸ì–´ ë³€ê²½ í•¨ìˆ˜
    function changeLanguage(lang) {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        // ê²€ìƒ‰ í•„í„°ë‚˜ í˜ì´ì§€ë„¤ì´ì…˜ íŒŒë¼ë¯¸í„°ë¥¼ ìœ ì§€í•œ ì±„ë¡œ ì–¸ì–´ë§Œ ë³€ê²½í•©ë‹ˆë‹¤.
        window.location.href = url.toString();
    }

    // í†µê³„ í˜¸ì¶œ í•¨ìˆ˜
    async function fetchUserStats() {
        try {
            const response = await fetch('/admin/user/stats');
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();

            document.getElementById('totalUsers').innerText = data.totalUsers.toLocaleString();
            document.getElementById('newUsers').innerText = data.newUsers.toLocaleString();
            document.getElementById('activeUsers').innerText = data.activeUsers.toLocaleString();
            document.getElementById('inactiveUsers').innerText = data.inactiveUsers.toLocaleString();
        } catch (error) {
            console.error("í†µê³„ ë¡œë”© ì‹¤íŒ¨:", error);
        }
    }

    // [ì¶”ê°€] ëª¨ë‹¬ì°½ ì—´ê¸°
    function openEditModal(id, currentRole, currentStatus) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editRole').value = currentRole;
        document.getElementById('editStatus').value = currentStatus;
        document.getElementById('editModal').style.display = 'flex';
    }

    // [ì¶”ê°€] ëª¨ë‹¬ì°½ ë‹«ê¸°
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchUserStats();

        // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        const checkAll = document.getElementById('checkAll');
        if(checkAll){
            checkAll.addEventListener('change', function() {
                document.querySelectorAll('input[name="userIds"]').forEach(cb => cb.checked = this.checked);
            });
        }
    });

    function submitEdit() {
        const userId = document.getElementById('editUserId').value;
        const newRole = document.getElementById('editRole').value;
        const newStatus = document.getElementById('editStatus').value;

        const msg = currentLang === 'ja' ? "ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ" : "ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        if(confirm(msg)) {
            // 1. ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„° ë¬¶ê¸°
            const payload = {
                userId: userId,
                role: newRole,
                status: newStatus
            };

            // 2. Fetch APIë¡œ POST ìš”ì²­ ì „ì†¡
            fetch('/admin/user/edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
                .then(response => {
                    if(response.ok) {
                        alert(currentLang === 'ja' ? "ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚" : "ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        closeEditModal();
                        location.reload(); // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ëœ ë°ì´í„° í‘œì‹œ
                    } else {
                        alert(currentLang === 'ja' ? "ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" : "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Network Error");
                });
        }
    }

    // [ìˆ˜ì • ì™„ë£Œ] íšŒì› ì‚­ì œ í•¨ìˆ˜ (ì„œë²„ë¡œ ì‚­ì œ ìš”ì²­)
    function deleteUser(id) {
        if(confirm(currentLang === 'ja' ? "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" : "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {

            fetch('/admin/user/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ userId: id })
            })
                .then(response => {
                    if(response.ok) {
                        alert(currentLang === 'ja' ? "å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚" : "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        location.reload(); // ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨
                    } else {
                        alert(currentLang === 'ja' ? "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" : "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ê´€ë ¨ ë°ì´í„°ê°€ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("Network Error");
                });
        }
    }
</script>

</body>
</html>