<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>KUMO Admin - Users</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_user.css}">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_sidebar.css}">

    <style>
        /* ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px;
            width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: #343a40; font-size: 18px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #495057; }
        .form-group select { width: 100%; height: 42px; border-radius: 6px; border: 1px solid #ced4da; padding: 0 10px; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
    </style>
</head>
<body>

<aside th:replace="~{adminView/admin_sidebar :: admin_sidebar('users', ${lang})}"></aside>

<main class="main-content">

    <div class="stats-container">
        <div class="stat-card">
            <span class="stat-value" id="totalUsers">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'å…¨ä¼šå“¡' : 'ì „ì²´ íšŒì›'}">ì „ì²´ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="newUsers">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'æ–°è¦ä¼šå“¡' : 'ì‹ ê·œ íšŒì›'}">ì‹ ê·œ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="activeUsers" style="color: #0ca678;">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'æ´»å‹•ä¸­' : 'í™œë™ íšŒì›'}">í™œë™ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="inactiveUsers" style="color: #868e96;">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'éæ´»æ€§' : 'ë¹„í™œì„± íšŒì›'}">ë¹„í™œì„± íšŒì›</span>
        </div>
    </div>

    <div class="tab-menu">
        <div id="tab-btn-all" class="tab-item active" onclick="switchTab('all')"
             th:text="${lang == 'ja' ? 'å…¨ä¼šå“¡ç®¡ç†' : 'ì „ì²´ íšŒì› ê´€ë¦¬'}">ì „ì²´ íšŒì› ê´€ë¦¬</div>
        <div id="tab-btn-approval" class="tab-item" onclick="switchTab('approval')"
             th:text="${lang == 'ja' ? 'æ±‚äººè€…æ‰¿èª' : 'êµ¬ì¸ì ê°€ì… ìŠ¹ì¸'}">êµ¬ì¸ì ê°€ì… ìŠ¹ì¸</div>
    </div>

    <div id="tab-content-all" class="tab-content active">
        <form action="/admin/user" method="get" class="top-controls">
            <input type="hidden" name="lang" th:value="${lang}">
            <input type="hidden" name="tab" value="all">

            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" name="keyword" class="search-input" th:value="${keyword}"
                       th:placeholder="${lang == 'ja' ? 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€åå‰ã§æ¤œç´¢' : 'ë‹‰ë„¤ì„, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰'}">
            </div>

            <select name="role" class="filter-select">
                <option value="" th:text="${lang == 'ja' ? 'å…¨æ¨©é™' : 'ëª¨ë“  ê¶Œí•œ'}">Role</option>
                <option value="SEEKER" th:selected="${role == 'SEEKER'}">Seeker</option>
                <option value="RECRUITER" th:selected="${role == 'RECRUITER'}">Recruiter</option>
                <option value="ADMIN" th:selected="${role == 'ADMIN'}">Admin</option>
            </select>

            <select name="status" class="filter-select">
                <option value="" th:text="${lang == 'ja' ? 'å…¨çŠ¶æ…‹' : 'ëª¨ë“  ìƒíƒœ'}">Status</option>
                <option value="ACTIVE" th:selected="${status == 'ACTIVE'}">Active</option>
                <option value="INACTIVE" th:selected="${status == 'INACTIVE'}">Inactive</option>
            </select>

            <button type="submit" class="btn-dark" th:text="${lang == 'ja' ? 'æ¤œç´¢' : 'ê²€ìƒ‰'}">Search</button>
        </form>

        <div class="table-container">
            <table class="custom-table">
                <thead>
                <tr>
                    <th style="width: 40px; text-align: center;"><input type="checkbox" id="checkAll"></th>
                    <th style="text-align: left;" th:text="${lang == 'ja' ? 'ä¼šå“¡æƒ…å ±' : 'íšŒì› ì •ë³´'}">User Info</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'æ¨©é™' : 'ê¶Œí•œ'}">Role</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'çŠ¶æ…‹' : 'ìƒíƒœ'}">Status</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'åŠ å…¥æ—¥' : 'ê°€ì…ì¼'}">Joined</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'æœ€çµ‚æ´»å‹•' : 'ìµœê·¼ ë¡œê·¸ì¸'}">Last Active</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'ç®¡ç†' : 'ê´€ë¦¬'}">Action</th>
                </tr>
                </thead>
                <tbody>

                <tr th:if="${users.totalElements == 0}">
                    <td colspan="7" style="text-align: center; padding: 50px; color: #999;">
                        <span th:text="${lang == 'ja' ? 'ä¼šå“¡ãŒã„ã¾ã›ã‚“ã€‚' : 'íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.'}">No Data</span>
                    </td>
                </tr>

                <tr th:each="u : ${users.content}">
                    <td style="text-align: center;"><input type="checkbox" name="userIds" th:value="${u.id}"></td>
                    <td>
                        <div class="user-profile">
                            <img th:src="@{${u.profileImage?.fileUrl ?: '/uploads/default_profile.png'}}"
                                 class="avatar-img" alt="í”„ë¡œí•„ ì´ë¯¸ì§€"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div class="avatar-circle" style="display:none;"
                                 th:text="${#strings.substring(u.nickname, 0, 1)}">K</div>

                            <div class="user-info">
                                <span class="user-name" th:text="${u.nickname}">Nickname</span>
                                <span class="user-email" th:text="${u.email}">Email</span>
                            </div>
                        </div>
                    </td>
                    <td style="text-align: center;"><span style="font-weight: 600; color: #555;" th:text="${u.role}">ROLE</span></td>
                    <td style="text-align: center;">
                        <span class="badge"
                              th:classappend="${u.status == 'ACTIVE' ? 'badge-active' : 'badge-inactive'}"
                              th:text="${u.status}">STATUS</span>
                    </td>
                    <td style="text-align: center;" th:text="${u.joinedAt}">Date</td>
                    <td style="text-align: center;" th:text="${u.lastActive}">Date</td>

                    <td style="text-align: center;">
                        <button class="btn-icon" title="Edit"
                                th:onclick="openEditModal([[${u.id}]], [[${u.role}]], [[${u.status}]])">âœï¸</button>
                        <button class="btn-icon" title="Delete" th:onclick="deleteUser([[${u.id}]])">ğŸ—‘ï¸</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination-container" th:if="${users.totalElements > 0}">
                <ul class="pagination">
                    <li th:classappend="${users.first} ? 'disabled'">
                        <a th:href="@{/admin/user(page=0, lang=${lang}, keyword=${keyword}, role=${role}, status=${status}, tab='all')}">&laquo;&laquo;</a>
                    </li>
                    <li th:classappend="${users.first} ? 'disabled'">
                        <a th:href="@{/admin/user(page=${users.number - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status}, tab='all')}">&lsaquo;</a>
                    </li>
                    <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                        th:classappend="${pageNum == users.number + 1} ? 'active'">
                        <a th:href="@{/admin/user(page=${pageNum - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status}, tab='all')}"
                           th:text="${pageNum}">1</a>
                    </li>
                    <li th:classappend="${users.last} ? 'disabled'">
                        <a th:href="@{/admin/user(page=${users.number + 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status}, tab='all')}">&rsaquo;</a>
                    </li>
                    <li th:classappend="${users.last} ? 'disabled'">
                        <a th:href="@{/admin/user(page=${totalPages - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status}, tab='all')}">&raquo;&raquo;</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div id="tab-content-approval" class="tab-content">
        <div class="table-container">
            <table class="custom-table">
                <thead>
                <tr>
                    <th style="width: 40px; text-align: center;"><input type="checkbox" id="checkAllPending"></th>
                    <th style="text-align: left;" th:text="${lang == 'ja' ? 'æ±‚äººè€…æƒ…å ±' : 'êµ¬ì¸ì ì •ë³´'}">User Info</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'åŠ å…¥æ—¥' : 'ê°€ì…ì¼'}">Joined</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'çŠ¶æ…‹' : 'ìƒíƒœ'}">Status</th>
                    <th style="text-align: center;" th:text="${lang == 'ja' ? 'ç®¡ç†' : 'ìŠ¹ì¸ ê´€ë¦¬'}">Action</th>
                </tr>
                </thead>
                <tbody>

                <tr th:if="${pendingRecruiters == null or pendingRecruiters.totalElements == 0}">
                    <td colspan="5" style="text-align: center; padding: 50px; color: #999;">
                        <span th:text="${lang == 'ja' ? 'æ‰¿èªå¾…ã¡ã®æ±‚äººè€…ãŒã„ã¾ã›ã‚“ã€‚' : 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ êµ¬ì¸ìê°€ ì—†ìŠµë‹ˆë‹¤.'}">No Data</span>
                    </td>
                </tr>

                <tr th:each="r : ${pendingRecruiters?.content}">
                    <td style="text-align: center;"><input type="checkbox" name="pendingUserIds" th:value="${r.id}"></td>
                    <td>
                        <div class="user-profile">
                            <div class="user-info">
                                <span class="user-name" th:text="${r.name} + ' (' + ${r.nickname} + ')'">Name</span>
                                <span class="user-email" th:text="${r.email}">Email</span>
                            </div>
                        </div>
                    </td>
                    <td style="text-align: center;" th:text="${r.joinedAt}">Date</td>
                    <td style="text-align: center;">
                        <span class="badge badge-suspended" th:text="${lang == 'ja' ? 'æ‰¿èªå¾…ã¡' : 'ìŠ¹ì¸ ëŒ€ê¸°'}">ìŠ¹ì¸ ëŒ€ê¸°</span>
                    </td>
                    <td style="text-align: center;">
                        <button class="btn-dark" style="height: 32px; padding: 0 15px; font-size: 13px;"
                                th:attr="data-id=${r.id},
                                         data-name=${r.name + ' (' + r.nickname + ')'},
                                         data-email=${r.email},
                                         data-date=${r.joinedAt},
                                         data-evidences=${r.evidenceUrls != null ? #strings.listJoin(r.evidenceUrls, ',') : ''}"
                                onclick="openApprovalModal(this)"
                                th:text="${lang == 'ja' ? 'å¯©æŸ»' : 'ì‹¬ì‚¬í•˜ê¸°'}">ì‹¬ì‚¬í•˜ê¸°</button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="pagination-container" th:if="${pendingRecruiters != null and pendingRecruiters.totalElements > 0}">
                <ul class="pagination">
                    <li th:each="pageNum : ${#numbers.sequence(1, pendingRecruiters.totalPages)}"
                        th:classappend="${pageNum == pendingRecruiters.number + 1} ? 'active'">
                        <a th:href="@{/admin/user(pendingPage=${pageNum - 1}, lang=${lang}, tab='approval')}"
                           th:text="${pageNum}">1</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

</main>

<div id="editModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 th:text="${lang == 'ja' ? 'ä¼šå“¡æƒ…å ±ä¿®æ­£' : 'íšŒì› ì •ë³´ ìˆ˜ì •'}">íšŒì› ì •ë³´ ìˆ˜ì •</h3>

        <input type="hidden" id="editUserId">

        <div class="form-group">
            <label th:text="${lang == 'ja' ? 'æ¨©é™å¤‰æ›´' : 'ê¶Œí•œ ë³€ê²½'}">ê¶Œí•œ ë³€ê²½</label>
            <select id="editRole">
                <option value="SEEKER">Seeker</option>
                <option value="RECRUITER">Recruiter</option>
                <option value="ADMIN">Admin</option>
            </select>
        </div>

        <div class="form-group">
            <label th:text="${lang == 'ja' ? 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹ (ãƒ­ãƒƒã‚¯è¨­å®š)' : 'ê³„ì • ìƒíƒœ (ì ê¸ˆ ì„¤ì •)'}">ê³„ì • ìƒíƒœ</label>
            <select id="editStatus">
                <option value="ACTIVE" th:text="${lang == 'ja' ? 'æ´»æ€§åŒ–' : 'í™œì„±í™”'}">í™œì„±í™”</option>
                <option value="INACTIVE" th:text="${lang == 'ja' ? 'ãƒ­ãƒƒã‚¯ (éæ´»æ€§)' : 'ê³„ì • ì ê¸ˆ'}">ê³„ì • ì ê¸ˆ</option>
            </select>
        </div>

        <div class="modal-actions">
            <button class="btn-outline" onclick="closeEditModal()" th:text="${lang == 'ja' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : 'ì·¨ì†Œ'}">ì·¨ì†Œ</button>
            <button class="btn-dark" onclick="submitEdit()" th:text="${lang == 'ja' ? 'ç¢ºèª' : 'í™•ì¸'}">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="approvalModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 400px;"> <h3 th:text="${lang == 'ja' ? 'æ±‚äººè€…åŠ å…¥å¯©æŸ»' : 'êµ¬ì¸ì ê°€ì… ì‹¬ì‚¬'}">êµ¬ì¸ì ê°€ì… ì‹¬ì‚¬</h3>

        <input type="hidden" id="approveUserId">

        <div class="form-group">
            <label th:text="${lang == 'ja' ? 'åŸºæœ¬æƒ…å ±' : 'ê¸°ë³¸ ì •ë³´'}">ê¸°ë³¸ ì •ë³´</label>
            <div id="approveUserInfo" style="background:#f8f9fa; padding:15px; border-radius:8px; font-size:14px; line-height:1.6; border: 1px solid #eee;">
            </div>
        </div>

        <div class="form-group">
            <label th:text="${lang == 'ja' ? 'è¨¼æ˜æ›¸é¡' : 'ì¦ë¹™ ì„œë¥˜'}">ì¦ë¹™ ì„œë¥˜</label>
            <div id="approveEvidenceList" style="display:flex; flex-direction:column; gap:8px;">
            </div>
        </div>

        <div class="modal-actions" style="justify-content: space-between; margin-top: 30px;">
            <button class="btn-outline" style="color:#fa5252; border-color:#fa5252;"
                    onclick="rejectFromModal()" th:text="${lang == 'ja' ? 'æ‹’å¦ (å‰Šé™¤)' : 'ê°€ì… ê±°ì ˆ'}">ê°€ì… ê±°ì ˆ</button>
            <div>
                <button class="btn-outline" onclick="closeApprovalModal()" th:text="${lang == 'ja' ? 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' : 'ì·¨ì†Œ'}">ì·¨ì†Œ</button>
                <button class="btn-dark" onclick="approveFromModal()" th:text="${lang == 'ja' ? 'æ‰¿èª' : 'ê°€ì… ìŠ¹ì¸'}">ê°€ì… ìŠ¹ì¸</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const currentLang = [[${lang}]] || 'ko';

    // [ì¶”ê°€] íƒ­ ìœ ì§€ ë° ì „í™˜ ë¡œì§
    document.addEventListener('DOMContentLoaded', () => {
        const activeTab = [[${activeTab}]] || 'all'; // ë°±ì—”ë“œì—ì„œ ë‚´ë ¤ì£¼ëŠ” íƒ­ ìƒíƒœ (ê¸°ë³¸ì€ all)
        switchTab(activeTab);

        fetchUserStats();

        const checkAll = document.getElementById('checkAll');
        if(checkAll){
            checkAll.addEventListener('change', function() {
                document.querySelectorAll('input[name="userIds"]').forEach(cb => cb.checked = this.checked);
            });
        }
    });

    function switchTab(tabName) {
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-btn-' + tabName).classList.add('active');
        document.getElementById('tab-content-' + tabName).classList.add('active');
    }

    // ì–¸ì–´ ë³€ê²½ ì‹œ íƒ­ ìƒíƒœë„ URLì— ìœ ì§€
    function changeLanguage(lang) {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);

        // í˜„ì¬ ì—´ë ¤ìˆëŠ” íƒ­ íŒŒì•…
        const activeTabEl = document.querySelector('.tab-content.active');
        if(activeTabEl) {
            url.searchParams.set('tab', activeTabEl.id.replace('tab-content-', ''));
        }

        window.location.href = url.toString();
    }

    // [ì¶”ê°€] êµ¬ì¸ì ìŠ¹ì¸ ë¡œì§ (ê¸°ì¡´ ìœ ì € ì •ë³´ ìˆ˜ì • APIë¥¼ ì¬í™œìš©í•˜ì—¬ ìƒíƒœë§Œ ACTIVEë¡œ ë³€ê²½)
    function approveRecruiter(userId) {
        const msg = currentLang === 'ja' ? "ã“ã®æ±‚äººè€…ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ" : "ì´ êµ¬ì¸ìì˜ ê°€ì…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        if(confirm(msg)) {
            const payload = {
                userId: userId,
                role: "RECRUITER", // ê¶Œí•œ ìœ ì§€
                status: "ACTIVE"   // í•µì‹¬: INACTIVE -> ACTIVE ë¡œ ë³€ê²½
            };

            fetch('/admin/user/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => {
                if(response.ok) {
                    alert(currentLang === 'ja' ? "æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚" : "ìŠ¹ì¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // ë¦¬ë¡œë“œ ì‹œ ìŠ¹ì¸ íƒ­ ìœ ì§€
                    const url = new URL(window.location.href);
                    url.searchParams.set('tab', 'approval');
                    window.location.href = url.toString();
                } else {
                    alert("Error");
                }
            });
        }
    }

    // ... (ì´í•˜ fetchUserStats, openEditModal, closeEditModal, submitEdit, deleteUser í•¨ìˆ˜ë“¤ì€ ê¸°ì¡´ê³¼ ì™„ë²½íˆ ë™ì¼í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€) ...
    // í†µê³„ í˜¸ì¶œ í•¨ìˆ˜
    async function fetchUserStats() {
        try {
            const response = await fetch('/admin/user/stats');
            if (!response.ok) throw new Error('Network error');
            const data = await response.json();

            document.getElementById('totalUsers').innerText = data.totalUsers.toLocaleString();
            document.getElementById('newUsers').innerText = data.newUsers.toLocaleString();
            document.getElementById('activeUsers').innerText = data.activeUsers.toLocaleString();
            document.getElementById('inactiveUsers').innerText = data.inactiveUsers.toLocaleString();
        } catch (error) {
            console.error("í†µê³„ ë¡œë”© ì‹¤íŒ¨:", error);
        }
    }

    function openEditModal(id, currentRole, currentStatus) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editRole').value = currentRole;
        document.getElementById('editStatus').value = currentStatus;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function submitEdit() {
        const userId = document.getElementById('editUserId').value;
        const newRole = document.getElementById('editRole').value;
        const newStatus = document.getElementById('editStatus').value;

        const msg = currentLang === 'ja' ? "ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ" : "ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        if(confirm(msg)) {
            const payload = {
                userId: userId,
                role: newRole,
                status: newStatus
            };

            fetch('/admin/user/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => {
                if(response.ok) {
                    alert(currentLang === 'ja' ? "ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚" : "ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeEditModal();
                    location.reload();
                } else {
                    alert(currentLang === 'ja' ? "ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" : "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }).catch(error => {
                console.error('Error:', error);
                alert("Network Error");
            });
        }
    }

    function deleteUser(id) {
        if(confirm(currentLang === 'ja' ? "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" : "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            fetch('/admin/user/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: id })
            }).then(response => {
                if(response.ok) {
                    alert(currentLang === 'ja' ? "å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚" : "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                } else {
                    alert(currentLang === 'ja' ? "å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" : "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }).catch(error => {
                console.error('Error:', error);
                alert("Network Error");
            });
        }
    }

    // ==========================================================
    // [ì¶”ê°€] êµ¬ì¸ì ì‹¬ì‚¬ ëª¨ë‹¬ ë¡œì§
    // ==========================================================

    // 1. ëª¨ë‹¬ ì—´ê¸° ë° ë°ì´í„° ì„¸íŒ…
    function openApprovalModal(btn) {
        const id = btn.getAttribute('data-id');
        const name = btn.getAttribute('data-name');
        const email = btn.getAttribute('data-email');
        const date = btn.getAttribute('data-date');
        const evidencesStr = btn.getAttribute('data-evidences'); // ì‰¼í‘œë¡œ ì—°ê²°ëœ URL ë¬¸ìì—´

        // ID ì €ì¥
        document.getElementById('approveUserId').value = id;

        // ê¸°ë³¸ ì •ë³´ ì„¸íŒ…
        const labelName = currentLang === 'ja' ? 'åå‰' : 'ì´ë¦„';
        const labelEmail = currentLang === 'ja' ? 'ãƒ¡ãƒ¼ãƒ«' : 'ì´ë©”ì¼';
        const labelDate = currentLang === 'ja' ? 'åŠ å…¥æ—¥' : 'ê°€ì…ì¼';

        document.getElementById('approveUserInfo').innerHTML = `
            <b>${labelName}:</b> ${name} <br>
            <b>${labelEmail}:</b> ${email} <br>
            <b>${labelDate}:</b> ${date}
        `;

        // ì¦ë¹™ì„œë¥˜ ë¦¬ìŠ¤íŠ¸ ì„¸íŒ…
        const evidenceBox = document.getElementById('approveEvidenceList');
        evidenceBox.innerHTML = '';

        if (evidencesStr && evidencesStr.trim() !== '') {
            const urls = evidencesStr.split(',');
            urls.forEach((url, idx) => {
                const btnText = currentLang === 'ja' ? `æ›¸é¡ ${idx + 1} ç¢ºèª` : `ì¦ë¹™ì„œë¥˜ ${idx + 1} í™•ì¸í•˜ê¸°`;
                evidenceBox.innerHTML += `
                    <a href="${url}" target="_blank" class="btn-outline" style="text-align:center; text-decoration:none; display:block; padding: 10px;">
                        <i class="fa-solid fa-file-invoice"></i> ${btnText}
                    </a>
                `;
            });
        } else {
            const noDataMsg = currentLang === 'ja' ? 'æ·»ä»˜ã•ã‚ŒãŸæ›¸é¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚' : 'ì²¨ë¶€ëœ ì¦ë¹™ì„œë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤.';
            evidenceBox.innerHTML = `<div style="padding:15px; background:#f8f9fa; border-radius:8px; text-align:center; color:#999; font-size:13px; border: 1px dashed #ccc;">${noDataMsg}</div>`;
        }

        // ëª¨ë‹¬ ë„ìš°ê¸°
        document.getElementById('approvalModal').style.display = 'flex';
    }

    // 2. ëª¨ë‹¬ ë‹«ê¸°
    function closeApprovalModal() {
        document.getElementById('approvalModal').style.display = 'none';
    }

    // 3. ëª¨ë‹¬ì—ì„œ [ìŠ¹ì¸] ë²„íŠ¼ í´ë¦­ ì‹œ
    function approveFromModal() {
        const userId = document.getElementById('approveUserId').value;
        const msg = currentLang === 'ja' ? "ã“ã®æ±‚äººè€…ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ" : "ì´ êµ¬ì¸ìì˜ ê°€ì…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        if(confirm(msg)) {
            const payload = {
                userId: userId,
                role: "RECRUITER",
                status: "ACTIVE"   // ìƒíƒœë¥¼ í™œì„±í™”ë¡œ ë³€ê²½
            };

            fetch('/admin/user/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(response => {
                if(response.ok) {
                    alert(currentLang === 'ja' ? "æ‰¿èªã•ã‚Œã¾ã—ãŸã€‚" : "ìŠ¹ì¸ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    const url = new URL(window.location.href);
                    url.searchParams.set('tab', 'approval');
                    window.location.href = url.toString();
                } else {
                    alert("Error");
                }
            });
        }
    }

    // 4. ëª¨ë‹¬ì—ì„œ [ê±°ì ˆ] ë²„íŠ¼ í´ë¦­ ì‹œ (ê³„ì • ì‚­ì œ)
    function rejectFromModal() {
        const userId = document.getElementById('approveUserId').value;
        const msg = currentLang === 'ja' ? "æœ¬å½“ã«æ‹’å¦(å‰Šé™¤)ã—ã¾ã™ã‹ï¼Ÿ" : "ê°€ì…ì„ ê±°ì ˆí•˜ê³  ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";

        if(confirm(msg)) {
            fetch('/admin/user/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId })
            }).then(response => {
                if(response.ok) {
                    alert(currentLang === 'ja' ? "æ‹’å¦(å‰Šé™¤)ã•ã‚Œã¾ã—ãŸã€‚" : "ê°€ì… ê±°ì ˆ ë° ì‚­ì œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    const url = new URL(window.location.href);
                    url.searchParams.set('tab', 'approval');
                    window.location.href = url.toString();
                } else {
                    alert("Error");
                }
            });
        }
    }
</script>
</body>
</html>