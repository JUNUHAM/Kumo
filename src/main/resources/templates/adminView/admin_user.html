<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>KUMO Admin - Users</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_user.css}">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_sidebar.css}">

</head>
<body>

<aside th:replace="~{adminView/admin_sidebar :: admin_sidebar('users', ${lang})}"></aside>

<main class="main-content">

    <div class="stats-container">
        <div class="stat-card">
            <span class="stat-value" id="totalUsers">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'å…¨ä¼šå“¡' : 'ì „ì²´ íšŒì›'}">ì „ì²´ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="newUsers">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'æ–°è¦ä¼šå“¡' : 'ì‹ ê·œ íšŒì›'}">ì‹ ê·œ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="activeUsers" style="color: #0ca678;">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'æ´»å‹•ä¸­' : 'í™œë™ íšŒì›'}">í™œë™ íšŒì›</span>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="inactiveUsers" style="color: #868e96;">-</span>
            <span class="stat-label" th:text="${lang == 'ja' ? 'éæ´»æ€§' : 'ë¹„í™œì„± íšŒì›'}">ë¹„í™œì„± íšŒì›</span>
        </div>
    </div>

    <form action="/admin/user" method="get" class="top-controls">
        <input type="hidden" name="lang" th:value="${lang}">

        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" name="keyword" class="search-input" th:value="${keyword}"
                   th:placeholder="${lang == 'ja' ? 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€åå‰ã§æ¤œç´¢' : 'ë‹‰ë„¤ì„, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰'}">
        </div>

        <select name="role" class="filter-select">
            <option value="" th:text="${lang == 'ja' ? 'å…¨æ¨©é™' : 'ëª¨ë“  ê¶Œí•œ'}">Role</option>
            <option value="SEEKER" th:selected="${role == 'SEEKER'}">Seeker</option>
            <option value="RECRUITER" th:selected="${role == 'RECRUITER'}">Recruiter</option>
            <option value="ADMIN" th:selected="${role == 'ADMIN'}">Admin</option>
        </select>

        <select name="status" class="filter-select">
            <option value="" th:text="${lang == 'ja' ? 'å…¨ìƒíƒœ' : 'ëª¨ë“  ìƒíƒœ'}">Status</option>
            <option value="ACTIVE" th:selected="${status == 'ACTIVE'}">Active</option>
            <option value="INACTIVE" th:selected="${status == 'INACTIVE'}">Inactive</option>
        </select>

        <button type="submit" class="btn-dark" th:text="${lang == 'ja' ? 'æ¤œç´¢' : 'ê²€ìƒ‰'}">Search</button>
    </form>

    <div class="table-container">
        <table class="custom-table">
            <thead>
            <tr>
                <th style="width: 40px;"><input type="checkbox" id="checkAll"></th>
                <th th:text="${lang == 'ja' ? 'ä¼šå“¡æƒ…å ±' : 'íšŒì› ì •ë³´'}">User Info</th>
                <th th:text="${lang == 'ja' ? 'æ¨©í•œ' : 'ê¶Œí•œ'}">Role</th>
                <th th:text="${lang == 'ja' ? 'çŠ¶æ…‹' : 'ìƒíƒœ'}">Status</th>
                <th th:text="${lang == 'ja' ? 'åŠ å…¥æ—¥' : 'ê°€ì…ì¼'}">Joined</th>
                <th th:text="${lang == 'ja' ? 'æœ€çµ‚æ´»å‹•' : 'ìµœê·¼ í™œë™'}">Last Active</th>
                <th th:text="${lang == 'ja' ? 'ç®¡ç†' : 'ê´€ë¦¬'}" style="text-align: right;">Action</th>
            </tr>
            </thead>
            <tbody>

            <tr th:if="${users.totalElements == 0}">
                <td colspan="7" style="text-align: center; padding: 50px; color: #999;">
                    <span th:text="${lang == 'ja' ? 'ä¼šå“¡ãŒã„ã¾ã›ã‚“ã€‚' : 'íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.'}">No Data</span>
                </td>
            </tr>

            <tr th:each="u : ${users.content}">
                <td><input type="checkbox" name="userIds" th:value="${u.id}"></td>
                <td>
                    <div class="user-profile">
                        <img th:src="${u.profileImage}" class="avatar-img"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-circle" style="display:none;"
                             th:text="${#strings.substring(u.nickname, 0, 1)}">K</div>

                        <div class="user-info">
                            <span class="user-name" th:text="${u.nickname}">Nickname</span>
                            <span class="user-email" th:text="${u.email}">Email</span>
                        </div>
                    </div>
                </td>
                <td><span style="font-weight: 600; color: #555;" th:text="${u.role}">ROLE</span></td>
                <td>
                    <span class="badge"
                          th:classappend="${u.status == 'ACTIVE' ? 'badge-active' : 'badge-inactive'}"
                          th:text="${u.status}">STATUS</span>
                </td>
                <td th:text="${u.joinedAt}">Date</td>
                <td th:text="${u.lastActive}">Date</td>
                <td style="text-align: right;">
                    <button class="btn-icon" title="Edit">âœï¸</button>
                    <button class="btn-icon" title="Delete" th:onclick="deleteUser([[${u.id}]])">ğŸ—‘ï¸</button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="pagination-container" th:if="${users.totalElements > 0}">
            <ul class="pagination">
                <li th:classappend="${users.first} ? 'disabled'">
                    <a th:href="@{/admin/user(page=0, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&laquo;&laquo;</a>
                </li>
                <li th:classappend="${users.first} ? 'disabled'">
                    <a th:href="@{/admin/user(page=${users.number - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&lsaquo;</a>
                </li>
                <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                    th:classappend="${pageNum == users.number + 1} ? 'active'">
                    <a th:href="@{/admin/user(page=${pageNum - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                       th:text="${pageNum}">1</a>
                </li>
                <li th:classappend="${users.last} ? 'disabled'">
                    <a th:href="@{/admin/user(page=${users.number + 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&rsaquo;</a>
                </li>
                <li th:classappend="${users.last} ? 'disabled'">
                    <a th:href="@{/admin/user(page=${totalPages - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}">&raquo;&raquo;</a>
                </li>
            </ul>
        </div>
    </div>

</main>

<script th:inline="javascript">
    const currentLang = [[${lang}]] || 'ko';

    // [ì¶”ê°€] í†µê³„ ë°ì´í„° ë¹„ë™ê¸° í˜¸ì¶œ í•¨ìˆ˜
    async function fetchUserStats() {
        try {
            // ì•„ê¹Œ ë§Œë“  RestController API í˜¸ì¶œ
            const response = await fetch('/admin/user/stats');
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            updateStatsUI(data);
        } catch (error) {
            console.error("í†µê³„ ë¡œë”© ì‹¤íŒ¨:", error);
            // ì—ëŸ¬ ì‹œ 0ìœ¼ë¡œ í‘œê¸°
            document.getElementById('totalUsers').innerText = "0";
            document.getElementById('newUsers').innerText = "0";
            document.getElementById('activeUsers').innerText = "0";
            document.getElementById('inactiveUsers').innerText = "0";
        }
    }

    // [ì¶”ê°€] UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateStatsUI(data) {
        // ìˆ«ì 3ìë¦¬ ì½¤ë§ˆ í¬ë§·íŒ… (toLocaleString)
        document.getElementById('totalUsers').innerText = data.totalUsers.toLocaleString();
        document.getElementById('newUsers').innerText = data.newUsers.toLocaleString();
        document.getElementById('activeUsers').innerText = data.activeUsers.toLocaleString();
        document.getElementById('inactiveUsers').innerText = data.inactiveUsers.toLocaleString();
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', () => {
        // 1. í†µê³„ ê°€ì ¸ì˜¤ê¸°
        fetchUserStats();

        // 2. ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë“± ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸
        const checkAll = document.getElementById('checkAll');
        if(checkAll){
            checkAll.addEventListener('change', function() {
                document.querySelectorAll('input[name="userIds"]').forEach(cb => cb.checked = this.checked);
            });
        }
    });

    function deleteUser(id) {
        if(confirm(currentLang === 'ja' ? "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" : "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            alert("Delete API: " + id);
        }
    }
</script>

</body>
</html>