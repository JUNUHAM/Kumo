<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>KUMO Admin - Users</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/css/adminView/admin_user.css}" />
    <link rel="stylesheet" th:href="@{/css/adminView/admin_sidebar.css}" />

    <style>
      .modal-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0, 0, 0, 0.4); z-index: 2000;
          display: flex; align-items: center; justify-content: center;
      }
      .modal-content {
          background: white; padding: 30px; border-radius: 12px;
          width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      }
      .modal-content h3 { margin-top: 0; margin-bottom: 20px; color: #343a40; font-size: 18px; }
      .form-group { margin-bottom: 20px; }
      .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #495057; }
      .form-group select { width: 100%; height: 42px; border-radius: 6px; border: 1px solid #ced4da; padding: 0 10px; }
      .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
    </style>
  </head>
  <body>
    <aside
      th:replace="~{adminView/admin_sidebar :: admin_sidebar('users', ${lang})}"
    ></aside>

    <main class="main-content">
      <div class="stats-container">
        <div class="stat-card">
          <span class="stat-value" id="totalUsers">-</span>
          <span
            class="stat-label"
            th:text="${lang == 'ja' ? 'ÂÖ®‰ºöÂì°' : 'Ï†ÑÏ≤¥ ÌöåÏõê'}"
            >Ï†ÑÏ≤¥ ÌöåÏõê</span
          >
        </div>
        <div class="stat-card">
          <span class="stat-value" id="newUsers">-</span>
          <span
            class="stat-label"
            th:text="${lang == 'ja' ? 'Êñ∞Ë¶è‰ºöÂì°' : 'Ïã†Í∑ú ÌöåÏõê'}"
            >Ïã†Í∑ú ÌöåÏõê</span
          >
        </div>
        <div class="stat-card">
          <span class="stat-value" id="activeUsers" style="color: #0ca678;"
            >-</span
          >
          <span
            class="stat-label"
            th:text="${lang == 'ja' ? 'Ê¥ªÂãï‰∏≠' : 'ÌôúÎèô ÌöåÏõê'}"
            >ÌôúÎèô ÌöåÏõê</span
          >
        </div>
        <div class="stat-card">
          <span class="stat-value" id="inactiveUsers" style="color: #868e96;"
            >-</span
          >
          <span
            class="stat-label"
            th:text="${lang == 'ja' ? 'ÈùûÊ¥ªÊÄß' : 'ÎπÑÌôúÏÑ± ÌöåÏõê'}"
            >ÎπÑÌôúÏÑ± ÌöåÏõê</span
          >
        </div>
      </div>

      <form action="/admin/user" method="get" class="top-controls">
        <input type="hidden" name="lang" th:value="${lang}" />

        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input
            type="text"
            name="keyword"
            class="search-input"
            th:value="${keyword}"
            th:placeholder="${lang == 'ja' ? '„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÄÅÂêçÂâç„ÅßÊ§úÁ¥¢' : 'ÎãâÎÑ§ÏûÑ, Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ'}"
          />
        </div>

        <select name="role" class="filter-select">
          <option value="" th:text="${lang == 'ja' ? 'ÂÖ®Ê®©Èôê' : 'Î™®Îì† Í∂åÌïú'}">
            Role
          </option>
          <option value="SEEKER" th:selected="${role == 'SEEKER'}">
            Seeker
          </option>
          <option value="RECRUITER" th:selected="${role == 'RECRUITER'}">
            Recruiter
          </option>
          <option value="ADMIN" th:selected="${role == 'ADMIN'}">Admin</option>
        </select>

        <select name="status" class="filter-select">
          <option value="" th:text="${lang == 'ja' ? 'ÂÖ®Áä∂ÊÖã' : 'Î™®Îì† ÏÉÅÌÉú'}">
            Status
          </option>
          <option value="ACTIVE" th:selected="${status == 'ACTIVE'}">
            Active
          </option>
          <option value="INACTIVE" th:selected="${status == 'INACTIVE'}">
            Inactive
          </option>
        </select>

        <button
          type="submit"
          class="btn-dark"
          th:text="${lang == 'ja' ? 'Ê§úÁ¥¢' : 'Í≤ÄÏÉâ'}"
        >
          Search
        </button>
      </form>

      <div class="table-container">
        <table class="custom-table">
          <thead>
            <tr>
              <th style="width: 40px; text-align: center;">
                <input type="checkbox" id="checkAll" />
              </th>
              <th
                style="text-align: left;"
                th:text="${lang == 'ja' ? '‰ºöÂì°ÊÉÖÂ†±' : 'ÌöåÏõê Ï†ïÎ≥¥'}"
              >
                User Info
              </th>
              <th
                style="text-align: center;"
                th:text="${lang == 'ja' ? 'Ê®©Èôê' : 'Í∂åÌïú'}"
              >
                Role
              </th>
              <th
                style="text-align: center;"
                th:text="${lang == 'ja' ? 'Áä∂ÊÖã' : 'ÏÉÅÌÉú'}"
              >
                Status
              </th>
              <th
                style="text-align: center;"
                th:text="${lang == 'ja' ? 'Âä†ÂÖ•Êó•' : 'Í∞ÄÏûÖÏùº'}"
              >
                Joined
              </th>
              <th
                style="text-align: center;"
                th:text="${lang == 'ja' ? 'ÊúÄÁµÇÊ¥ªÂãï' : 'ÏµúÍ∑º Î°úÍ∑∏Ïù∏'}"
              >
                Last Active
              </th>
              <th
                style="text-align: center;"
                th:text="${lang == 'ja' ? 'ÁÆ°ÁêÜ' : 'Í¥ÄÎ¶¨'}"
              >
                Action
              </th>
            </tr>
          </thead>
          <tbody>
            <tr th:if="${users.totalElements == 0}">
              <td
                colspan="7"
                style="text-align: center; padding: 50px; color: #999;"
              >
                <span
                  th:text="${lang == 'ja' ? '‰ºöÂì°„Åå„ÅÑ„Åæ„Åõ„Çì„ÄÇ' : 'ÌöåÏõêÏù¥ ÏóÜÏäµÎãàÎã§.'}"
                  >No Data</span
                >
              </td>
            </tr>

            <tr th:each="u : ${users.content}">
                <td style="text-align: center;"><input type="checkbox" name="userIds" th:value="${u.id}"></td>
                <td>
                    <div class="user-profile">
                        <img th:src="@{${u.profileImage?.fileUrl ?: '/uploads/default_profile.png'}}"
                             class="avatar-img" alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-circle" style="display:none;"
                             th:text="${#strings.substring(u.nickname, 0, 1)}">K</div>

                  <div class="user-info">
                    <span class="user-name" th:text="${u.nickname}"
                      >Nickname</span
                    >
                    <span class="user-email" th:text="${u.email}">Email</span>
                  </div>
                </div>
              </td>
              <td style="text-align: center;">
                <span style="font-weight: 600; color: #555;" th:text="${u.role}"
                  >ROLE</span
                >
              </td>
              <td style="text-align: center;">
                <span
                  class="badge"
                  th:classappend="${u.status == 'ACTIVE' ? 'badge-active' : 'badge-inactive'}"
                  th:text="${u.status}"
                  >STATUS</span
                >
              </td>
              <td style="text-align: center;" th:text="${u.joinedAt}">Date</td>
              <td style="text-align: center;" th:text="${u.lastActive}">
                Date
              </td>

              <td style="text-align: center;">
                <button
                  class="btn-icon"
                  title="Edit"
                  th:onclick="openEditModal([[${u.id}]], [[${u.role}]], [[${u.status}]])"
                >
                  ‚úèÔ∏è
                </button>
                <button
                  class="btn-icon"
                  title="Delete"
                  th:onclick="deleteUser([[${u.id}]])"
                >
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="pagination-container" th:if="${users.totalElements > 0}">
          <ul class="pagination">
            <li th:classappend="${users.first} ? 'disabled'">
              <a
                th:href="@{/admin/user(page=0, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                >&laquo;&laquo;</a
              >
            </li>
            <li th:classappend="${users.first} ? 'disabled'">
              <a
                th:href="@{/admin/user(page=${users.number - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                >&lsaquo;</a
              >
            </li>
            <li
              th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
              th:classappend="${pageNum == users.number + 1} ? 'active'"
            >
              <a
                th:href="@{/admin/user(page=${pageNum - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                th:text="${pageNum}"
                >1</a
              >
            </li>
            <li th:classappend="${users.last} ? 'disabled'">
              <a
                th:href="@{/admin/user(page=${users.number + 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                >&rsaquo;</a
              >
            </li>
            <li th:classappend="${users.last} ? 'disabled'">
              <a
                th:href="@{/admin/user(page=${totalPages - 1}, lang=${lang}, keyword=${keyword}, role=${role}, status=${status})}"
                >&raquo;&raquo;</a
              >
            </li>
          </ul>
        </div>
      </div>
    </main>

    <div id="editModal" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h3 th:text="${lang == 'ja' ? '‰ºöÂì°ÊÉÖÂ†±‰øÆÊ≠£' : 'ÌöåÏõê Ï†ïÎ≥¥ ÏàòÏ†ï'}">
          ÌöåÏõê Ï†ïÎ≥¥ ÏàòÏ†ï
        </h3>

        <input type="hidden" id="editUserId" />

        <div class="form-group">
          <label th:text="${lang == 'ja' ? 'Ê®©ÈôêÂ§âÊõ¥' : 'Í∂åÌïú Î≥ÄÍ≤Ω'}"
            >Í∂åÌïú Î≥ÄÍ≤Ω</label
          >
          <select id="editRole">
            <option value="SEEKER">Seeker</option>
            <option value="RECRUITER">Recruiter</option>
            <option value="ADMIN">Admin</option>
          </select>
        </div>

        <div class="form-group">
          <label
            th:text="${lang == 'ja' ? '„Ç¢„Ç´„Ç¶„É≥„ÉàÁä∂ÊÖã („É≠„ÉÉ„ÇØË®≠ÂÆö)' : 'Í≥ÑÏ†ï ÏÉÅÌÉú (Ïû†Í∏à ÏÑ§Ï†ï)'}"
            >Í≥ÑÏ†ï ÏÉÅÌÉú</label
          >
          <select id="editStatus">
            <option
              value="ACTIVE"
              th:text="${lang == 'ja' ? 'Ê¥ªÊÄßÂåñ' : 'ÌôúÏÑ±Ìôî'}"
            >
              ÌôúÏÑ±Ìôî
            </option>
            <option
              value="INACTIVE"
              th:text="${lang == 'ja' ? '„É≠„ÉÉ„ÇØ (ÈùûÊ¥ªÊÄß)' : 'Í≥ÑÏ†ï Ïû†Í∏à'}"
            >
              Í≥ÑÏ†ï Ïû†Í∏à
            </option>
          </select>
        </div>

        <div class="modal-actions">
          <button
            class="btn-outline"
            onclick="closeEditModal()"
            th:text="${lang == 'ja' ? '„Ç≠„É£„É≥„Çª„É´' : 'Ï∑®ÏÜå'}"
          >
            Ï∑®ÏÜå
          </button>
          <button
            class="btn-dark"
            onclick="submitEdit()"
            th:text="${lang == 'ja' ? 'Á¢∫Ë™ç' : 'ÌôïÏù∏'}"
          >
            ÌôïÏù∏
          </button>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      const currentLang = [[${lang}]] || 'ko';

      // [Ï∂îÍ∞Ä] ÏÇ¨Ïù¥ÎìúÎ∞î Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω Ìï®Ïàò
      function changeLanguage(lang) {
          const url = new URL(window.location.href);
          url.searchParams.set('lang', lang);
          // Í≤ÄÏÉâ ÌïÑÌÑ∞ÎÇò ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÌååÎùºÎØ∏ÌÑ∞Î•º Ïú†ÏßÄÌïú Ï±ÑÎ°ú Ïñ∏Ïñ¥Îßå Î≥ÄÍ≤ΩÌï©ÎãàÎã§.
          window.location.href = url.toString();
      }

      // ÌÜµÍ≥Ñ Ìò∏Ï∂ú Ìï®Ïàò
      async function fetchUserStats() {
          try {
              const response = await fetch('/admin/user/stats');
              if (!response.ok) throw new Error('Network error');
              const data = await response.json();

              document.getElementById('totalUsers').innerText = data.totalUsers.toLocaleString();
              document.getElementById('newUsers').innerText = data.newUsers.toLocaleString();
              document.getElementById('activeUsers').innerText = data.activeUsers.toLocaleString();
              document.getElementById('inactiveUsers').innerText = data.inactiveUsers.toLocaleString();
          } catch (error) {
              console.error("ÌÜµÍ≥Ñ Î°úÎî© Ïã§Ìå®:", error);
          }
      }

      // [Ï∂îÍ∞Ä] Î™®Îã¨Ï∞Ω Ïó¥Í∏∞
      function openEditModal(id, currentRole, currentStatus) {
          document.getElementById('editUserId').value = id;
          document.getElementById('editRole').value = currentRole;
          document.getElementById('editStatus').value = currentStatus;
          document.getElementById('editModal').style.display = 'flex';
      }

      // [Ï∂îÍ∞Ä] Î™®Îã¨Ï∞Ω Îã´Í∏∞
      function closeEditModal() {
          document.getElementById('editModal').style.display = 'none';
      }

      document.addEventListener('DOMContentLoaded', () => {
          fetchUserStats();

          // Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏
          const checkAll = document.getElementById('checkAll');
          if(checkAll){
              checkAll.addEventListener('change', function() {
                  document.querySelectorAll('input[name="userIds"]').forEach(cb => cb.checked = this.checked);
              });
          }
      });

      function submitEdit() {
          const userId = document.getElementById('editUserId').value;
          const newRole = document.getElementById('editRole').value;
          const newStatus = document.getElementById('editStatus').value;

          const msg = currentLang === 'ja' ? "‰øÆÊ≠£„Åó„Åæ„Åô„ÅãÔºü" : "ÏàòÏ†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?";
          if(confirm(msg)) {
              // 1. ÏÑúÎ≤ÑÎ°ú Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞ Î¨∂Í∏∞
              const payload = {
                  userId: userId,
                  role: newRole,
                  status: newStatus
              };

              // 2. Fetch APIÎ°ú POST ÏöîÏ≤≠ Ï†ÑÏÜ°
              fetch('/admin/user/edit', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(payload)
              })
                  .then(response => {
                      if(response.ok) {
                          alert(currentLang === 'ja' ? "‰øÆÊ≠£„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ" : "ÏàòÏ†ïÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.");
                          closeEditModal();
                          location.reload(); // ÏÑ±Í≥µ Ïãú ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ Î≥ÄÍ≤ΩÎêú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                      } else {
                          alert(currentLang === 'ja' ? "‰øÆÊ≠£„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ" : "ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      alert("Network Error");
                  });
          }
      }

      // [ÏàòÏ†ï ÏôÑÎ£å] ÌöåÏõê ÏÇ≠Ï†ú Ìï®Ïàò (ÏÑúÎ≤ÑÎ°ú ÏÇ≠Ï†ú ÏöîÏ≤≠)
      function deleteUser(id) {
          if(confirm(currentLang === 'ja' ? "Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü" : "Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {

              fetch('/admin/user/delete', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ userId: id })
              })
                  .then(response => {
                      if(response.ok) {
                          alert(currentLang === 'ja' ? "ÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ" : "ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                          location.reload(); // ÏÑ±Í≥µ Ïãú ÏÉàÎ°úÍ≥†Ïπ®
                      } else {
                          alert(currentLang === 'ja' ? "ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ" : "ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞Í∞Ä Ï°¥Ïû¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.)");
                      }
                  })
                  .catch(error => {
                      console.error('Error:', error);
                      alert("Network Error");
                  });
          }
      }
    </script>
  </body>
  <!--Ïù¥Í±∞Î∞òÏòÅÏïàÌï¥ÎèÑÎê®-->
</html>