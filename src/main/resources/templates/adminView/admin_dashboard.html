<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>KUMO Admin Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" th:href="@{/css/adminView/admin_dashboard.css}">
</head>
<body>

<aside class="sidebar">
    <ul class="nav-menu">
        <a th:href="@{/admin/dashboard(lang=${lang})}" class="nav-item active">
            <span class="nav-icon">ğŸ </span>
            <span th:text="${lang == 'ja' ? 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰' : 'DashBoard'}">DashBoard</span>
        </a>
        <li class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span th:text="${lang == 'ja' ? 'ä¼šå“¡ç®¡ç†' : 'Users'}">Users</span>
        </li>
        <a th:href="@{/admin/post(lang=${lang})}" class="nav-item">
            <span class="nav-icon">ğŸ“„</span>
            <span th:text="${lang == 'ja' ? 'æ±‚äººç®¡ç†' : 'Post'}">Post</span>
        </a>
        <li class="nav-item">
            <span class="nav-icon">ğŸ•¸ï¸</span> DataOps
        </li>
        <li class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span th:text="${lang == 'ja' ? 'è¨­å®š' : 'Setting'}">Setting</span>
        </li>
    </ul>

    <div class="lang-switch-container">
        <button class="btn-lang"
                th:classappend="${lang == 'ko' || lang == null ? 'active' : ''}"
                onclick="changeLanguage('ko')">KO</button>
        <button class="btn-lang"
                th:classappend="${lang == 'ja' ? 'active' : ''}"
                onclick="changeLanguage('ja')">JP</button>
    </div>
</aside>

<main class="main-content">
    <div class="dashboard-container">
        <div class="welcome-banner">
            <h2 class="welcome-text">
                <span th:text="${lang == 'ja' ? 'ç®¡ç†ãƒšãƒ¼ã‚¸ã¸ã‚ˆã†ã“ã' : 'ê´€ë¦¬ì í˜ì´ì§€ì— ì˜¤ì‹ ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤'}">í™˜ì˜í•©ë‹ˆë‹¤</span>
                <span th:text="${adminName}">User</span>.
            </h2>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? 'ç·ä¼šå“¡æ•°' : 'ì „ì²´ íšŒì›'}">ì „ì²´ íšŒì›</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="newUsers">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? 'æ–°è¦ä¼šå“¡' : 'ì‹ ê·œ íšŒì›'}">ì‹ ê·œ íšŒì›</div>
            </div>
            <div class="stat-card">
                <div class="stat-value loading" id="totalPosts">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? 'ç·æ±‚äººæ•°' : 'ì „ì²´ ê³µê³ ìˆ˜'}">ì „ì²´ ê³µê³ ìˆ˜</div>
            </div>
            <div class="stat-card">
                <div class="stat-value loading" id="newPosts">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? 'æ–°è¦æ±‚äºº' : 'ì‹ ê·œ ê³µê³ ìˆ˜'}">ì‹ ê·œ ê³µê³ ìˆ˜</div>
            </div>
        </div>

        <div class="charts-middle-row">
            <div class="chart-box-left">
                <div class="chart-header">
                    <span class="chart-title" th:text="${lang == 'ja' ? 'é€±é–“æ±‚äººç™»éŒ²æ•° (ç›´è¿‘7æ—¥)' : 'ì£¼ê°„ ê³µê³  ë“±ë¡ ìˆ˜ (ìµœê·¼ 7ì¼)'}">ì£¼ê°„ ê³µê³  ë“±ë¡ ìˆ˜</span>
                </div>
                <canvas id="barChart"></canvas>
            </div>

            <div class="chart-box-right">
                <div class="chart-header">
                    <span class="chart-title" th:text="${lang == 'ja' ? 'åœ°åŸŸåˆ¥æ±‚äºº' : 'ì§€ì—­ë³„ ê³µê³  ìˆ˜'}">ì§€ì—­ë³„ ê³µê³  ìˆ˜</span>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="toggleRegion('osaka')" th:text="${lang == 'ja' ? 'å¤§é˜ª' : 'ì˜¤ì‚¬ì¹´'}">ì˜¤ì‚¬ì¹´</button>
                        <button class="toggle-btn" onclick="toggleRegion('tokyo')" th:text="${lang == 'ja' ? 'æ±äº¬' : 'ë„ì¿„'}">ë„ì¿„</button>
                    </div>
                </div>

                <div style="width: 180px; height: 180px; position: relative; margin: 0 auto;">
                    <canvas id="doughnutChart"></canvas>
                </div>

                <div id="customLegend" class="chart-legend-container">
                </div>
            </div>
        </div>

        <div class="chart-box-bottom">
            <div class="chart-header">
                <span class="chart-title" th:text="${lang == 'ja' ? 'æœˆåˆ¥æ–°è¦ä¼šå“¡æ¨ç§»' : 'ì›”ë³„ ì‹ ê·œ íšŒì› ìˆ˜'}">ì›”ë³„ ì‹ ê·œ íšŒì› ìˆ˜</span>
            </div>
            <canvas id="lineChart"></canvas>
        </div>
    </div>
</main>

<script th:inline="javascript">
    const currentLang = [[${lang}]] || 'ko';

    const TEXT = {
        barLabel: currentLang === 'ja' ? 'ç™»éŒ²æ•°' : 'ë“±ë¡ ìˆ˜',
        lineLabel: currentLang === 'ja' ? 'ä¼šå“¡æ•°' : 'íšŒì› ìˆ˜',
        noData: currentLang === 'ja' ? 'ãƒ‡ãƒ¼ã‚¿ãªã—' : 'ë°ì´í„° ì—†ìŒ'
    };

    let barChart, doughnutChart, lineChart;
    let dashboardData = {};

    function changeLanguage(lang) {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        window.location.href = url.toString();
    }

    function initCharts() {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: TEXT.barLabel,
                    data: [],
                    backgroundColor: '#3b5bdb',
                    borderRadius: 15,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });

        const ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
        doughnutChart = new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                }
            }
        });

        const ctxLine = document.getElementById('lineChart').getContext('2d');
        const gradient = ctxLine.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(51, 154, 240, 0.4)');
        gradient.addColorStop(1, 'rgba(51, 154, 240, 0.0)');

        lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: TEXT.lineLabel,
                    data: [],
                    borderColor: '#339af0',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    async function fetchDashboardData() {
        try {
            const response = await fetch('/admin/data');
            if (!response.ok) throw new Error('Network response was not ok');
            dashboardData = await response.json();
            updateUI(dashboardData);
        } catch (error) {
            console.error("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            document.getElementById('totalPosts').innerText = "0";
            document.getElementById('newPosts').innerText = "0";
        }
    }

    function updateUI(data) {
        document.getElementById('totalUsers').innerText = data.totalUsers.toLocaleString();
        document.getElementById('newUsers').innerText = data.newUsers.toLocaleString();
        document.getElementById('totalPosts').innerText = data.totalPosts.toLocaleString();
        document.getElementById('newPosts').innerText = data.newPosts.toLocaleString();

        document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));

        const sortedWeekly = Object.entries(data.weeklyPostStats || {})
            .sort((a, b) => a[0].localeCompare(b[0]));
        barChart.data.labels = sortedWeekly.map(entry => entry[0].substring(5));
        barChart.data.datasets[0].data = sortedWeekly.map(entry => entry[1]);
        barChart.update();

        updateRegionChart('osaka');

        const sortedMonthly = Object.entries(data.monthlyUserStats || {});
        lineChart.data.labels = sortedMonthly.map(entry => entry[0]);
        lineChart.data.datasets[0].data = sortedMonthly.map(entry => entry[1]);
        lineChart.update();
    }

    function generateCustomLegend(chart) {
        const legendContainer = document.getElementById('customLegend');
        legendContainer.innerHTML = '';

        const data = chart.data;
        if (!data.labels.length || !data.datasets.length) return;

        const listUl = document.createElement('ul');
        listUl.className = 'legend-list';

        data.labels.forEach((label, index) => {
            const color = data.datasets[0].backgroundColor[index];
            const value = data.datasets[0].data[index];

            const li = document.createElement('li');
            li.className = 'legend-item';

            const colorBox = document.createElement('span');
            colorBox.className = 'legend-color-box';
            colorBox.style.backgroundColor = color;

            const textSpan = document.createElement('span');
            textSpan.className = 'legend-text';
            textSpan.innerText = label;
            textSpan.title = label;

            const valueSpan = document.createElement('span');
            valueSpan.className = 'legend-value';
            valueSpan.innerText = value.toLocaleString();

            li.appendChild(colorBox);
            li.appendChild(textSpan);
            li.appendChild(valueSpan);
            listUl.appendChild(li);
        });

        legendContainer.appendChild(listUl);
    }

    function toggleRegion(region) {
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        updateRegionChart(region);
    }

    function updateRegionChart(region) {
        let stats = {};
        if (region === 'osaka') {
            stats = dashboardData.osakaWardStats || {};
        } else {
            stats = dashboardData.tokyoWardStats || {};
        }

        if (Object.keys(stats).length === 0) {
            doughnutChart.data.labels = [TEXT.noData];
            doughnutChart.data.datasets[0].data = [1];
            doughnutChart.data.datasets[0].backgroundColor = ['#e9ecef'];
        } else {
            doughnutChart.data.labels = Object.keys(stats);
            doughnutChart.data.datasets[0].data = Object.values(stats);
            doughnutChart.data.datasets[0].backgroundColor = ['#364fc7', '#e599f7', '#339af0', '#ff922b', '#adb5bd', '#63e6be'];
        }
        doughnutChart.update();
        generateCustomLegend(doughnutChart);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        fetchDashboardData();
    });
</script>
</body>
</html>