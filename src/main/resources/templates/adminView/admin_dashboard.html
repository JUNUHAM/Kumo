<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>KUMO Admin Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" th:href="@{/css/adminView/admin_dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/adminView/admin_sidebar.css}">
</head>
<body>

<aside th:replace="~{adminView/admin_sidebar :: admin_sidebar('dashboard', ${lang})}"></aside>

<main class="main-content">
    <div class="dashboard-container">
        <div class="welcome-banner">
            <h2 class="welcome-text">
                <span th:text="${lang == 'ja' ? '管理ページへようこそ' : '관리자 페이지에 오신것을 환영합니다'}">환영합니다</span>
                <span th:text="${adminName}">User</span>.
            </h2>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? '総会員数' : '전체 회원'}">전체 회원</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="newUsers">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? '新規会員' : '신규 회원'}">신규 회원</div>
            </div>
            <div class="stat-card">
                <div class="stat-value loading" id="totalPosts">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? '総求人数' : '전체 공고수'}">전체 공고수</div>
            </div>
            <div class="stat-card">
                <div class="stat-value loading" id="newPosts">-</div>
                <div class="stat-label" th:text="${lang == 'ja' ? '新規求人' : '신규 공고수'}">신규 공고수</div>
            </div>
        </div>

        <div class="charts-middle-row">
            <div class="chart-box-left">
                <div class="chart-header">
                    <span class="chart-title" th:text="${lang == 'ja' ? '週間求人登録数 (直近7日)' : '주간 공고 등록 수 (최근 7일)'}">주간 공고 등록 수</span>
                </div>
                <canvas id="barChart"></canvas>
            </div>

            <div class="chart-box-right">
                <div class="chart-header">
                    <span class="chart-title" th:text="${lang == 'ja' ? '地域別求人' : '지역별 공고 수'}">지역별 공고 수</span>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="toggleRegion('osaka')" th:text="${lang == 'ja' ? '大阪' : '오사카'}">오사카</button>
                        <button class="toggle-btn" onclick="toggleRegion('tokyo')" th:text="${lang == 'ja' ? '東京' : '도쿄'}">도쿄</button>
                    </div>
                </div>

                <div style="width: 180px; height: 180px; position: relative; margin: 0 auto;">
                    <canvas id="doughnutChart"></canvas>
                </div>

                <div id="customLegend" class="chart-legend-container">
                </div>
            </div>
        </div>

        <div class="chart-box-bottom">
            <div class="chart-header">
                <span class="chart-title" th:text="${lang == 'ja' ? '月別新規会員推移' : '월별 신규 회원 수'}">월별 신규 회원 수</span>
            </div>
            <canvas id="lineChart"></canvas>
        </div>
    </div>
</main>

<script th:inline="javascript">
    const currentLang = [[${lang}]] || 'ko';

    const TEXT = {
        barLabel: currentLang === 'ja' ? '登録数' : '등록 수',
        lineLabel: currentLang === 'ja' ? '会員数' : '회원 수',
        noData: currentLang === 'ja' ? 'データなし' : '데이터 없음'
    };

    let barChart, doughnutChart, lineChart;
    let dashboardData = {};

    function changeLanguage(lang) {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', lang);
        window.location.href = url.toString();
    }

    function initCharts() {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        barChart = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: TEXT.barLabel,
                    data: [],
                    backgroundColor: '#3b5bdb',
                    borderRadius: 15,
                    barThickness: 30
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });

        const ctxDoughnut = document.getElementById('doughnutChart').getContext('2d');
        doughnutChart = new Chart(ctxDoughnut, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                }
            }
        });

        const ctxLine = document.getElementById('lineChart').getContext('2d');
        const gradient = ctxLine.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(51, 154, 240, 0.4)');
        gradient.addColorStop(1, 'rgba(51, 154, 240, 0.0)');

        lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: TEXT.lineLabel,
                    data: [],
                    borderColor: '#339af0',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { borderDash: [5, 5] } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    async function fetchDashboardData() {
        try {
            const response = await fetch('/admin/data');
            if (!response.ok) throw new Error('Network response was not ok');
            dashboardData = await response.json();
            updateUI(dashboardData);
        } catch (error) {
            console.error("데이터 로딩 중 오류 발생:", error);
            document.getElementById('totalPosts').innerText = "0";
            document.getElementById('newPosts').innerText = "0";
        }
    }

    function updateUI(data) {
        document.getElementById('totalUsers').innerText = data.totalUsers.toLocaleString();
        document.getElementById('newUsers').innerText = data.newUsers.toLocaleString();
        document.getElementById('totalPosts').innerText = data.totalPosts.toLocaleString();
        document.getElementById('newPosts').innerText = data.newPosts.toLocaleString();

        document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));

        const sortedWeekly = Object.entries(data.weeklyPostStats || {})
            .sort((a, b) => a[0].localeCompare(b[0]));
        barChart.data.labels = sortedWeekly.map(entry => entry[0].substring(5));
        barChart.data.datasets[0].data = sortedWeekly.map(entry => entry[1]);
        barChart.update();

        updateRegionChart('osaka');

        const sortedMonthly = Object.entries(data.monthlyUserStats || {});
        lineChart.data.labels = sortedMonthly.map(entry => entry[0]);
        lineChart.data.datasets[0].data = sortedMonthly.map(entry => entry[1]);
        lineChart.update();
    }

    function generateCustomLegend(chart) {
        const legendContainer = document.getElementById('customLegend');
        legendContainer.innerHTML = '';

        const data = chart.data;
        if (!data.labels.length || !data.datasets.length) return;

        const listUl = document.createElement('ul');
        listUl.className = 'legend-list';

        data.labels.forEach((label, index) => {
            const color = data.datasets[0].backgroundColor[index];
            const value = data.datasets[0].data[index];

            const li = document.createElement('li');
            li.className = 'legend-item';

            const colorBox = document.createElement('span');
            colorBox.className = 'legend-color-box';
            colorBox.style.backgroundColor = color;

            const textSpan = document.createElement('span');
            textSpan.className = 'legend-text';
            textSpan.innerText = label;
            textSpan.title = label;

            const valueSpan = document.createElement('span');
            valueSpan.className = 'legend-value';
            valueSpan.innerText = value.toLocaleString();

            li.appendChild(colorBox);
            li.appendChild(textSpan);
            li.appendChild(valueSpan);
            listUl.appendChild(li);
        });

        legendContainer.appendChild(listUl);
    }

    function toggleRegion(region) {
        document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        updateRegionChart(region);
    }

    function updateRegionChart(region) {
        let stats = {};
        if (region === 'osaka') {
            stats = dashboardData.osakaWardStats || {};
        } else {
            stats = dashboardData.tokyoWardStats || {};
        }

        if (Object.keys(stats).length === 0) {
            doughnutChart.data.labels = [TEXT.noData];
            doughnutChart.data.datasets[0].data = [1];
            doughnutChart.data.datasets[0].backgroundColor = ['#e9ecef'];
        } else {
            doughnutChart.data.labels = Object.keys(stats);
            doughnutChart.data.datasets[0].data = Object.values(stats);
            doughnutChart.data.datasets[0].backgroundColor = ['#364fc7', '#e599f7', '#339af0', '#ff922b', '#adb5bd', '#63e6be'];
        }
        doughnutChart.update();
        generateCustomLegend(doughnutChart);
    }

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        fetchDashboardData();
    });
</script>
</body>
</html>