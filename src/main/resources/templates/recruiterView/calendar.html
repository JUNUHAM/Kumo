<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>KUMO RECRUITER - ì¼ì • ê´€ë¦¬</title>
    <script th:src="@{/js/recruiter/recruiterHeader.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/recruiterHeader.css}" />
    <link
      rel="stylesheet"
      th:href="@{/css/NonLoginFragments/NonLoginFooter.css}"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/main.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/calendar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/companyInfo.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/dark-theme.css}" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script th:src="@{/js/recruiter/main.js}"></script>
  </head>

  <body>
    <header
      th:replace="~{recruiterView/fragments/recruiterHeader :: headerFragment}"
    ></header>

    <div class="dashboard-wrapper">
      <div
        th:replace="~{recruiterView/fragments/sidebar :: sidebarFragment}"
      ></div>

      <div
        class="main-container"
        style="margin-right: 0; display: flex; flex-direction: column; min-height: 100vh;"
      >
        <main class="content-body" style="flex: 1;">
          <div class="calendar-main-layout">
            <div class="calendar-left-content">
              <div id="calendar"></div>
            </div>

            <aside class="calendar-side-area">
              <div class="schedule-full-panel">
                <div
                  class="panel-header"
                  id="selected-date-title"
                  th:text="#{main.panel.today_schedule}"
                >
                  ì˜¤ëŠ˜ì˜ ì¼ì •
                </div>
                <div id="event-list-container" class="event-scroll-area">
                  <div class="empty-state">
                    <i class="bi bi-calendar-check d-block mb-3 fs-1"></i>
                    <span th:utext="#{main.sidebar.no_schedule_guide}"
                      >ë‚ ì§œë¥¼ í´ë¦­í•˜ì—¬<br />ì¼ì •ì„ í™•ì¸í•˜ì„¸ìš”.</span
                    >
                  </div>
                </div>
              </div>

              <div class="side-action-buttons">
                <button
                  class="btn btn-common-action btn-sky-blue w-100 shadow-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#scheduleModal"
                  onclick="prepareNewSchedule()"
                >
                  ìŠ¤ì¼€ì¤„ ë“±ë¡
                </button>

                <div
                  id="deleteDropZone"
                  class="delete-drop-zone w-100 shadow-sm mt-2"
                >
                  <i class="bi bi-trash3 me-1"></i> ì—¬ê¸°ë¡œ ëŒì–´ì„œ ì‚­ì œ
                </div>
              </div>
            </aside>
          </div>
        </main>
        <footer
          th:replace="~{NonLoginFragments/NonLoginFooter :: footerFragment}"
        ></footer>
      </div>
    </div>

    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content schedule-modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100 text-center fw-bold">ìŠ¤ì¼€ì¤„ ë“±ë¡</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-4">
            <form id="scheduleForm">
              <div class="row mb-4 align-items-center">
                <label class="col-3 modal-label">ì£¼ì œ</label>
                <div class="col-9">
                  <input
                    type="text"
                    id="scheduleTitle"
                    class="kumo-modal-input"
                    placeholder="í™ê¸¸ë™ê³¼ ë©´ì ‘"
                    required
                  />
                </div>
              </div>

              <div class="row mb-4 align-items-center">
                <label class="col-3 modal-label">ë‚ ì§œ</label>
                <div class="col-9 d-flex gap-2 align-items-center">
                  <input
                    type="date"
                    id="scheduleDate"
                    class="kumo-modal-input py-1 px-2"
                    style="width: auto;"
                    required
                  />
                  <input
                    type="time"
                    id="startTime"
                    class="kumo-modal-input py-1 px-2"
                    style="width: auto;"
                    value="09:00"
                  />
                  <span>~</span>
                  <input
                    type="time"
                    id="endTime"
                    class="kumo-modal-input py-1 px-2"
                    style="width: auto;"
                    value="10:00"
                  />
                </div>
              </div>

              <div class="row mb-4">
                <label class="col-3 modal-label mt-2">ìƒì„¸ì •ë³´</label>
                <div class="col-9">
                  <textarea
                    id="scheduleDescription"
                    class="kumo-modal-textarea"
                    rows="4"
                    placeholder="ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."
                  ></textarea>
                </div>
              </div>

              <div class="row mb-5 align-items-center">
                <label class="col-3 modal-label">ìƒ‰ìƒ</label>
                <div class="col-9 d-flex gap-3 color-picker-wrapper">
                  <div
                    class="color-dot active"
                    style="background-color: #ff6b6b;"
                    data-color="#ff6b6b"
                  ></div>
                  <div
                    class="color-dot"
                    style="background-color: #ffbb33;"
                    data-color="#ffbb33"
                  ></div>
                  <div
                    class="color-dot"
                    style="background-color: #ccff33;"
                    data-color="#ccff33"
                  ></div>
                  <div
                    class="color-dot"
                    style="background-color: #33ff66;"
                    data-color="#33ff66"
                  ></div>
                  <div
                    class="color-dot"
                    style="background-color: #7abaff;"
                    data-color="#7abaff"
                  ></div>
                  <div
                    class="color-dot"
                    style="background-color: #555abf;"
                    data-color="#555abf"
                  ></div>
                  <div
                    class="color-dot"
                    style="background-color: #cc66ff;"
                    data-color="#cc66ff"
                  ></div>
                </div>
              </div>

              <div class="d-flex gap-3 justify-content-center w-100">
                <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">
                  ì·¨ì†Œ
                </button>
              
                <button type="button" class="btn btn-danger" id="btnDelete" onclick="deleteSchedule()" style="display: none;">
                  ì‚­ì œ
                </button>
              
                <button type="button" class="btn-modal-submit" onclick="saveSchedule()">
                  ìŠ¤ì¼€ì¤„ ë“±ë¡
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"></script>
    <script th:inline="javascript">
     /* <![CDATA[ */
      let mainCal;
      let editingEventId = null;

      // [UTC ì˜¤ì°¨ í•´ê²°] í•œêµ­ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ YYYY-MM-DD ë¬¸ìì—´ì„ ë§Œë“œëŠ” í•¨ìˆ˜
      function getLocalDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // ğŸŒŸ [ê¹”ë”í•˜ê²Œ ì •ë¦¬ë¨] ì¡°ìš©íˆ ì„œë²„ì— ì €ì¥í•˜ëŠ” í•¨ìˆ˜
      function silentUpdate(info) {
        function formatDateTime(d) {
          if (!d) return null;
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          const h = String(d.getHours()).padStart(2, '0');
          const min = String(d.getMinutes()).padStart(2, '0');
          return `${y}-${m}-${day}T${h}:${min}:00`;
        }

        let startStr = formatDateTime(info.event.start);
        let endStr = info.event.end ? formatDateTime(info.event.end) : startStr;

        const data = {
          id: info.event.id,
          title: info.event.title,
          description: info.event.extendedProps.description || "",
          start: startStr,
          end: endStr,
          color: info.event.backgroundColor || info.event.color || "#7abaff"
        };

        $.ajax({
          url: '/api/calendar/update', // ğŸ‘‰ ë°±ì—”ë“œì— ì´ ì£¼ì†Œê°€ ê¼­ ìˆì–´ì•¼ í•©ë‹ˆë‹¤!
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function () {
            // ì¡°ìš©íˆ ìš°ì¸¡ ë¦¬ìŠ¤íŠ¸ë§Œ ìƒˆë¡œê³ ì¹¨!
            updateAll(getLocalDateString(info.event.start), mainCal);
          },
          error: function (err) {
            console.error(err);
            Swal.fire('ì˜¤ë¥˜', 'ì¼ì • ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
            info.revert(); // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìë¦¬ë¡œ
          }
        });
      }

      // ğŸŒŸ [í•µì‹¬] ìº˜ë¦°ë” ë¡œë“œ ë° ì„¤ì •
      window.addEventListener('load', function () {
        const mainEl = document.getElementById('calendar');
        const dropZone = document.getElementById('deleteDropZone');
        const currentLang = /*[[${#locale.language}]]*/ 'ko';

        if (mainEl && typeof FullCalendar !== "undefined") {
          mainCal = new FullCalendar.Calendar(mainEl, {
            initialView: 'dayGridMonth',
            locale: currentLang,
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
            events: '/api/calendar/events',
            dayMaxEvents: 2,
            moreLinkContent: '...',

            editable: true,

            // ì¡°ìš©íˆ ì´ë™ & ëŠ˜ë¦¬ê¸°
            eventDrop: function (info) { silentUpdate(info); },
            eventResize: function (info) { silentUpdate(info); },

            // ë“œë˜ê·¸ ì‹œì‘ ì‹œ íœ´ì§€í†µ í™œì„±í™”
            eventDragStart: function () {
              if (dropZone) dropZone.classList.add('drag-over');
            },

            // ğŸŒŸ [ì¤‘ë³µ ì œê±°ë¨] ë§ˆìš°ìŠ¤ë¥¼ ë†“ì•˜ì„ ë•Œ íœ´ì§€í†µ í™•ì¸!
            eventDragStop: function (info) {
              if (!dropZone) return;
              const rect = dropZone.getBoundingClientRect();
              const x = info.jsEvent.clientX;
              const y = info.jsEvent.clientY;

              if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                Swal.fire({
                  title: 'ì¼ì • ì‚­ì œ',
                  text: `'${info.event.title}' ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#dc3545',
                  cancelButtonColor: '#6c757d',
                  confirmButtonText: 'ë„¤, ì‚­ì œí• ê²Œìš”!',
                  cancelButtonText: 'ì·¨ì†Œ'
                }).then((result) => {
                  if (result.isConfirmed) {
                    deleteScheduleById(info.event.id);
                  }
                });
              }
              dropZone.classList.remove('drag-over');
            },

            dateClick: function (info) { handleDateSelection(info.dateStr, info.dayEl); },
            eventClick: function (info) {
              openEditModal(info.event);
              info.jsEvent.preventDefault();
            },
            moreLinkClick: function (info) {
              const dateStr = getLocalDateString(info.date);
              handleDateSelection(dateStr, info.el.closest('.fc-daygrid-day'));
              return false;
            }
          });
          mainCal.render();
        }
      });

      // ë‚ ì§œ ì„ íƒ 
      function handleDateSelection(dateStr, dayEl) {
        document.querySelectorAll('.fc-daygrid-day').forEach(el => el.classList.remove('selected-day'));
        if (dayEl) dayEl.classList.add('selected-day');

        const dateInput = document.getElementById('scheduleDate');
        if (dateInput) dateInput.value = dateStr;
        updateAll(dateStr, mainCal);
      }

      // ì‹ ê·œ ë“±ë¡ ëª¨ë‹¬ ì„¸íŒ…
      function prepareNewSchedule() {
        editingEventId = null;
        const selectedDate = $('#scheduleDate').val();
        $('#scheduleForm')[0].reset();
        $('#scheduleDate').val(selectedDate ? selectedDate : getLocalDateString(new Date()));
        $('#btnDelete').hide();
        $('.btn-modal-submit').text('ìŠ¤ì¼€ì¤„ ë“±ë¡');
        $('.modal-title').text('ìŠ¤ì¼€ì¤„ ë“±ë¡');
      }

      // ìˆ˜ì • ëª¨ë‹¬ ì„¸íŒ…
      function openEditModal(event) {
        editingEventId = event.id;
        $('#scheduleTitle').val(event.title);
        $('#scheduleDescription').val(event.extendedProps.description || "");

        const start = event.start;
        const dateStr = getLocalDateString(start);
        const timeStr = String(start.getHours()).padStart(2, '0') + ":" + String(start.getMinutes()).padStart(2, '0');

        $('#scheduleDate').val(dateStr);
        $('#startTime').val(timeStr);

        $('#btnDelete').show();
        $('.btn-modal-submit').text('ìˆ˜ì • ì™„ë£Œ');
        $('.modal-title').text('ìŠ¤ì¼€ì¤„ ìˆ˜ì •');

        const eventColor = event.backgroundColor || event.color || "#7abaff";
        $('.color-dot').removeClass('active');
        $(`.color-dot[data-color="${eventColor}"]`).addClass('active');

        $('#scheduleModal').modal('show');
      }

      // ì €ì¥ ë° ìˆ˜ì • 
      function saveSchedule() {
        const title = $('#scheduleTitle').val();
        const date = $('#scheduleDate').val();
        if (!title || !date) { alert("ì£¼ì œì™€ ë‚ ì§œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”!"); return; }

        const data = {
          id: editingEventId,
          title: title,
          description: $('#scheduleDescription').val(),
          start: date + "T" + ($('#startTime').val() || "09:00") + ":00",
          end: date + "T" + ($('#endTime').val() || "10:00") + ":00",
          color: $('.color-dot.active').data('color') || "#7abaff"
        };

        $.ajax({
          url: editingEventId ? '/api/calendar/update' : '/api/calendar/save',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(data),
          success: function () {
            $('#scheduleModal').modal('hide');
            mainCal.refetchEvents();
            updateAll(date, mainCal);
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', showConfirmButton: false, timer: 1500 });
          },
          error: function () {
            Swal.fire('ì˜¤ë¥˜', 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        });
      }

      // ëª¨ë‹¬ ì•ˆì—ì„œ ì‚­ì œ
      function deleteSchedule() {
        if (!editingEventId) return;
        Swal.fire({
          title: 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
          text: "ì‚­ì œí•œ ì¼ì •ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
          icon: 'error',
          showCancelButton: true,
          confirmButtonColor: '#dc3545',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'ì‚­ì œ',
          cancelButtonText: 'ì·¨ì†Œ'
        }).then((result) => {
          if (result.isConfirmed) {
            deleteScheduleById(editingEventId);
          }
        });
      }

      // ì‹¤ì œ ì„œë²„ ì‚­ì œ
      function deleteScheduleById(id) {
        if (!id) return;
        $.ajax({
          url: '/api/calendar/delete/' + id,
          type: 'DELETE',
          success: function () {
            $('#scheduleModal').modal('hide');
            mainCal.refetchEvents();
            updateAll($('#scheduleDate').val() || getLocalDateString(new Date()), mainCal);
            Swal.fire({ title: 'ì‚­ì œ ì™„ë£Œ!', text: 'ì¼ì •ì´ ê¹”ë”í•˜ê²Œ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.', icon: 'success', confirmButtonColor: '#7abaff' });
          },
          error: function () {
            Swal.fire('ì˜¤ë¥˜', 'ì‚­ì œ ì‹¤íŒ¨! ì„œë²„ ì—ëŸ¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
          }
        });
      }

      // ìš°ì¸¡ ì‚¬ì´ë“œë°” ë Œë”ë§
      window.updateAll = function (date, calApi) {
        const container = document.getElementById('event-list-container');
        const titleEl = document.getElementById('selected-date-title');
        if (titleEl) titleEl.innerText = date + " ì¼ì •";

        let evs = calApi.getEvents().filter(e => getLocalDateString(e.start) === date);
        evs.sort((a, b) => a.start - b.start);
        container.innerHTML = evs.length ? '' : `<div class="empty-state">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;

        evs.forEach(e => {
          const card = document.createElement("div");
          card.className = "sidebar-card";
          card.style.setProperty("border-left-color", e.backgroundColor || e.color || "#7abaff", "important");
          card.style.cursor = "pointer";
          card.onclick = () => openEditModal(e);

          const hours = String(e.start.getHours()).padStart(2, '0');
          const minutes = String(e.start.getMinutes()).padStart(2, '0');
          card.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; width: 100%;">
            <div class="event-item-title" style="margin: 0; font-size: 0.9rem; font-weight: 700;">${e.title}</div>
            <div class="small text-muted"><i class="bi bi-clock me-1"></i>${hours}:${minutes}</div>
        </div>`;
          container.appendChild(card);
        });
      };

      $(document).on('click', '.color-dot', function () {
        $('.color-dot').removeClass('active');
        $(this).addClass('active');
      });
      /* ]]> */
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
