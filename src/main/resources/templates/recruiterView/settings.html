<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>KUMO RECRUITER - 내 계정</title>
    <script th:src="@{/js/recruiter/main.js}"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/recruiterHeader.css}" />
    <link
      rel="stylesheet"
      th:href="@{/css/NonLoginFragments/NonLoginFooter.css}"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/main.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/settings.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/dark-theme.css}" />
  </head>
  <body>
    <header
      th:replace="~{recruiterView/fragments/recruiterHeader :: headerFragment}"
    ></header>

    <div class="dashboard-wrapper">
      <div
        th:replace="~{recruiterView/fragments/sidebar :: sidebarFragment}"
      ></div>

      <div class="main-container" style="margin-right: 0;">
        <main class="content-body">
          <div class="settings-container">
            <h2 class="settings-title" th:text="#{sidebar.menu.settings}">
              내 계정
            </h2>

            <div class="settings-form-wrapper">
              <div class="profile-section mb-5">
                <label class="info-label" th:text="#{set.label.profile}"
                  >프로필 사진</label
                >
                <div class="profile-image-box">
                  <div class="profile-img-container" id="profileContainer">
                    <img
                      th:src="${user.profileImage}"
                      alt="Profile"
                      class="profile-img-lg"
                      id="profilePreview"
                      th:if="${user.profileImage != null}"
                    />
                    <i
                      class="bi bi-person-circle"
                      id="defaultIcon"
                      th:unless="${user.profileImage != null}"
                    ></i>
                  </div>

                  <input
                    type="file"
                    id="profileInput"
                    accept="image/*"
                    style="display: none;"
                  />

                  <button
                    type="button"
                    class="btn-profile-upload"
                    id="uploadBtn"
                    th:text="#{set.btn.upload}"
                  >
                    프로필 사진 업로드
                  </button>
                </div>
              </div>

              <div class="info-group">
                <div class="info-row">
                  <span class="info-label" th:text="#{set.label.name}"
                    >이름</span
                  >
                  <span class="info-value" th:text="${fullName}"
                    >이름 데이터</span
                  >
                </div>

                <div class="info-row">
                  <span class="info-label" th:text="#{join.label.birth}"
                    >생년월일</span
                  >
                  <span class="info-value">
                    <span
                      th:text="${#temporals.format(user.birthDate, 'yyyy / MM / dd')}"
                      >1990 / 01 / 01</span
                    >
                    <span
                      class="text-muted ms-2"
                      th:text="#{set.label.age_suffix(${age})}"
                      >( 만 40세 )</span
                    >
                  </span>
                </div>

                <div class="info-row">
                  <span class="info-label" th:text="#{join.label.nickname}"
                    >닉네임</span
                  >
                  <span class="info-value" th:text="${user.nickname}"
                    >닉네임 데이터</span
                  >
                </div>

                <div class="info-row">
                  <span class="info-label" th:text="#{join.label.email}"
                    >이메일</span
                  >
                  <span class="info-value" th:text="${user.email}"
                    >user@kumo.io</span
                  >
                </div>

                <div class="info-row">
                  <span class="info-label" th:text="#{join.label.address}"
                    >주소</span
                  >
                  <span
                    class="info-value"
                    th:text="${user.addressMain + ' ' + user.addressDetail}"
                  >
                    주소 데이터
                  </span>
                </div>
              </div>

              <div class="info-group mt-4">
                <div class="info-row align-items-center">
                  <span class="info-label">LINE 연동</span>
                  <div class="form-check form-switch custom-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      th:checked="${user.socialProvider == 'LINE'}"
                    />
                  </div>
                </div>
                <div class="info-row align-items-center">
                  <span class="info-label">Google 연동</span>
                  <div class="form-check form-switch custom-switch">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      th:checked="${user.socialProvider == 'GOOGLE'}"
                    />
                  </div>
                </div>
              </div>

              <div class="settings-footer-actions">
                <button
                  type="button"
                  class="btn-quit"
                  th:text="#{set.btn.quit}"
                >
                  회원 탈퇴
                </button>
                <button
                  type="button"
                  class="btn-submit"
                  th:text="#{set.btn.edit}"
                >
                  회원정보 수정
                </button>
              </div>
            </div>
            <footer
              th:replace="~{NonLoginFragments/NonLoginFooter :: footerFragment}"
            ></footer>
          </div>
        </main>
      </div>
    </div>

    <script>
            document.addEventListener('DOMContentLoaded', function() {
          const uploadBtn = document.getElementById('uploadBtn');
          const profileInput = document.getElementById('profileInput');
          const profilePreview = document.getElementById('profilePreview');

          // 1. 버튼 클릭 시 숨겨진 input 클릭
          uploadBtn.onclick = () => profileInput.click();

          // 2. 파일이 선택되면 서버로 즉시 전송
          profileInput.onchange = function() {
              const file = profileInput.files[0];
              if (!file) return;

              const formData = new FormData();
              formData.append("profileImage", file);

              fetch("/Recruiter/UploadProfile", {
                  method: "POST",
                  body: formData
                  // Spring Security를 쓰고 계시다면 CSRF 토큰을 헤더에 넣어야 할 수도 있습니다.
              })
              .then(response => response.json())
              .then(data => {
                  if (data.success) {
                      // 성공 시 이미지 즉시 교체
                      location.reload(); // 가장 확실한 방법
                  } else {
                      alert("업로드 실패: " + data.message);
                  }
              })
              .catch(error => console.error("Error:", error));
          };
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
