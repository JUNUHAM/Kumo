<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>KUMO RECRUITER - 내 계정</title>
    <script th:src="@{/js/recruiter/main.js}"></script>
    <script th:src="@{/js/recruiter/recruiterHeader.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/recruiterHeader.css}" />
    <link
      rel="stylesheet"
      th:href="@{/css/NonLoginFragments/NonLoginFooter.css}"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/main.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/settings.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/dark-theme.css}" />
  </head>
  <body>
    <header
      th:replace="~{recruiterView/fragments/recruiterHeader :: headerFragment}"
    ></header>
    <!-- 프로필 업로드 모달 -->
    <div id="profileModal" class="profile-modal-overlay">
      <div class="profile-modal-window">
    
        <div class="profile-modal-header">
          <h3 th:text="#{modal.title}">프로필 사진 업로드</h3>
          <span class="close-btn">&times;</span>
        </div>
    
        <div class="profile-modal-body">
          <div class="preview-wrapper">
            <img th:src="${user.profileImage ?: '/images/common/default_profile.png'}" id="profilePreview" alt="Profile">
          </div>
    
          <p class="guide-text" th:text="#{modal.guide}">JPG, PNG, GIF 파일만 업로드 가능합니다.</p>
    
          <div class="file-selection-area">
            <input type="file" id="fileInput" accept="image/*" style="display:none;">
            <label for="fileInput" class="custom-file-btn" id="uploadBtn">
              <i class="fa-solid fa-cloud-arrow-up"></i>
              <span th:text="#{modal.file.select}">사진 선택</span>
            </label>
            <p id="fileName" class="file-name" th:text="#{modal.file.none}">선택된 파일 없음</p>
          </div>
        </div>
    
        <div class="profile-modal-footer">
          <button class="btn-cancel" id="cancelProfileBtn" th:text="#{btn.cancel}">취소</button>
          <button class="btn-save" id="saveProfileBtn" th:text="#{btn.save}">저장하기</button>
        </div>
      </div>
    </div>

    <div class="dashboard-wrapper">
      <div
        th:replace="~{recruiterView/fragments/sidebar :: sidebarFragment}"
      ></div>

      <div class="main-container" style="margin-right: 0;">
        <main class="content-body">
          <div class="settings-container">
            <div class="content-header">
              <h2 class="settings-title" th:text="#{sidebar.menu.settings}">내 계정</h2>
            </div>
        
            <div class="profile-section">
              <div class="profile-photo-area">
              
                <div class="img-wrapper">
                  <img th:src="${user.profileImage ?: '/images/common/default_profile.png'}" class="profile-img-lg">
                </div>
              
                <button type="button" class="btn-upload-photo" id="openProfileModalBtn">
                  프로필 사진 업로드
                </button>
              
              </div>

        
              <div class="info-list">
                <div class="info-row">
                  <span class="label" th:text="#{set.label.name}">이름</span>
                  <span class="value" th:text="${fullName}">이름 데이터</span>
                </div>
        
                <div class="info-row">
                  <span class="label" th:text="#{join.label.birth}">생년월일</span>
                  <span class="value">
                    <span th:text="${#temporals.format(user.birthDate, 'yyyy / MM / dd')}">1990 / 01 / 01</span>
                    <span class="age-suffix" th:text="#{set.label.age_suffix(${age})}">( 만 40세 )</span>
                  </span>
                </div>
        
                <div class="info-row">
                  <span class="label" th:text="#{join.label.nickname}">닉네임</span>
                  <span class="value" th:text="${user.nickname}">닉네임 데이터</span>
                </div>
        
                <div class="info-row">
                  <span class="label" th:text="#{join.label.email}">이메일</span>
                  <span class="value" th:text="${user.email}">user@kumo.io</span>
                </div>
        
                <div class="info-row">
                  <span class="label" th:text="#{join.label.address}">주소</span>
                  <span class="value" th:text="${user.addressMain + ' ' + user.addressDetail}">주소 데이터</span>
                </div>
        
                <div class="info-row align-items-center">
                  <span class="label" th:text="#{label.line}">LINE 연동></span>
                  <label class="switch">
                    <input type="checkbox" class="sns-toggle" th:checked="${user.socialProvider == 'LINE'}">
                    <span class="slider round"></span>
                  </label>
                </div>
                
                <div class="info-row align-items-center">
                  <span class="label" th:text="#{label.google}">Google 연동</span>
                  <label class="switch">
                    <input type="checkbox" class="sns-toggle" th:checked="${user.socialProvider == 'GOOGLE'}">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
        
              <div class="action-buttons">
                <button type="button" class="btn-quit" th:text="#{set.btn.quit}">회원 탈퇴</button>
                <a th:href="@{/Recruiter/ProfileEdit}" class="btn-edit" th:text="#{set.btn.edit}">회원정보 수정</a>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {

          /* =========================
             프로필 업로드 기능
          ========================= */

          const uploadBtn = document.getElementById('uploadBtn');
          const profileInput = document.getElementById('fileInput');
          const profilePreview = document.getElementById('profilePreview');
          const fileNameSpan = document.getElementById('fileName');
          const saveBtn = document.getElementById('saveProfileBtn');

          let selectedFile = null;

          if (profileInput) {
            profileInput.onchange = function () {

              const file = profileInput.files[0];
              if (!file) return;

              selectedFile = file;

              fileNameSpan.innerText = file.name;

              const reader = new FileReader();
              reader.onload = function (e) {
                profilePreview.src = e.target.result;
              };
              reader.readAsDataURL(file);
            };
          }

          if (saveBtn) {
            saveBtn.onclick = function () {

              if (!selectedFile) {
                Swal.fire({
                  icon: 'warning',
                  title: '사진을 선택해주세요.'
                });
                return;
              }

              const formData = new FormData();
              formData.append("profileImage", selectedFile);

              fetch("/Recruiter/UploadProfile", {
                method: "POST",
                body: formData
              })
                .then(res => res.json())
                .then(data => {

                  if (data.success) {
                    Swal.fire({
                      icon: 'success',
                      title: '프로필 사진이 업로드 되었습니다.'
                    }).then(() => location.reload());
                  } else {
                    Swal.fire({
                      icon: 'error',
                      title: '업로드 실패',
                      text: data.message
                    });
                  }

                })
                .catch(() => {
                  Swal.fire({
                    icon: 'error',
                    title: '서버 오류'
                  });
                });
            };
          }


          /* =========================
             SNS 토글
          ========================= */

          const snsToggles = document.querySelectorAll('.sns-toggle');

          snsToggles.forEach(toggle => {
            toggle.onclick = function (e) {

              e.preventDefault();

              const isDark = document.documentElement.classList.contains('dark-mode');

              Swal.fire({
                title: 'Service Notice',
                text: '아직 서비스 준비 중입니다.',
                icon: 'info',
                confirmButtonColor: '#7abaff',
                background: isDark ? '#2b2b2b' : '#fff',
                color: isDark ? '#fff' : '#333'
              });
            };
          });


          /* =========================
             모달 열기 / 닫기 (여기로 이동)
          ========================= */
          const modal = document.getElementById("profileModal");
          const openBtn = document.getElementById("openProfileModalBtn");

          // 🌟 [핵심] 부드럽게 닫기 함수
          function closeModal() {
            modal.classList.add('closing'); // 닫기 애니메이션 시작

            // 애니메이션 시간(0.25초)이 지난 후 실제로 숨김 처리
            setTimeout(() => {
              modal.style.display = "none";
              modal.classList.remove('closing'); // 다음번을 위해 클래스 제거
            }, 250);
          }

          // 🌟 모든 닫기 버튼에 함수 연결
          if (openBtn) {
            openBtn.onclick = () => {
              modal.style.display = "flex";
            };
          }

          // X 버튼, 취소 버튼, 바깥 클릭 모두 closeModal() 호출
          const closeBtn = document.querySelector(".close-btn");
          const cancelBtn = document.getElementById("cancelProfileBtn");

          if (closeBtn) closeBtn.onclick = closeModal;
          if (cancelBtn) cancelBtn.onclick = closeModal;

          window.onclick = (e) => {
            if (e.target === modal) closeModal();
          };

        });

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
