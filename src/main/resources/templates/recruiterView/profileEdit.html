<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title th:text="#{profile.edit.title}">KUMO - 회원정보 수정</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/recruiterHeader.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/main.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/profileEdit.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/dark-theme.css}" />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <header
      th:replace="~{recruiterView/fragments/recruiterHeader :: headerFragment}"
    ></header>

    <div class="dashboard-wrapper">
      <div
        th:replace="~{recruiterView/fragments/sidebar :: sidebarFragment}"
      ></div>

      <main class="main-container profile-edit-full-bg">
        <div class="profile-edit-centered-wrapper">
          <div class="edit-box">
            <h1 class="edit-title" th:text="#{profile.edit.title}">
              회원정보 수정
            </h1>

            <form
              id="editForm"
              th:action="@{/Recruiter/ProfileEdit}"
              method="post"
            >
              <div class="form-row">
                <div class="form-col-vertical">
                  <label class="input-label" th:text="#{profile.label.sei}"
                    >성</label
                  >
                  <input
                    type="text"
                    th:value="${user?.nameKanjiSei}"
                    class="custom-input gray-input"
                    readonly
                  />
                </div>
                <div class="form-col-vertical">
                  <label class="input-label" th:text="#{profile.label.mei}"
                    >이름</label
                  >
                  <input
                    type="text"
                    th:value="${user?.nameKanjiMei}"
                    class="custom-input gray-input"
                    readonly
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-col-vertical">
                  <label class="input-label" th:text="#{profile.label.sei_kana}"
                    >세이</label
                  >
                  <input
                    type="text"
                    th:value="${user?.nameKanaSei}"
                    class="custom-input gray-input"
                    readonly
                  />
                </div>
                <div class="form-col-vertical">
                  <label class="input-label" th:text="#{profile.label.mei_kana}"
                    >메이</label
                  >
                  <input
                    type="text"
                    th:value="${user?.nameKanaMei}"
                    class="custom-input gray-input"
                    readonly
                  />
                </div>
              </div>

              <div class="input-group-vertical">
                <label class="input-label" th:text="#{profile.label.email}"
                  >이메일</label
                >
                <input
                  type="email"
                  id="email"
                  name="email"
                  th:value="${user?.email}"
                  class="custom-input gray-input"
                  readonly
                />
              </div>

              <div class="form-row">
                <div class="form-col-vertical" style="flex: 2;">
                  <label class="input-label" th:text="#{profile.label.birth}"
                    >생년월일</label
                  >
                  <div class="birth-row">
                    <input
                      type="text"
                      th:value="${birthYear}"
                      class="custom-input gray-input text-center"
                      readonly
                    />
                    <input
                      type="text"
                      th:value="${birthMonth}"
                      class="custom-input gray-input text-center"
                      readonly
                    />
                    <input
                      type="text"
                      th:value="${birthDay}"
                      class="custom-input gray-input text-center"
                      readonly
                    />
                  </div>
                </div>
                <div class="form-col-vertical" style="flex: 1;">
                  <label class="input-label" th:text="#{profile.label.gender}"
                    >성별</label
                  >
                  <input
                    type="text"
                    th:value="${user?.gender != null ? (user.gender.name() == 'MALE' ? #messages.msg('profile.gender.male') : #messages.msg('profile.gender.female')) : ''}"
                    class="custom-input gray-input text-center"
                    readonly
                  />
                </div>
              </div>

              <hr class="edit-divider" />

              <div class="input-group-vertical">
                <label class="input-label" th:text="#{profile.label.nickname}"
                  >닉네임</label
                >
                <input type="hidden" id="nicknameChecked" value="true" />
                <div class="action-row">
                  <input
                    type="text"
                    name="nickname"
                    id="nickname"
                    th:value="${user?.nickname}"
                    class="custom-input"
                  />
                  <button
                    type="button"
                    class="btn-sub-action"
                    onclick="checkNickname()"
                    th:text="#{profile.btn.check_dup}"
                  >
                    중복확인
                  </button>
                </div>
                <div id="error_nickname" class="error-msg"></div>
              </div>

              <div class="input-group-vertical">
                <label class="input-label" th:text="#{profile.label.address}"
                  >주소</label
                >
                <div class="action-row mb-2">
                  <input
                    type="text"
                    name="zipCode"
                    id="zipcode"
                    th:value="${user?.zipCode}"
                    class="custom-input"
                    maxlength="7"
                  />
                  <button
                    type="button"
                    class="btn-sub-action"
                    onclick="searchAddress()"
                    th:text="#{profile.btn.find_addr}"
                  >
                    주소검색
                  </button>
                </div>
                <input
                  type="text"
                  name="addressMain"
                  id="address_main"
                  th:value="${user?.addressMain}"
                  class="custom-input mb-2"
                />
                <input
                  type="text"
                  name="addressDetail"
                  id="address_detail"
                  th:value="${user?.addressDetail}"
                  class="custom-input"
                  th:placeholder="#{profile.placeholder.address_detail}"
                />
              </div>

              <button
                type="submit"
                class="btn-submit-edit"
                th:text="#{profile.btn.update}"
              >
                수정 완료
              </button>
              <p class="edit-footer-notice" th:text="#{profile.edit.notice}">
                사업자 정보 수정이 필요할 시 공식 채널에 연락 부탁드립니다.
              </p>
              <!-- 주소 바탕으로 자동생성-->
              <input
                type="hidden"
                name="addrPrefecture"
                id="addr_prefecture"
                th:value="${user?.addrPrefecture}"
              />
              <input
                type="hidden"
                name="addrCity"
                id="addr_city"
                th:value="${user?.addrCity}"
              />
              <input
                type="hidden"
                name="addrTown"
                id="addr_town"
                th:value="${user?.addrTown}"
              />
              <input
                type="hidden"
                name="latitude"
                id="latitude"
                th:value="${user?.latitude}"
              />
              <input
                type="hidden"
                name="longitude"
                id="longitude"
                th:value="${user?.longitude}"
              />
            </form>
          </div>
        </div>
      </main>
    </div>

    <div
      th:replace="~{NonLoginFragments/NonLoginFooter :: footerFragment}"
    ></div>

    <script
      th:src="@{'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsKey} + '&language=ja'}"
    ></script>

    <script th:inline="javascript">
      /*<![CDATA[*/
      const msgs = {
          nickname_empty: /*[[#{profile.error.nickname.empty}]]*/ "닉네임을 입력해주세요.",
          nickname_duplicate: /*[[#{profile.error.nickname.duplicate}]]*/ "이미 사용중인 닉네임입니다.",
          nickname_ok: /*[[#{profile.success.nickname.ok}]]*/ "사용 가능한 닉네임입니다.",
          check_dup: /*[[#{profile.error.check_dup}]]*/ "닉네임 중복확인을 완료해주세요.",
          zipcode_empty: "우편번호 7자리를 입력해주세요.",
          search_fail: "주소 검색에 실패했습니다."
      };
      /*]]>*/

      document.addEventListener('DOMContentLoaded', () => {
          // 1. 닉네임 변경 감지 (중복확인 초기화)
          const nicknameInput = document.getElementById('nickname');
          if(nicknameInput) {
              nicknameInput.addEventListener('input', () => {
                  document.getElementById('nicknameChecked').value = "false";
                  const errorEl = document.getElementById('error_nickname');
                  errorEl.style.display = 'none';
                  errorEl.innerText = '';
              });
          }

          // 2. [추가] 상세주소(address_detail) 입력 후 포커스를 잃을 때 좌표 갱신!
          const addrDetailInput = document.getElementById('address_detail');
          if(addrDetailInput) {
              addrDetailInput.addEventListener('blur', function() {
                  const mainAddr = document.getElementById('address_main').value;
                  const detailAddr = this.value;
                  // 메인주소 + 상세주소를 합쳐서 구글맵에 던져 좌표를 더 정확하게 잡음
                  if(mainAddr) getGeocode(mainAddr + " " + detailAddr);
              });
          }
      });

      // (중복확인 로직은 기존과 완전 동일하여 생략 없이 유지!)
      function checkNickname() {
          const nicknameInput = document.getElementById('nickname');
          const nickname = nicknameInput.value.trim();
          const errorEl = document.getElementById('error_nickname');

          if (!nickname) {
              errorEl.innerText = msgs.nickname_empty;
              errorEl.style.color = '#EA4335';
              errorEl.style.display = 'block';
              return;
          }

          fetch('/api/check/nickname', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ nickname: nickname })
          })
          .then(response => {
              if (!response.ok) throw new Error('Network error');
              return response.json();
          })
          .then(isDuplicate => {
              if (isDuplicate) {
                  errorEl.innerText = msgs.nickname_duplicate;
                  errorEl.style.color = '#EA4335';
                  errorEl.style.display = 'block';
                  document.getElementById('nicknameChecked').value = "false";
                  nicknameInput.focus();
              } else {
                  errorEl.innerText = msgs.nickname_ok;
                  errorEl.style.color = "#4285F4";
                  errorEl.style.display = 'block';
                  document.getElementById('nicknameChecked').value = "true";
              }
          })
          .catch(error => {
              console.error('Error:', error);
          });
      }

      // [수정됨] 일본 우편번호 주소 검색 (zipcloud)
      function searchAddress() {
          const zipcode = document.getElementById('zipcode').value.trim();

          if (!zipcode || zipcode.length < 7) {
              alert(msgs.zipcode_empty);
              document.getElementById('zipcode').focus();
              return;
          }

          fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zipcode}`)
              .then(response => response.json())
              .then(data => {
                  if (data.status === 200 && data.results) {
                      const result = data.results[0];
                      const fullAddress = result.address1 + result.address2 + result.address3;

                      // 4번: 기본 화면에 주소 표시
                      document.getElementById('address_main').value = fullAddress;

                      // 5번: 히든 필드에 도/현, 시/구, 동/읍 꽂아주기
                      document.getElementById('addr_prefecture').value = result.address1;
                      document.getElementById('addr_city').value = result.address2;
                      document.getElementById('addr_town').value = result.address3;

                      // 6번: 구글맵 위도/경도 추출 시작!
                      getGeocode(fullAddress);

                      document.getElementById('address_detail').focus();
                  } else {
                      alert(msgs.search_fail);
                  }
              })
              .catch(() => {
                  alert(msgs.search_fail);
              });
      }

      // [추가] 사장님의 회원가입 킬러 로직! 구글맵 좌표 및 세부 주소 추출기
      function getGeocode(address) {
          // 구글맵 API가 로드되었는지 확인
          if(!window.google || !window.google.maps) {
              console.warn("구글 맵 API가 로드되지 않았습니다.");
              return;
          }

          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ 'address': address }, function(results, status) {
              if (status === 'OK') {
                  const loc = results[0].geometry.location;
                  // 6번: 위도 경도 히든 필드에 주입!
                  document.getElementById('latitude').value = loc.lat();
                  document.getElementById('longitude').value = loc.lng();

                  // 상세 주소 입력 시 영문명 등으로 구글 주소가 덮어씌워지는 걸 방지하려면
                  // 이 부분의 prefecture, city 파싱은 생략하셔도 무방합니다. (zipcloud가 이미 한자/가나로 잘 넣어주기 때문)
                  console.log("좌표 추출 완료:", loc.lat(), loc.lng());
              } else {
                  console.error('지오코딩 실패: ' + status);
              }
          });
      }

      // 폼 제출 검사
      document.getElementById('editForm').addEventListener('submit', function(e) {
          const isChecked = document.getElementById('nicknameChecked').value;
          if (isChecked !== "true") {
              e.preventDefault();
              const errorEl = document.getElementById('error_nickname');
              errorEl.innerText = msgs.check_dup;
              errorEl.style.color = '#EA4335';
              errorEl.style.display = 'block';
              document.getElementById('nickname').focus();
          }
      });
    </script>
  </body>
</html>
