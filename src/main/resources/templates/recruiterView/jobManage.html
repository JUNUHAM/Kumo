<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>KUMO RECRUITER - Í≥µÍ≥† Í¥ÄÎ¶¨</title>
        <script th:src="@{/js/recruiter/main.js}"></script>
        <script th:src="@{/js/recruiter/recruiterHeader.js}"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/recruiter/recruiterHeader.css}"
    />
    <link
      rel="stylesheet"
      th:href="@{/css/NonLoginFragments/NonLoginFooter.css}"
    />
    <link rel="stylesheet" th:href="@{/css/recruiter/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/rightSidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/main.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/jobManage.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/calendar.css}" />
    <link rel="stylesheet" th:href="@{/css/recruiter/dark-theme.css}" />
  </head>
  <body>
    <header
      th:replace="~{recruiterView/fragments/recruiterHeader :: headerFragment}"
    ></header>

    <div class="dashboard-wrapper">
      <div
        th:replace="~{recruiterView/fragments/sidebar :: sidebarFragment}"
      ></div>

      <div class="main-container">
        <main class="content-body">
          <div class="job-manage-card">
          <div class="card-header-flex">
            <div class="header-left">
              <h2 class="table-title" th:text="#{job.manage.title}">Í≥µÍ≥† Í¥ÄÎ¶¨</h2>
          
              <div class="total-count-wrapper">
                <span class="count-label">Ï†ÑÏ≤¥ Í≥µÍ≥† Ïàò</span>
                <span class="count-badge" th:text="${#lists.size(jobList)}">0</span>
              </div>
            </div>
          </div>

            <table class="kumo-table">
              <thead>
                <tr>
                  <th th:utext="#{job.manage.table.title}">Í≥µÍ≥† Ï†úÎ™© <i class="bi bi-arrow-down-up sort-icon"></i></th>
                  <th>ÏßÄÏó≠</th>
                  <th th:utext="#{job.manage.table.wage}">Í∏âÎ£å <i class="bi bi-arrow-down-up sort-icon"></i></th>
                  <th th:utext="#{job.manage.table.reg_date}">Îì±Î°ù ÎÇ†Ïßú <i class="bi bi-arrow-down-up sort-icon"></i></th>
                  <th th:text="#{job.manage.table.status}">ÏÉÅÌÉú</th>
                  <th>Í¥ÄÎ¶¨</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="job : ${jobList}" th:classappend="${job.status == 'CLOSED'} ? 'job-closed-row' : ''">
                  <td>
                    <div class="job-title-cell">
                      <span class="job-name text-truncate-custom" th:text="${job.title}">Í≥µÍ≥† Ï†úÎ™©</span>
                    </div>
                  </td>
                  <td><span class="badge bg-light text-dark border" th:text="${job.regionType}">ÏßÄÏó≠</span></td>
                  <td><span class="salary-text" th:text="${job.wage}">Í∏âÏó¨</span></td>
                  <td><span class="date-text" th:text="${#temporals.format(job.createdAt, 'yyyy-MM-dd')}">Îì±Î°ùÏùº</span></td>
                  <td>
                    <span class="status-badge status-ing" th:if="${job.status == 'RECRUITING'}"
                      th:text="#{job.manage.status.ing}">Î™®ÏßëÏ§ë</span>
                    <span class="status-badge status-end" th:if="${job.status == 'CLOSED'}"
                      th:text="#{job.manage.status.end}">ÎßàÍ∞êÎê®</span>
                  </td>
                  <td>
                    <button th:if="${job.status == 'RECRUITING'}" type="button" class="btn-gear"
                      th:onclick="openJobModal([[${job.id}]], [[${job.datanum}]], [[${job.regionType}]], [[${job.title}]], [[${job.status}]])">
                      <i class="bi bi-gear-fill"></i>
                    </button>
              
                    <button th:if="${job.status == 'CLOSED'}" type="button" class="btn-close-delete"
                      th:onclick="deletePosting([[${job.datanum}]], [[${job.regionType == 'ÎèÑÏøÑ' ? 'TOKYO' : 'OSAKA'}]])">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </td>
                </tr>
              
                <tr th:if="${#lists.isEmpty(jobList)}">
                  <td colspan="6" class="text-center py-5 text-muted">Îì±Î°ùÎêú Í≥µÍ≥†Í∞Ä ÏóÜÏäµÎãàÎã§.</td>
                </tr>
              </tbody>
            </table>
            </div>
            
            <div class="modal fade" id="jobManageModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content job-modal-content">
                  <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Í≥µÍ≥† Í¥ÄÎ¶¨</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body text-center pt-4 pb-4">
                    <div class="mb-5 mt-2">
                      <span id="modalRegionBadge" class="badge bg-primary mb-3 px-3 py-2"
                        style="font-size: 0.8rem; border-radius: 8px;">ÏßÄÏó≠</span>
                      <h4 id="modalJobTitle" class="text-truncate px-3 fw-bold job-modal-subtitle">Í≥µÍ≥† Ï†úÎ™©Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§.</h4>
                    </div>
            
                    <div class="d-flex justify-content-center gap-2">
                      <button type="button" class="btn-job-view" id="btnViewJob">
                        <i class="bi bi-eye me-1"></i> Î≥¥Í∏∞
                      </button>
                      <button type="button" class="btn-job-edit" id="btnEditJob">
                        <i class="bi bi-pencil-square me-1"></i> ÏàòÏ†ï
                      </button>
                      <button type="button" class="btn-job-delete" id="btnDeleteJob">
                        <i class="bi bi-trash3 me-1"></i> ÏÇ≠Ï†ú
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <footer th:replace="~{NonLoginFragments/NonLoginFooter :: footerFragment}"></footer>
            </main>
      </div>
      <div
        th:replace="~{recruiterView/fragments/rightSidebar :: rightSidebarFragment}"
      ></div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/recruiter/rightSidebar.js}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"></script>
    <script th:src="@{/js/recruiter/global-calendar.js}"></script>
    <script>
      // Î™®Îã¨ Ïó¥Í∏∞ Ìï®Ïàò
        function openJobModal(id, datanum, regionType, title) {
          document.getElementById('modalRegionBadge').innerText = regionType;
          document.getElementById('modalJobTitle').innerText = title;

          // üåü 1. ÌïúÍ∏Ä ÏßÄÏó≠Î™ÖÏùÑ URLÏö© ÏòÅÏñ¥(TOKYO/OSAKA)Î°ú Î≥ÄÌôò
          let sourceEn = '';
          if (regionType === 'ÎèÑÏøÑ') {
            sourceEn = 'TOKYO';
          } else if (regionType === 'Ïò§ÏÇ¨Ïπ¥') {
            sourceEn = 'OSAKA';
          }

          // üåü 2. 'Î≥¥Í∏∞' Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏÇ¨Ïû•ÎãòÏù¥ ÏõêÌïòÏãúÎäî Ï£ºÏÜåÎ°ú Ïù¥Îèô!
          document.getElementById('btnViewJob').onclick = () => {
            location.href = `/map/jobs/detail?id=${id}&source=${sourceEn}&lang=kr`;
          };

          // (ÏàòÏ†ïÍ≥º ÏÇ≠Ï†úÎäî ÏûÑÏãú Ï£ºÏÜå Ïú†ÏßÄ, Ï∂îÌõÑ API ÏôÑÏÑ± Ïãú Î≥ÄÍ≤Ω)
          document.getElementById('btnEditJob').onclick = () => location.href = `/Recruiter/editJobPosting?id=${id}&region=${sourceEn}`;
          document.getElementById('btnDeleteJob').onclick = () => deletePosting(datanum, sourceEn);

          // Î™®Îã¨ ÎùÑÏö∞Í∏∞
          const modal = new bootstrap.Modal(document.getElementById('jobManageModal'));
          modal.show();
        }

        // üåü ÏôÑÏÑ±Îêú ÏÇ≠Ï†ú Ï≤òÎ¶¨ Ìï®Ïàò
          function deletePosting(datanum, sourceEn) {
            Swal.fire({
              title: 'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
              text: "ÏÇ≠Ï†úÎêú Í≥µÍ≥†Îäî Îã§Ïãú Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§!",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#ff4d4f', // Î∂âÏùÄÏÉâ Í≤ΩÍ≥† ÎäêÎÇå
              confirmButtonText: 'ÏÇ≠Ï†úÌïòÍ∏∞',
              cancelButtonText: 'Ï∑®ÏÜå'
            }).then((result) => {
              if (result.isConfirmed) {

                // üåü Î∞±ÏóîÎìú APIÎ°ú DELETE ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞!
                fetch(`/Recruiter/api/recruiter/postings?datanum=${datanum}&region=${sourceEn}`, {
                  method: 'DELETE',
                })
                  .then(response => {
                    if (response.ok) {
                      Swal.fire({
                        title: 'ÏÇ≠Ï†ú ÏôÑÎ£å!',
                        text: 'Í≥µÍ≥†Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.',
                        icon: 'success',
                        confirmButtonColor: '#7abaff'
                      }).then(() => {
                        // üåü Î™®Îã¨ Îã´Í≥† ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨ Í∞±Ïã†Îêú Î¶¨Ïä§Ìä∏ Î≥¥Ïó¨Ï£ºÍ∏∞
                        location.reload();
                      });
                    } else {
                      response.text().then(msg => Swal.fire('Ïò§Î•ò Î∞úÏÉù', msg, 'error'));
                    }
                  })
                  .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('ÌÜµÏã† Ïò§Î•ò', 'ÏÑúÎ≤ÑÏôÄ Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                  });

              }
            });
          }
          document.addEventListener('DOMContentLoaded', () => {
              const table = document.querySelector('.kumo-table');
              const headers = table.querySelectorAll('th');
              const tbody = table.querySelector('tbody');

              headers.forEach((header, index) => {
                // ÏßÄÏó≠(1), ÏÉÅÌÉú(4), Í¥ÄÎ¶¨(5) Ïπ∏ÏùÄ Ï†ïÎ†¨ÏóêÏÑú Ï†úÏô∏
                if (index === 1 || index === 4 || index === 5) return;

                header.addEventListener('click', () => {
                  const rows = Array.from(tbody.querySelectorAll('tr:not(.text-center)'));
                  const isAscending = header.classList.contains('sort-asc');

                  // Î™®Îì† Ìó§Îçî ÏïÑÏù¥ÏΩò Ï¥àÍ∏∞Ìôî
                  headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));

                  rows.sort((rowA, rowB) => {
                    // üåü 0ÏàúÏúÑ: ÏÉÅÌÉú(Status) Ï†ïÎ†¨ (RECRUITING Ïö∞ÏÑ†)
                    const statusA = rowA.querySelector('.status-badge').classList.contains('status-ing') ? 0 : 1;
                    const statusB = rowB.querySelector('.status-badge').classList.contains('status-ing') ? 0 : 1;

                    if (statusA !== statusB) {
                      return statusA - statusB; // Î¨¥Ï°∞Í±¥ 'Î™®ÏßëÏ§ë'Ïù¥ ÏúÑÎ°ú!
                    }

                    // üåü 1ÏàúÏúÑ: ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Ïª¨Îüº Ï†ïÎ†¨ (Í∞ôÏùÄ ÏÉÅÌÉú ÎÇ¥ÏóêÏÑúÎßå ÏûëÎèô)
                    let cellA = rowA.children[index].innerText.trim();
                    let cellB = rowB.children[index].innerText.trim();

                    // [Ïà´Ïûê Ï≤òÎ¶¨] Í∏âÏó¨ (Ïó∞Î¥â 2000Ïóî -> 2000)
                    if (index === 2) {
                      cellA = parseInt(cellA.replace(/[^0-9]/g, '')) || 0;
                      cellB = parseInt(cellB.replace(/[^0-9]/g, '')) || 0;
                    }
                    // [ÎÇ†Ïßú Ï≤òÎ¶¨] Îì±Î°ùÏùº (2026-02-26)
                    else if (index === 3) {
                      cellA = new Date(cellA);
                      cellB = new Date(cellB);
                    }

                    // Ïò§Î¶ÑÏ∞®Ïàú/ÎÇ¥Î¶ºÏ∞®Ïàú ÌÜ†Í∏Ä
                    if (cellA < cellB) return isAscending ? 1 : -1;
                    if (cellA > cellB) return isAscending ? -1 : 1;
                    return 0;
                  });

                  // Í≤∞Í≥º Î∞òÏòÅ Î∞è ÏïÑÏù¥ÏΩò Î∞©Ìñ• ÌëúÏãú
                  header.classList.toggle('sort-asc', !isAscending);
                  header.classList.toggle('sort-desc', isAscending);

                  // Ï†ïÎ†¨Îêú ÌñâÎì§ÏùÑ Îã§Ïãú Ï°∞Î¶Ω
                  rows.forEach(row => tbody.appendChild(row));
                });
              });
            });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </body>
</html>